<html>
<head>
</head>
<body style="background: transparent;">
    <script src="scripts/docstrap.lib.js"></script>
    <script src="scripts/lunr.min.js"></script>
    <script src="scripts/fulltext-search.js"></script>

    <script type="text/x-docstrap-searchdb">
    {"server_models_account.js.html":{"id":"server_models_account.js.html","title":"Source: server/models/account.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/account.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var loopback = require('loopback'); var LoopBackContext = require('loopback-context'); var underscore = require('underscore'); var randomString = require(&quot;randomstring&quot;); var app = serverRequire('server'); var moment = require('moment'); var async = require('async'); var promiseCallback = require('narengi-utils').Common.PromiseCallback; var Common = require('narengi-utils').Common; var Persistency = require('narengi-utils').Persistency; var Pagination = require('narengi-utils').Pagination; var Security = require('narengi-utils').Security; var makeError = Common.Errors.makeError; /** * @class * @constructor */ module.exports = function (Account) { init(Account); defineProperties(Account); addHooks(Account); initMethods(Account); addLoginLogoutMethods(Account); addRegisterMethod(Account); addCrudMethods(Account); addExtraMethods(Account); }; var init = function (Account) { Account.disableRemoteMethod('confirm', true); Account.disableRemoteMethod('login', true); // Deleting unused `validation` &amp; `relations` exactly delete Account.relations.accessTokens; delete Account.validations.email; delete Account.validations.username; //Redefine correct validation Account.validatesUniquenessOf('email', { message: 'error.user.validation.email_existed' }); Account.validatesUniquenessOf('username', { message: 'error.user.validation.username_existed' }); Account.prototype.person = function (cb) { cb = cb || promiseCallback(); if (this.personId) app.models.Person.findById(this.personId, cb); else cb(null, null); return cb.promise; }; }; function defineProperties(Account) { function getDisplayName() { var profile = this.profile() &amp;&amp; this.profile().value(); if (!profile) return '---'; return `${profile.DisplayName}`; } Object.defineProperty(Account.prototype, &quot;DisplayName&quot;, { get: function () { if (this &amp;&amp; this.profile &amp;&amp; this.profile.value()) return `${this.profile.value().title || ''} ${this.profile.value().firstName || ''} ${this.profile.value().lastName || ''}`; return &quot;---&quot;; }, configurable: true, enumerable: true }); Account.setter.email = function (value) { value = value || &quot;&quot;; this.$email = value.trim().toLowerCase(); }; Account.setter.username = function (value) { value = value || &quot;&quot;; this.$username = value.trim().toLowerCase(); }; } var addHooks = function (Account) { Account.observe('before save', function (ctx, next) { if (ctx.options &amp;&amp; ctx.options.skipUpdatedAt) { return next(); } if (ctx.instance) { ctx.instance['updatedAt'] = new Date(); } else { ctx.data['updatedAt'] = new Date(); } next(); }); /** * Ensures each `Account` has a `Person` */ Account.observe('before save', function (ctx, next) { var instance = ctx.instance || ctx.currentInstance; if (instance) { if (!instance.personId) { app.models.Person.create({}, function (err, person) { if (!err) { if (ctx.data) ctx.data[&quot;personId&quot;] = person.id; if (instance) instance.personId = person.id; } next(); }); } else { next(); } } else { //do nothing next(); } }); }; var initMethods = function (Account) { /** * Finds `Account` based on `username` or `email` **/ Account.findByUsernameOrEmail = function (usernameOrEmail, cb) { cb = cb || promiseCallback(); usernameOrEmail = usernameOrEmail || &quot;&quot;; usernameOrEmail = usernameOrEmail.trim().toLowerCase(); Account.findOne({ where: { or: [{ &quot;username&quot;: `${usernameOrEmail}` }, { &quot;email&quot;: `${usernameOrEmail}` }] } }, function (err, account) { if (err) return cb(err); cb(null, account); }); return cb.promise; }; Account.afterRemote(&quot;findByUsernameOrEmail&quot;, Common.RemoteHooks.convert2Dto(Account, {})); Account.remoteMethod( 'findByUsernameOrEmail', { description: 'Returns account by username/email', accepts: [ { arg: 'identity', type: 'string', required: true, http: { source: 'path' } } ], returns: { arg: 'account', type: 'object', root: true }, http: { path: &quot;/by-username/:identity&quot;, verb: 'get' } } ); Account.GetById = function (id, cb) { cb = cb || promiseCallback(); Account.findById(id).then((account) =&gt; { if (!account) return cb(Persistency.Errors.NotFound()); cb(null, account); }).catch((e) =&gt; { cb(e); }); return cb.promise; }; Account.afterRemote(&quot;GetById&quot;, Common.RemoteHooks.convert2Dto(Account, {})); Account.remoteMethod( 'GetById', { description: 'Returns account by id', accepts: [ { arg: 'id', type: 'string', required: true, http: { source: 'path' } } ], returns: { arg: 'account', type: 'object', root: true }, http: { path: &quot;/:id&quot;, verb: 'get' } } ); /** * Determines if account is verfiied or not **/ Account.prototype.isVerified = function () { var last = this.lastVerification(); if (this.verifications.count() === 0 &amp;&amp; last === null) { return false; } if (last) { return last.verified; } return false; }; /** * Returns last `AccountVerification` for `this` `Account` * @method **/ Account.prototype.lastVerification = function () { var len = this.verifications.value().length; if (len &amp;&amp; len &gt; 0) { var nextYear = moment().add(500, 'y'); var list = underscore.sortBy(this.verifications.value(), function (verification) { return nextYear.diff(moment(verification.requestDate)); }); return list[0]; } else { return null; } }; Account.prototype.lastVerificationOfType = function (type) { var list = this.verificationsOfType(type); if (list &amp;&amp; list.length &gt; 0) { return list[0]; } else { return null; } }; Account.prototype.verificationsOfType = function (type) { var list = this.verifications.value(); list = underscore.filter(list, function (item) { return item.verificationType.toLowerCase() === type.toLowerCase(); }); var nextYear = moment().add(500, 'y'); list = underscore.sortBy(list, function (verification) { return nextYear.diff(moment(verification.requestDate)); }); return list; }; /** * Returns `VerificationTypeEnum` * **Note**: This function should be defined as a `getter` method. But in `loopback` there is a mechanism which prevents that. **/ Account.prototype.getVerificationType = function () { if (this.getRegistrationSource().is('web')) { return app.VerificationTypeEnum.get('email'); } else if (this.getRegistrationSource().is('mobile')) { return app.VerificationTypeEnum.get('sms'); } else { return app.VerificationTypeEnum.get('none'); } }; /** * Returns `RegistrationSourceEnum` * **Note**: This function should be defined as a `getter` method. But in `loopback` there is a mechanism which prevents that. **/ Account.prototype.getRegistrationSource = function () { if (this.registrationSource instanceof Enum) { return this.registrationSource; } return app.RegistrationSourceEnum.get(this.registrationSource); }; Account.prototype.usernameOrEmail = function () { if (this.username &amp;&amp; this.username !== &quot;&quot;) { return this.username; } return this.email; }; }; var addLoginLogoutMethods = function (Account) { // Login process /** * @param(Object) credentials username/password * ``` * {&quot;username&quot;: &quot;&lt;username or email&gt;&quot;, &quot;password&quot;: &quot;&lt;password&gt;&quot;} * ``` * @callback {Function} cb **/ Account.CustomLogin = function (credentials, cb) { var defaultError = makeError({ message: 'error.user.login.failed', statusCode: 401, code: 'LOGIN_FAILED' }); var tokenErrorHandler = function (ex) { console.log(ex); var error = makeError({ message: 'error.user.token_not_created', statusCode: 500, code: 'USER_AUTHTOKEN_NOT_CREATED' }); cb(error); }; var passwordNotMatchHandler = function (ex) { var error = makeError({ message: 'error.user.password_not_match', statusCode: 401, code: 'USER_PASSWORD_NOT_MATCH' }); cb(error); }; var tokenInitializedHandler = function (authToken, account) { account.updateAttributes({ lastLoginDate: new Date() }, function (err, updatedAccount) { if (err) { cb(err); } else { cb(null, app.models.AccountDTO.Convert(updatedAccount) ); } }); }; cb = cb || promiseCallback(); credentials.username = credentials.username.trim(); if (!(credentials.username &amp;&amp; credentials.password)) { var error = makeError({ message: 'error.user.required.username_and_password', statusCode: 400, code: 'USERNAME_AND_PASSWORD_REQUIRED' }); cb(error); return cb.promise; } Account.findByUsernameOrEmail(credentials.username, function (err, account) { if (err || !account) { var error = makeError({ message: 'error.user.op.not_found', statusCode: 404, code: 'USER_NOT_FOUND' }); cb(error); return cb.promise; } if (!account.enabled) { var error = makeError({ message: 'error.user.banned', statusCode: 401, code: 'USER_BANNED' }); cb(error); return cb.promise; } account.hasPassword(credentials.password).then(function (isMatch) { if (isMatch) { if (!account.isVerified()) { var error = makeError({ message: 'error.user.not_verified', statusCode: 401, code: 'USER_NOT_VERIFIED' }); cb(error); return cb.promise; } //renew `AuthToken` app.models.AuthToken.createToken().then(function (token) { var params = { token: token, updatedAt: new Date() }; if (account.authToken.value()) { account.authToken.update(params).then(function (authToken) { tokenInitializedHandler(authToken, account); }).catch(tokenErrorHandler); } else { account.authToken.create(params).then(function (authToken) { tokenInitializedHandler(authToken, account); }).catch(tokenErrorHandler); } }).catch(tokenErrorHandler); } else { //password not match passwordNotMatchHandler(); } }).catch(passwordNotMatchHandler); }); return cb.promise; }; Account.remoteMethod( 'CustomLogin', { description: 'Login a user with username/email and password.', accepts: [{ arg: 'credentials', type: 'object', required: true, http: { source: 'body' } }], returns: { arg: 'accessToken', type: 'object', root: true }, http: { path: &quot;/login&quot;, verb: 'post' } } ); // end of Login process // Logout process /** * Logout current user. * Current user is authorized user by data sent in `request` header. * It is silent about non logged in users or undefined users. **/ Account.CustomLogout = function (cb) { cb = cb || promiseCallback(); var ctx = LoopBackContext.getCurrentContext(); var authToken = ctx.get('currentToken'); var currentUser = ctx.get('currentUser'); if (currentUser &amp;&amp; authToken &amp;&amp; authToken.token) { Account.findByUsernameOrEmail(currentUser.username, function (err, acc) { if (err) { cb(err); } else if (acc) { if (acc.authToken.value()) { if (acc.authToken.value().token === authToken.token) { acc.authToken.destroy(cb); } else { cb(null); } } } }); } else { cb(null); } return cb.promise; }; Account.remoteMethod( 'CustomLogout', { description: 'Logout current user', http: { path: &quot;/logout&quot;, verb: 'all' } } ); // end of Logout process } /** * Handles create or update of `Account` * **/ var accountCreateHandler = function (Account, account, password, verificationType, cb) { var verificationCodeLen = app.settings.narengi.verificationCodeLen || 4; var verified = false || verificationType.is('none'); account.verifications.create({ verificationType: verificationType, verified: verified, code: randomString.generate({ length: verificationCodeLen, charset: 'numeric' }) }).then(function (verification) { if (verificationType.is('none')) { var credential = {username: account.usernameOrEmail(), password: password}; return Account.CustomLogin(credential, cb); } cb(null, account); }).catch(function (ex) { var error = makeError({ message: 'error.user.registeration_failed', statusCode: 500, code: 'USER_REGISTRATION_FAILED' }); cb(error); }); }; var passwordValidation = function (force) { return function (ctx, instance, next) { var data = ctx.req.body; var passwordLen = app.settings.narengi.passwordLen || 4; if (!data || (force &amp;&amp; (!data.password || data.password.length &lt; passwordLen))) { var error = makeError({ message: 'error.user.validation.password_length', statusCode: 400, code: 'USER_FORM_INVALID' }); return next(error); } next(); }; }; var addRegisterMethod = function (Account) { Account.beforeRemote(&quot;CustomRegister&quot;, passwordValidation(true)); Account.CustomRegister = function (data, req, cb) { cb = cb || promiseCallback(); var ctx = req.getNarengiContext(); // check for validity of `data` and sanitize it if (!(data &amp;&amp; (data.email || data.username) &amp;&amp; data.password)) { var error = makeError({ message: 'error.user.validation.form_not_valid', statusCode: 400, code: 'USER_FORM_INVALID' }); cb(error); return cb.promise; } else { var form = { email: &quot;&quot;, username: undefined, password: &quot;&quot;, displayName: &quot;&quot;, cellNumber: &quot;&quot; }; data = underscore.pick(data, underscore.keys(form)); data = underscore.defaults(data, form); } var verificationType = app.VerificationTypeEnum.get('none'); //EXP : do not throw error if there is no email/cellnumber /* if (ctx.getReqSource().is('mobile')) { if (data.cellNumber === &quot;&quot;) { var error = new Error('error.user.validation.cellnumber_required'); error.statusCode = 400; error.code = 'USER_FORM_INVALID'; cb(error); return cb.promise; } verificationType = app.VerificationTypeEnum.get('sms'); } else { if (data.email === &quot;&quot;) { var error = new Error('error.user.validation.email_required'); error.statusCode = 400; error.code = 'USER_FORM_INVALID'; cb(error); return cb.promise; } verificationType = app.VerificationTypeEnum.get('email'); }*/ var accountCreateUpdateErrorHandler = function (ex) { cb(ex); }; Account.create(data).then(function (createdAccount) { createdAccount.profile.create(function (e, profile) { accountCreateHandler(Account, createdAccount, data.password, verificationType, cb); }); }).catch(accountCreateUpdateErrorHandler); return cb.promise; }; Account.remoteMethod( 'CustomRegister', { description: 'Registers an account', accepts: [ { arg: 'data', type: 'object', required: true, http: {source: 'body'} }, { arg: 'req', type: 'object', required: true, http: {source: 'req'} } ], returns: { arg: 'account', type: 'object', root: true, }, http: { path: &quot;/register&quot;, verb: 'post', status: 201 } } ); }; var addCrudMethods = function (Account) { // remote hooks function checkInputForCreateUpdate(ctx, instance, next) { var body = ctx.req.body; if (!body.verificationType) { body.verificationType = app.settings.narengi.verificationType; } ctx.req.body = body; next(); }; function accountCreateUpdateErrorHandler(cb) { return function (ex) { cb(ex); }; } /** * Creates an `Account` instance * @param {Object} data * @param {Callback} cb * @return {Promise} * @method */ Account.CustomCreate = function (data, cb) { cb = cb || promiseCallback(); var verificationType = app.VerificationTypeEnum.get(data.verificationType); Account.create(data).then((createdAccount) =&gt; { accountCreateHandler(Account, createdAccount, data.password, verificationType, cb); }).catch(accountCreateUpdateErrorHandler(cb)); return cb.promise; }; Account.beforeRemote(&quot;CustomCreate&quot;, passwordValidation(true)); Account.beforeRemote(&quot;CustomCreate&quot;, checkInputForCreateUpdate); Account.afterRemote(&quot;CustomCreate&quot;, Common.RemoteHooks.convert2Dto(Account, {})); Account.remoteMethod( 'CustomCreate', { description: 'Creates an account', accepts: [{ arg: 'data', type: 'object', required: true, http: { source: 'body' } }], returns: { arg: 'account', type: 'object', root: true, }, http: { path: &quot;/&quot;, verb: 'post', status: 201 } } ); /** * Update an `Account` instance * @param {String} id * @param {Object} data * @param {Callback} cb * @return {Promise} * @method */ Account.CustomUpdate = function (id, data, cb) { cb = cb || promiseCallback(); async.waterfall([ function (callback) { Account.findById(id, callback); }, function (account, callback) { if (!account) return callback(Persistency.Errors.NotFound()); account.updateAttributes(data, callback); } ], function (err, result) { if (err) return cb(err); cb(null, result); }); return cb.promise; }; Account.beforeRemote(&quot;CustomUpdate&quot;, passwordValidation(false)); Account.beforeRemote(&quot;CustomUpdate&quot;, checkInputForCreateUpdate); Account.afterRemote(&quot;CustomUpdate&quot;, Common.RemoteHooks.convert2Dto(Account, {})); Account.remoteMethod( 'CustomUpdate', { description: 'Updates an account', accepts: [ { arg: 'id', type: 'string', required: true, http: {source: 'path'} }, { arg: 'data', type: 'object', required: true, http: {source: 'body'} }], returns: { arg: 'account', type: 'object', root: true }, http: { path: &quot;/:id&quot;, verb: 'put', status: 201 } } ); Account.GetAll = function (paging, cb) { cb = cb || promiseCallback(); Account.find(paging).then(Persistency.CrudHandlers.arraySuccessHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; Account.afterRemote(&quot;GetAll&quot;, Common.RemoteHooks.convert2Dto(Account, {})); /** * Refine pagination arg */ Account.beforeRemote(&quot;GetAll&quot;, Pagination.RemoteHooks.refinePaginationParams); Account.afterRemote(&quot;GetAll&quot;, Pagination.RemoteHooks.afterPaginatedService); Account.remoteMethod( 'GetAll', { description: 'Get all accounts', accepts: [ { arg: 'paging', type: 'object', required: true, http: Pagination.Common.HttpPagingParam } ], returns: { arg: 'accounts', type: 'array', root: true }, http: { path: &quot;/&quot;, verb: 'get', status: 200 } }); Account.DeleteById = function (id, cb) { cb = cb || promiseCallback(); Account.destroyById(id, cb); return cb.promise; }; Account.remoteMethod( 'DeleteById', { description: 'Deletes account by id', accepts: [ { arg: 'id', type: 'string', required: true, http: {source: 'path'} } ], http: { path: &quot;/:id&quot;, verb: 'delete', status: 204 } }); Account.ChangePassByAdmin = function (id, data, cb) { cb = cb || promiseCallback(); async.waterfall([ function (callback) { Account.findById(id, callback); }, function (account, callback) { if (!account) return callback(Persistency.Errors.NotFound()); account.updateAttributes({password: data.password}, callback); } ], function (err, result) { if (err) return cb(err); if (!result) return cb(makeError({message: 'error.operation.failure'})); cb(null); }); return cb.promise; }; Account.beforeRemote(&quot;ChangePassByAdmin&quot;, passwordValidation(false)); Account.remoteMethod( 'ChangePassByAdmin', { description: 'Changes password. It is for admin only', accepts: [ { arg: 'id', type: 'string', required: true, http: {source: 'path'} } ], http: { path: &quot;/:id/change-password-by-admin&quot;, verb: 'put', status: 204 } }); }; var addExtraMethods = function (Account) { var banPerformer = function (data, banning, cb) { cb = cb || promiseCallback(); if (!(data || data.accountId)) { var error = makeError({ message: 'error.user.validation.id_required', statusCode: 400, code: 'USER_FORM_INVALID' }); cb(error); return cb.promise; } Account.updateAll({ id: data.accountId }, { enabled: banning }).then(function (updated, count) { cb(null, count); }).catch(function (err) { cb(err); }); return cb.promise; }; Account.Ban = function (data, cb) { return banPerformer(data, false, cb); }; Account.remoteMethod( 'Ban', { description: 'Ban an account.', accepts: [{ arg: 'data', type: 'object', required: true, http: { source: 'body' } }], http: { path: &quot;/ban&quot;, verb: 'put', status: 204 } } ); Account.Unban = function (data, cb) { return banPerformer(data, true, cb); }; Account.remoteMethod( 'Unban', { description: 'Ban an account.', accepts: [{ arg: 'data', type: 'object', required: true, http: { source: 'body' } }], http: { path: &quot;/unban&quot;, verb: 'put', status: 204 } } ); Account.remoteMethod( 'IsCurrentAdmin', { description: 'Checks if current user is admin or not', returns: { arg: 'result', type: 'boolean', root: true }, http: { path: &quot;/is-current-admin&quot;, verb: 'get', status: 200 } } ); Account.remoteMethod( 'IsAdmin', { description: 'Checks if user is admin or not', accepts: [{ arg: 'userPrincipal', type: 'string', required: true, http: { source: 'path' } }], returns: { arg: 'result', type: 'boolean', root: true }, http: { path: &quot;/:userPrincipal/is-admin&quot;, verb: 'get', status: 200 } } ); Account.ShowProfile = function (id, cb) { cb = cb || promiseCallback(); Account.GetById(id, cb); return cb.promise; }; Account.prototype.getProfileDetailUrl = function () { var rel = `${Account.settings.http.path}/${this.id}/profile`; return Account.formatRelUrl(rel); }; Account.afterRemote(&quot;ShowProfile&quot;, Common.RemoteHooks.convert2Dto(Account, {justProfile: true})); Account.remoteMethod( 'ShowProfile', { description: 'Show account profile', accepts: [{ arg: 'id', type: 'string', required: true, http: { source: 'path' } }], returns: { arg: 'result', type: 'object', root: true }, http: { path: &quot;/:id/profile&quot;, verb: 'get', status: 200 } } ); Account.ShowProfileMe = function (req, cb) { cb = cb || promiseCallback(); var currentUser = req.getNarengiContext().getUser(); if (!currentUser) return cb(Security.Errors.NotAuthorized()); Account.GetById(currentUser.id, cb); return cb.promise; }; Account.afterRemote(&quot;ShowProfileMe&quot;, Common.RemoteHooks.convert2Dto(Account)); Account.remoteMethod( 'ShowProfileMe', { description: 'Show account profile for current user', accepts: [{ arg: 'req', type: 'object', required: true, http: { source: 'req' } }], returns: { arg: 'result', type: 'object', root: true }, http: { path: &quot;/me&quot;, verb: 'get', status: 200 } } ); Account.SendResetPasswordByEmail = function (email, cb) { cb = cb || promiseCallback(); async.waterfall([ function (callback) { Account.findByUsernameOrEmail(email, callback); }, function (account, callback) { if (!account) return callback(Persistency.Errors.NotFound()); var locals = { displayName: account.DisplayName }; app.models.Notification.SendEmailResetPassword(email, account, locals).then((res) =&gt; { callback(null, {result: 'sent'}) }).catch((e) =&gt; { callback(e) }); } ], cb); return cb.promise; }; Account.remoteMethod( 'SendResetPasswordByEmail', { description: 'Send email to account owner to access to reset password', accepts: [{ arg: 'email', type: 'string', required: true, http: { source: 'path' } }], returns: { arg: 'result', type: 'object', root: true }, http: { path: &quot;/reset-password/send/email/:email&quot;, verb: 'post', status: 201 } } ); Account.SendResetPasswordByMobile = function (email, cb) { cb = cb || promiseCallback(); async.waterfall([ function (callback) { Account.findByUsernameOrEmail(email, callback); }, function (account, callback) { if (!account) return callback(Persistency.Errors.NotFound()); var locals = { displayName: account.DisplayName }; app.models.Notification.SendEmailResetPassword(account.cellNumber, account, locals).then((res) =&gt; { callback(null, {result: 'sent'}) }).catch((e) =&gt; { callback(e) }); } ], cb); return cb.promise; }; Account.remoteMethod( 'SendResetPasswordByMobile', { description: 'Send sms to account owner to access to reset password', accepts: [{ arg: 'email', type: 'string', required: true, http: { source: 'path' } }], returns: { arg: 'result', type: 'object', root: true }, http: { path: &quot;/reset-password/send/sms/:email&quot;, verb: 'post', status: 201 } } ); Account.ChangePassword = function (email, data, cb) { cb = cb || promiseCallback(); var passwordLen = app.settings.narengi.passwordLen || 4; if (!data.password || data.password.trim().length &lt; passwordLen) { var error = makeError({ message: 'error.user.validation.password_length', statusCode: 400, code: 'USER_FORM_INVALID' }); cb(error); return cb.promise; } async.waterfall([ function (callback) { Account.findByUsernameOrEmail(email, callback); }, function (account, callback) { if (!account) return callback(Persistency.Errors.NotFound()); account.updateAttributes({ password: data.password }, callback); } ], cb); return cb.promise; }; Account.afterRemote(&quot;ChangePassword&quot;, Common.RemoteHooks.convert2Dto(Account)); Account.remoteMethod( 'ChangePassword', { description: 'Change password of an account specified by email', accepts: [{ arg: 'email', type: 'string', required: true, http: { source: 'path' } }, { arg: 'data', type: 'object', required: true, http: {source: 'body'}, description: 'Field `password` is required' }], returns: { arg: 'result', type: 'object', root: true }, http: { path: &quot;/change-password/:email&quot;, verb: 'put', status: 201 } } ); }; × Search results Close "},"server_models_user-profile.js.html":{"id":"server_models_user-profile.js.html","title":"Source: server/models/user-profile.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/user-profile.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var loopback = require('loopback'); var LoopBackContext = require('loopback-context'); var underscore = require('underscore'); var string = require('string'); var async = require('async'); var promiseCallback = require('narengi-utils').Common.PromiseCallback; var crudHandler = require('narengi-utils').Persistency.CrudHandlers; var Errors = require('narengi-utils').Common.Errors; var commonBeforeRemotes = require('narengi-utils').Common.RemoteHooks; var app = serverRequire('server'); var SecurityErrors = require('narengi-utils').Security.Errors; var PersistencyErrors = require('narengi-utils').Persistency.Errors; var Security = require('narengi-utils').Security; var Common = require('narengi-utils').Common; var Persistency = require('narengi-utils').Persistency; module.exports = function (UserProfile) { /** * `UserProfile` model definition */ defineProperties(UserProfile); addHooks(UserProfile); defineServices(UserProfile); defineAdminStuff(UserProfile); defineProfilePictureMethods(UserProfile); }; /** * Method for creating or updating current user profile; */ function createProfile(userId, data, cb) { cb = cb || promiseCallback(); var promise = app.models.Account.findOne({ where: { id: userId } }); promise.then(createProfileHandler(data, cb)).catch(crudHandler.failureHandler(cb)); return cb.promise; } /** * Creates or updates an `USerProfile` after finding `Account` * This function is for handling callbacks from calling CRUD methods of `loopback' */ function createProfileHandler(data, cb) { return function (account) { cb = cb || promiseCallback(); if (!account) { cb(PersistencyErrors.NotFound()); return; } if (account.profile.value()) { return cb(PersistencyErrors.Errors.Existed()); } account.profile.create(data, function (err, profile) { if (err) { return cb(err); } cb(null, profile); }); return cb.promise; } }; /** * Method for creating or updating current user profile; */ function updateProfile(userId, data, cb) { cb = cb || promiseCallback(); var promise = app.models.Account.findOne({ where: { id: userId } }); promise.then(updateProfileHandler(data, cb)).catch(crudHandler.failureHandler(cb)); return cb.promise; }; /** * Creates or updates an `USerProfile` after finding `Account` * This function is for handling callbacks from calling CRUD methods of `loopback' */ function updateProfileHandler(data, cb) { return function (account) { cb = cb || promiseCallback(); if (!account) { cb(PersistencyErrors.NotFound()); return; } if (!account.profile.value()) { return createProfileHandler(data, cb)(account); } account.profile.update(data, function (err, profile) { if (err) { return cb(err); } cb(null, profile); }); return cb.promise; } } function defineProperties(UserProfile) { Object.defineProperty(UserProfile.prototype, &quot;DisplayName&quot;, { get: function () { return `${this.title || ''} ${this.firstName || ''} ${this.lastName || ''}`; }, configurable: true, enumerable: false }); } /** * Add remote and operation hooks to the model */ var addHooks = function (UserProfile) { UserProfile.beforeRemote('CreateProfile', Security.RemoteHooks.checkCurrentUserAuthorized); UserProfile.beforeRemote('CreateProfile', commonBeforeRemotes.correctCaseOfKeys); UserProfile.beforeRemote('CreateProfile', dataOwnerCorrector); UserProfile.beforeRemote('CreateProfile', Common.RemoteHooks.correctRequestData); UserProfile.beforeRemote('UpdateProfile', Security.RemoteHooks.checkCurrentUserAuthorized); UserProfile.beforeRemote('UpdateProfile', commonBeforeRemotes.correctCaseOfKeys); UserProfile.beforeRemote('UpdateProfile', dataOwnerCorrector); UserProfile.beforeRemote('UpdateProfile', Common.RemoteHooks.correctRequestData); }; /** A `beforeRemote` hook validating input data for persisting in storage This method correct and sanitizes input data. **/ var dataOwnerCorrector = function (ctx, instance, next) { var data = ctx.req.body; if (!data) { next(Errors.DataEmpty()); } var defaultForm = { &quot;title&quot;: &quot;&quot;, &quot;firstName&quot;: &quot;&quot;, &quot;lastName&quot;: &quot;&quot;, &quot;birthDate&quot;: &quot;&quot; }; data = underscore.pick(data, underscore.keys(defaultForm)); if (string(data.birthDate).isEmpty()) delete data.birthDate; ctx.req.body = data; next(); }; var defineServices = function (UserProfile) { /** * Class method for creating an `UserProfile` * Just a proxy for main function. */ UserProfile.CreateProfile = function (data, cb) { var ctx = LoopBackContext.getCurrentContext(); var currentUser = ctx.get('currentUser'); return createProfile(currentUser.id, data, cb); }; UserProfile.remoteMethod( 'CreateProfile', { description: 'Creates an user profile.', accepts: [ { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], http: { path: &quot;/&quot;, verb: 'post', status: 201 } } ); /** * Class method for updating an `UserProfile` * Just a proxy for main function. */ UserProfile.UpdateProfile = function (data, cb) { var ctx = LoopBackContext.getCurrentContext(); var currentUser = ctx.get('currentUser'); return updateProfile(currentUser.id, data, cb); }; UserProfile.remoteMethod( 'UpdateProfile', { description: 'Updates an user profile.', accepts: [ { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], http: { path: &quot;/&quot;, verb: 'put', status: 204 } } ); UserProfile.EnsureProfileExisted = function (user, cb) { cb = cb || promiseCallback(); if (!user) return cb(Persistency.Errors.NotFound()); if (user.profile.value()) return cb(null, user.profile); user.__create__profile(cb); return cb.promise; }; }; function defineProfilePictureMethods(UserProfile) { /** * Main upload method * @param {Account} currentUser * @param {HttpContext} ctx * @param {Callback} cb * @private */ UserProfile._UploadPicture = function (currentUser, ctx, cb) { cb = cb || promiseCallback(); var options = {}; if (currentUser) { async.waterfall([ function (callback) { UserProfile.EnsureProfileExisted(currentUser, callback); }, function (existedProfile, callback) { currentUser.reload(callback); } ], function (err, reloadedUser) { if (err) return cb(err); app.models.UserProfileImageContainer.UploadPicture(reloadedUser, ctx, options).then(function (result) { var picture = result.db; //synced if (underscore.isArray(picture)) picture = picture[0]; reloadedUser.profile.update({picture: picture}).then((profile) =&gt; { var api = {}; api.url = `/user-profiles/${reloadedUser.id}/picture/${result.api[0].hash}`; api.styles = underscore.reduce(result.api[0].styles, function (memo, stylePack) { return underscore.extend(memo, stylePack.style); }, {}); cb(null, api); }).catch(function (err) { cb(err); } ) ; }).catch(function (ex) { return cb(ex); }); }); } else { cb(SecurityErrors.NotAuthorized()); } return cb.promise; }; /** * Module method for uploading profile picture * @param {HttpContext} ctx * @param {Callback} cb * @returns {Promise} */ UserProfile.UploadPicture = function (ctx, cb) { cb = cb || promiseCallback(); var currentUser = LoopBackContext.getCurrentContext().get('currentUser'); UserProfile._UploadPicture(currentUser, ctx, cb); return cb.promise; }; /** * Defines uploading picture service method as a REST API */ UserProfile.remoteMethod(&quot;UploadPicture&quot;, { accepts: [ {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'object', root: true }, http: {verb: 'post', status: 201, path: &quot;/picture&quot;} }); /** * Module method for downloading profile picture * @param {String} hash * @param {String} style * @param {HttpContext} ctx * @param {Callback} cb * @returns {Promise} */ UserProfile.DownloadPicture = function (hash, style, ctx, cb) { cb = cb || promiseCallback(); var currentUser = LoopBackContext.getCurrentContext().get('currentUser'); if (!currentUser) { return cb(SecurityErrors.NotAuthorized()); } try { app.models.UserProfileImageContainer.DownloadPicture(currentUser, hash, style, ctx); } catch (ex) { cb(ex); } return cb.promise; }; /** * Defines uploading picture service method as a REST API */ UserProfile.remoteMethod(&quot;DownloadPicture&quot;, { accepts: [ {arg: 'hash', type: 'string', required: true, http: {source: 'path'}}, { arg: 'style', type: 'string', http: function (ctx) { var req = ctx.req; var query = req.query || {}; var style = query['style'] ? query['style'] : null; return style ? style.trim() : &quot;&quot;; } }, {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'object', root: true }, http: {verb: 'get', path: &quot;/picture/:hash&quot;} }); /** * Upload profile picture by another user called `admin` * @param {String} id user id * @param {HttpContext} ctx * @param {Callback} cb * @public */ UserProfile.UploadPictureForOther = function (id, ctx, cb) { cb = cb || promiseCallback(); app.models.Account.findById(id).then((account) =&gt; { UserProfile._UploadPicture(account, ctx, cb); }).catch((e) =&gt; { cb(e); }); return cb.promsie; }; UserProfile.remoteMethod(&quot;UploadPictureForOther&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}}, {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'object', root: true }, http: {verb: 'post', status: 201, path: &quot;/:id/picture&quot;} }); /** * Download profile picture of other user * @param {String} id Account(User) id * @param {String} hash * @param {String} style * @param {HttpContext} ctx * @param {Callback} cb */ UserProfile.DownloadPictureForOther = function (id, hash, style, ctx, cb) { cb = cb || promiseCallback(); app.models.Account.findById(id).then(accountFound).catch(accountError); return cb.promise; function accountFound(account) { app.models.UserProfileImageContainer.DownloadPicture(account, hash, style, ctx); } function accountError(err) { cb(err); } }; UserProfile.remoteMethod(&quot;DownloadPictureForOther&quot;, { accepts: [ {arg: 'id', type: 'string', required: true, http: {source: 'path'}}, {arg: 'hash', type: 'string', required: true, http: {source: 'path'}}, { arg: 'style', type: 'string', http: function (ctx) { var req = ctx.req; var query = req.query || {}; var style = query['style'] ? query['style'] : null; return style ? style.trim() : &quot;&quot;; } }, {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'object', root: true }, http: {verb: 'get', path: &quot;/:id/picture/:hash&quot;} }); } /** * Adds create-update user profile by admin capability * @param UserProfile */ function defineAdminStuff(UserProfile) { /** * Class method for creating an `UserProfile` by admin * Just a proxy for main function. */ UserProfile.CreateProfileByAdmin = function (id, data, cb) { return createProfile(id, data, cb); }; UserProfile.beforeRemote('CreateProfileByAdmin', Security.RemoteHooks.checkCurrentUserIsAdmin); UserProfile.beforeRemote('CreateProfileByAdmin', commonBeforeRemotes.correctCaseOfKeys); UserProfile.beforeRemote('CreateProfileByAdmin', dataOwnerCorrector); UserProfile.beforeRemote('CreateProfileByAdmin', Common.RemoteHooks.correctRequestData); UserProfile.remoteMethod( 'CreateProfileByAdmin', { description: 'Creates an user profile by admin.', accepts: [ { arg: 'id', type: 'string', required: true, http: { source: 'path' } }, { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], http: { path: &quot;/:id&quot;, verb: 'post', status: 201 } } ); /** * Class method for updating an `UserProfile` by admin * Just a proxy for main function. */ UserProfile.UpdateProfileByAdmin = function (id, data, cb) { return updateProfile(id, data, cb); }; UserProfile.beforeRemote('UpdateProfileByAdmin', Security.RemoteHooks.checkCurrentUserIsAdmin); UserProfile.beforeRemote('UpdateProfileByAdmin', commonBeforeRemotes.correctCaseOfKeys); UserProfile.beforeRemote('UpdateProfileByAdmin', dataOwnerCorrector); UserProfile.beforeRemote('UpdateProfileByAdmin', Common.RemoteHooks.correctRequestData); UserProfile.remoteMethod( 'UpdateProfileByAdmin', { description: 'Updates an user profile by admin.', accepts: [ { arg: 'id', type: 'string', required: true, http: { source: 'path' } }, { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], http: { path: &quot;/:id&quot;, verb: 'put', status: 204 } } ); } × Search results Close "},"server_models_geo_house-image-container.js.html":{"id":"server_models_geo_house-image-container.js.html","title":"Source: server/models/geo/house-image-container.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/geo/house-image-container.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var nodePath = require('path'); var app = serverRequire('server'); var Http = require('narengi-utils').Http; var FileSystem = require('narengi-utils').FileSystem; var underscore = require('underscore'); /** * This model (`HouseImageContainer`) is responsible for managing images of `House` * All remote methods should be served through `House` * @class * @param {Model} HouseImageContainer */ module.exports = function (HouseImageContainer) { defineAttributes(HouseImageContainer); addMethods(HouseImageContainer); addServices(HouseImageContainer); }; function defineAttributes(HouseImageContainer) { HouseImageContainer.Config = {}; HouseImageContainer.Config.Dir = app.settings.house.picture.dirName || &quot;house-images&quot;; HouseImageContainer.Config.Root = app.settings.house.picture.root; HouseImageContainer.Config.Styles = app.settings.house.picture.styles; HouseImageContainer.Config.MaxSize = app.settings.house.picture.maxSize; } /** * Add static methods for `HouseImageContainer` * @param {Model} HouseImageContainer */ function addMethods(HouseImageContainer) { /** * Returns physical path for house to save picture * @param {string} houseId */ HouseImageContainer.getPathFor = function (houseId) { return nodePath.join(this.Config.Root, this.DirName(this.Config), houseId); }; } /** * Add services to be used in `House` model * @param {Model} HouseImageContainer */ function addServices(HouseImageContainer) { /** * Uploads a file with specific attributes like filename and destination path and remote field name * @param {House} house * @param {HttpContext} httpCtx * @param {object} options * @return {Promise} */ HouseImageContainer.UploadPicture = function (house, httpCtx, options) { options = options || {}; options[&quot;destDir&quot;] = this.getPathFor(house.id.toString()); options[&quot;fieldName&quot;] = &quot;picture&quot;; return this.super_.UploadPicture(httpCtx, options, this.Config); }; /** * Uploads multiple files with specific attributes like filename and destination path and remote field name * @param {House} house * @param {HttpContext} httpCtx * @param {object} options * @return {Promise} */ HouseImageContainer.UploadPictureAll = function (house, httpCtx, options) { options = options || {}; options[&quot;destDir&quot;] = this.getPathFor(house.id.toString()); options[&quot;fieldName&quot;] = &quot;picture[]&quot;; return this.super_.UploadPictureAll(httpCtx, options, this.Config); }; /** * Download profile picture service * @param {House} house * @param {string} hash File hash * @param {String} style * @param {HttpContext} httpCtx * @return Nothing * @throws `Filesystem.Errors.FileNotFound` if user is not valid or not having a picture in its profile */ HouseImageContainer.DownloadPicture = function (house, hash, style, httpCtx) { this.super_.DownloadPicture(this.getPathFor(house.id.toString()), house.pictures, hash, style, httpCtx, this.Config); }; } × Search results Close "},"server_models_user-profile-image-container.js.html":{"id":"server_models_user-profile-image-container.js.html","title":"Source: server/models/user-profile-image-container.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/user-profile-image-container.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var nodePath = require('path'); var app = serverRequire('server'); var fsExtra = require('fs-extra'); /** * This model (`UserProfileImageContainer`) is responsible for managing files of `UserProfile` * All remote methods should be served through `UserProfile` * @class * @param {object} UserProfileImageContainer */ module.exports = function (UserProfileImageContainer) { defineAttributes(UserProfileImageContainer); addMethods(UserProfileImageContainer); addServices(UserProfileImageContainer); }; function defineAttributes(UserProfileImageContainer) { UserProfileImageContainer.Config = {}; UserProfileImageContainer.Config.Dir = app.settings.userProfile.picture.dirName || &quot;user-profile-images&quot;; UserProfileImageContainer.Config.Root = app.settings.userProfile.picture.root; UserProfileImageContainer.Config.Styles = app.settings.userProfile.picture.styles; UserProfileImageContainer.Config.MaxSize = app.settings.userProfile.picture.maxSize; } /** * Add static methods for `UserProfileImageContainer` * @param {object} UserProfileImageContainer */ function addMethods(UserProfileImageContainer) { /** * Returns physical path for user to save picture * @return {Promise} resolve(path), reject(Error) * @param userId */ UserProfileImageContainer.getPathFor = function (userId) { return nodePath.join(this.Config.Root, this.DirName(this.Config), userId); }; }; /** * Add services to be used in `UserProfile` model * @param {object} UserProfileImageContainer */ function addServices(UserProfileImageContainer) { /** * Uploads a file with specific attributes like filename and destination path and remote field name * @param {Account} user * @param {HttpContext} httpCtx * @param {object} options * @constructor * @return {Promise} */ UserProfileImageContainer.UploadPicture = function (user, httpCtx, options) { options = options || {}; options[&quot;destDir&quot;] = this.getPathFor(user.id.toString()); options[&quot;fieldName&quot;] = &quot;picture&quot;; var self = this; return new Promise(function (resolve, reject) { fsExtra.emptyDir(options[&quot;destDir&quot;], function (err) { if (err) return reject(err); self.super_.UploadPicture(httpCtx, options, self.Config).then((result) =&gt; { resolve(result); }).catch((e) =&gt; { reject(e); }); }); }); }; /** * Download profile picture service * @param {Account} user * @param {String} hash * @param {String} style * @param {HttpContext} httpCtx * @throws FilesysteError.FileNotFound if user is not valid or not having a picture in its profile */ UserProfileImageContainer.DownloadPicture = function (user, hash, style, httpCtx) { if (user.profile.value() &amp;&amp; user.profile.value().picture) { var picture = user.profile.value().picture; this.super_.DownloadPicture(this.getPathFor(user.id.toString()), [picture], hash, style, httpCtx, this.Config); } else { this.NotFound(httpCtx); } }; }; × Search results Close "},"server_models_geo_attraction-image-container.js.html":{"id":"server_models_geo_attraction-image-container.js.html","title":"Source: server/models/geo/attraction-image-container.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/geo/attraction-image-container.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var nodePath = require('path'); var app = serverRequire('server'); var downloader = require('narengi-utils').Http.Downloader; var FilesysteError = require('narengi-utils').FileSystem.Errors; var underscore = require('underscore'); /** * This model (`AttractionImageContainer`) is responsible for managing images of `Attraction` * All remote methods should be served through `Attraction` * @class * @param {AttractionImageContainer} AttractionImageContainer */ module.exports = function (AttractionImageContainer) { defineAttributes(AttractionImageContainer); addMethods(AttractionImageContainer); addServices(AttractionImageContainer); }; function defineAttributes(AttractionImageContainer) { AttractionImageContainer.Config = {}; AttractionImageContainer.Config.Dir = app.settings.attraction.picture.dirName || &quot;attraction-images&quot;; AttractionImageContainer.Config.Root = app.settings.attraction.picture.root; AttractionImageContainer.Config.Styles = app.settings.attraction.picture.styles; AttractionImageContainer.Config.MaxSize = app.settings.attraction.picture.maxSize; } /** * Add static methods for `AttractionImageContainer` * @param {AttractionImageContainer} AttractionImageContainer */ function addMethods(AttractionImageContainer) { /** * Returns physical path for attraction to save picture * @param {string} attractionId * @return {Promise} resolve(path), reject(Error) */ AttractionImageContainer.getPathFor = function (attractionId) { return nodePath.join(this.Config.Root, this.DirName(this.Config), attractionId); }; }; /** * Add services to be used in `Attraction` model * @param {object} AttractionImageContainer */ function addServices(AttractionImageContainer) { /** * Uploads a file with specific attributes like filename and destination path and remote field name * @param {Attraction} attraction * @param {HttpContext} httpCtx * @param {object} options * @return {Promise} */ AttractionImageContainer.UploadPicture = function (attraction, httpCtx, options) { options = options || {}; options[&quot;destDir&quot;] = this.getPathFor(attraction.id.toString()); options[&quot;fieldName&quot;] = &quot;picture&quot;; return this.super_.UploadPicture(httpCtx, options, this.Config); }; /** * Uploads multiple files with specific attributes like filename and destination path and remote field name * @param {Attraction} attraction * @param {HttpContext} httpCtx * @param {object} options * @return {Promise} */ AttractionImageContainer.UploadPictureAll = function (attraction, httpCtx, options) { options = options || {}; options[&quot;destDir&quot;] = this.getPathFor(attraction.id.toString()); options[&quot;fieldName&quot;] = &quot;picture[]&quot;; return this.super_.UploadPictureAll(httpCtx, options, this.Config); }; /** * Download profile picture service * @param {Attraction} attraction * @param hash * @param style * @param {HttpContext} httpCtx * @return Nothing * @throws FilesysteError.FileNotFound if user is not valid or not having a picture in its profile */ AttractionImageContainer.DownloadPicture = function (attraction, hash, style, httpCtx) { this.super_.DownloadPicture(this.getPathFor(attraction.id.toString()), attraction.pictures, hash, style, httpCtx, this.Config); }; } × Search results Close "},"server_models_geo_city-image-container.js.html":{"id":"server_models_geo_city-image-container.js.html","title":"Source: server/models/geo/city-image-container.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/geo/city-image-container.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var nodePath = require('path'); var app = serverRequire('server'); var downloader = require('narengi-utils').Http.Downloader; var FilesysteError = require('narengi-utils').FileSystem.Errors; var underscore = require('underscore'); /** * This model (`CityImageContainer`) is responsible for managing images of `City` * All remote methods should be served through `City` * @class * @param {CityImageContainer} CityImageContainer */ module.exports = function (CityImageContainer) { defineAttributes(CityImageContainer); addMethods(CityImageContainer); addServices(CityImageContainer); }; function defineAttributes(CityImageContainer) { CityImageContainer.Config = {}; CityImageContainer.Config.Dir = app.settings.city.picture.dirName || &quot;city-images&quot;; CityImageContainer.Config.Root = app.settings.city.picture.root; CityImageContainer.Config.Styles = app.settings.city.picture.styles; CityImageContainer.Config.MaxSize = app.settings.city.picture.maxSize; } /** * Add static methods for `CityImageContainer` * @param {CityImageContainer} CityImageContainer */ function addMethods(CityImageContainer) { /** * Returns physical path for city to save picture * @param {string} cityId * @return {Promise} resolve(path), reject(Error) */ CityImageContainer.getPathFor = function (cityId) { return nodePath.join(this.Config.Root, this.DirName(this.Config), cityId); }; }; /** * Add services to be used in `City` model * @param {object} CityImageContainer */ function addServices(CityImageContainer) { /** * Uploads a file with specific attributes like filename and destination path and remote field name * @param {City} city * @param {HttpContext} httpCtx * @param {object} options * @return {Promise} */ CityImageContainer.UploadPicture = function (city, httpCtx, options) { options = options || {}; options[&quot;destDir&quot;] = this.getPathFor(city.id.toString()); options[&quot;fieldName&quot;] = &quot;picture&quot;; return this.super_.UploadPicture(httpCtx, options, this.Config); }; /** * Uploads multiple files with specific attributes like filename and destination path and remote field name * @param {City} city * @param {HttpContext} httpCtx * @param {object} options * @return {Promise} */ CityImageContainer.UploadPictureAll = function (city, httpCtx, options) { options = options || {}; options[&quot;destDir&quot;] = this.getPathFor(city.id.toString()); options[&quot;fieldName&quot;] = &quot;picture[]&quot;; return this.super_.UploadPictureAll(httpCtx, options, this.Config); }; /** * Download profile picture service * @param {City} city * @param hash * @param style * @param {HttpContext} httpCtx * @return Nothing * @throws FilesysteError.FileNotFound if user is not valid or not having a picture in its profile */ CityImageContainer.DownloadPicture = function (city, hash, style, httpCtx) { this.super_.DownloadPicture(this.getPathFor(city.id.toString()), city.pictures, hash, style, httpCtx, this.Config); }; } × Search results Close "},"server_models_image-container-base.js.html":{"id":"server_models_image-container-base.js.html","title":"Source: server/models/image-container-base.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/image-container-base.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var nodePath = require('path'); var app = serverRequire('server'); var underscore = require('underscore'); var async = require('async'); var fs = require('fs'); var path = require('path'); var mime = require('mime'); var debugOne = require('debug')('narengi:image-container:one-upload'); var debugMultiple = require('debug')('narengi:image-container:multiple-upload'); var Http = require('narengi-utils').Http; var FileSystem = require('narengi-utils').FileSystem; var Common = require('narengi-utils').Common; /** * This model (`ImageContainerBase`) is responsible for managing images of `House` * All remote methods should be served through `House` * @class * @param {Model} ImageContainerBase */ module.exports = function (ImageContainerBase) { addMethods(ImageContainerBase); addServices(ImageContainerBase); }; /** * Add static methods for `ImageContainerBase` * @param {Model} ImageContainerBase */ function addMethods(ImageContainerBase) { /** * Returns folder name of pictures * @return {string} */ ImageContainerBase.DirName = function (config) { return config.Dir; }; ImageContainerBase.NotFound = function (httpCtx) { httpCtx.res.statusCode = 404; httpCtx.res.end(); }; } /** * Add services to be used in model * @param {Model} ImageContainerBase */ function addServices(ImageContainerBase) { /** * Upload one picture attached to http request body * @param {HttpContext} httpCtx * @param {Object} options * @param {Config} config * @return {Promise} * @constructor */ ImageContainerBase.UploadPicture = function (httpCtx, options, config) { options[&quot;maxSize&quot;] = config.MaxSize; options[&quot;hash&quot;] = true; options[&quot;styles&quot;] = underscore.extend({original: &quot;original&quot;}, config.Styles); return new Promise(function (resolve, reject) { Http.Uploader.upload(httpCtx.req, options).then(function (file) { doStructureResultForOneUpload(file).then((result) =&gt; { debugOne(JSON.stringify(result)); var hashes = underscore.map(result.db, function (item) { return item.hash; }); syncDbFromFs(options[&quot;destDir&quot;], options[&quot;styles&quot;], hashes, function (err, syncedResult) { if (err) syncedResult = []; result.db = result.db || []; result.db = result.db.concat(syncedResult); resolve(result); }); }).catch((err) =&gt; { reject(err); }); } ).catch(function (err) { debugOne(err); reject(err); } ); }); }; /** * Uploads multiple files with specific attributes like filename and destination path and remote field name * @param {HttpContext} httpCtx * @param {object} options * @param {Object} config * @return {Promise} */ ImageContainerBase.UploadPictureAll = function (httpCtx, options, config) { options[&quot;maxSize&quot;] = config.MaxSize; options[&quot;hash&quot;] = true; options[&quot;styles&quot;] = underscore.extend({original: &quot;original&quot;}, config.Styles); return new Promise(function (resolve, reject) { Http.Uploader.uploadAll(httpCtx.req, options).then(function (files) { doStructureResultForMultiple(files).then((result) =&gt; { debugMultiple(JSON.stringify(result)); var hashes = underscore.map(result.db, function (item) { return item.hash; }); syncDbFromFs(options[&quot;destDir&quot;], options[&quot;styles&quot;], hashes, function (err, syncedResult) { if (err) syncedResult = []; result.db = result.db || []; result.db = result.db.concat(syncedResult); resolve(result); }); }).catch((err) =&gt; { reject(err); }); } ).catch(function (err) { debugMultiple(err); reject(err); } ); }); }; /** * Streaming picture through http * @param {String} root Absolute path to root * @param {Array} persistedPics Persisted pictures in db * @param {String} hash * @param {String} style * @param {HttpContext} httpCtx * @param {Object} config */ ImageContainerBase.DownloadPicture = function (root, persistedPics, hash, style, httpCtx, config) { if (!persistedPics) return this.NotFound(httpCtx); var picture = underscore.find(persistedPics, function (item) { return item.hash === hash; }); if (!picture) return this.NotFound(httpCtx); style = underscore.pick(config.Styles, style); if (underscore.keys.length &lt; 1) style = underscore.extend({original: &quot;original&quot;}, style); style = underscore.keys(style)[0]; var dir = nodePath.join(root, hash); var self = this; var originalFilename = &quot;&quot;; async.waterfall([ async.apply(fs.readdir, dir), function (filenames, callback) { var foundFile = underscore.find(filenames, function (filename) { var extname = nodePath.extname(filename); var basename = nodePath.basename(filename, extname); if (basename == &quot;original&quot;) { originalFilename = basename + extname; } return basename == style; }); callback(null, foundFile); } ], function (err, result) { if (err) return self.NotFound(httpCtx); result = result || originalFilename; var filePath = nodePath.join(dir, result); download(filePath); }); function download(filePath) { Http.Downloader.download(httpCtx.res, &quot;picture&quot;, filePath); } }; } function syncDbFromFs(root, styles, calculatedHashes, cb) { if (!calculatedHashes) { calculatedHashes = []; } cb = cb || Common.PromiseCallback(); async.waterfall([ async.apply(fs.readdir, root), traverseHashes ], function (err, result) { if (err) return cb(err); cb(null, result); }); return cb.promise; /** * * @param {Array} hashes Hash names indicating one image (but contains multiple styles) * @param {Callback} callback Returns hash packets each containing hash and styles array. * Like : * ``` * [ * { * hash: &quot;hash&quot;, * styles: [ * style: {key: value}, * size: {number}, * type: {string} * ] * }, ... * ] * ``` */ function traverseHashes(hashes, callback) { async.reduce(hashes, [], traverseEachHash, callback); } /** * * @param {Array} hashPackets * @param {String} hash * @param {Callback} retCb */ function traverseEachHash(hashPackets, hash, retCb) { if (underscore.contains(calculatedHashes, hash)) return retCb(null, hashPackets); //prevent from redundant processing var oneImgDir = path.join(root, hash); async.waterfall([ async.apply(fs.readdir, oneImgDir), function (filenames, callback) { async.reduce(filenames, [], calcEachFile, callback); } ], function (err, result) { if (err) return retCb(err); var ret = { hash: hash, styles: result }; hashPackets.push(ret); retCb(null, hashPackets); }); /** * It processes one style packet for input filename, then concatenates with reduced memo * @param {Array} reducedStyle * @param {String} filename * @param {Callback} callback */ function calcEachFile(reducedStyle, filename, callback) { var styleName = path.basename(filename, path.extname(filename)); if (!styles[styleName]) return callback(null, reducedStyle); var filePath = path.join(oneImgDir, filename); var packet = {}; packet.style = styles[styleName]; packet.type = mime.lookup(filePath); FileSystem.Core.getSize(filePath, function (err, fileSize) { if (err) fileSize = {size: 0}; packet.size = fileSize.size; reducedStyle.push(packet); callback(null, reducedStyle); }); } } } /** * Refine structure of uploaded files for db and api * @param {Array} files * ``` * [ * { file-hash : [array of diverse saved file based on each style] * } * ] * ``` * @param {Callback} cb * @return {Promise} */ function doStructureResultForMultiple(files, cb) { cb = cb || Common.PromiseCallback(); if (underscore.isArray(files)) { async.each(files, function (filePack, callback) { var fileHash = underscore.keys(filePack)[0]; var fileArr = filePack[fileHash]; var filePathArr = underscore.map(fileArr, function (file) { return file.destPath; }); extractFileSizes(fileArr, filePathArr).then((updatedFiles) =&gt; { filePack[fileHash] = updatedFiles; callback(null); }).catch((err) =&gt; { callback(err); }); }, function (err) { if (err) return cb(err); cb(null, prepareReturnForMultipleUpload(files)); }); } else { cb(null, {api: null, db: null}); } return cb.promise; } function prepareReturnForMultipleUpload(files) { var ret = { api: null, db: [] }; underscore.each(files, function (filePack) { var hash = underscore.keys(filePack)[0]; var oneFileArr = filePack[hash]; var arr = underscore.map(oneFileArr, function (item) { return { style: item.style, size: item.size, type: item.type }; }); var oneItem = {}; oneItem.hash = hash; oneItem.styles = arr; ret.db.push(oneItem); }); ret.api = ret.db; return ret; } function doStructureResultForOneUpload(files, cb) { cb = cb || Common.PromiseCallback(); if (underscore.isArray(files)) { var filePathArr = underscore.map(files, function (file) { return file.destPath; }); extractFileSizes(files, filePathArr).then((updatedFiles) =&gt; { cb(null, prepareReturnForOneUpload(updatedFiles)); }).catch((err) =&gt; { cb(err); }); } else { cb(null, {api: null, db: []}); } return cb.promise; } /** * Enriches file info packages by file sizes. * @param {Array} files Array of file info package returned by `Http.Uploader` utility. * @param {Array} filePathArr Array of string denoting file path's * @param {Callback} cb * @return {Promise} */ function extractFileSizes(files, filePathArr, cb) { cb = cb || Common.PromiseCallback(); async.map(filePathArr, FileSystem.Core.getSize, function (err, result) { if (err) return cb(err); underscore.each(files, function (file) { var stat = underscore.find(result, function (item) { return file.destPath === item.file; }); file.size = stat ? stat.size : 0; }); cb(null, files); }); return cb.promise; } function prepareReturnForOneUpload(files) { var ret = { api: null, db: [] }; var packet = {}; packet.hash = files[0].hash; var arr = underscore.map(files, function (item) { return { style: item.style, size: item.size, type: item.type }; }); packet.styles = arr; ret.db.push(packet); ret.api = ret.db; return ret; } × Search results Close "},"server_lib_utils_lib_pagination_remote-hooks.js.html":{"id":"server_lib_utils_lib_pagination_remote-hooks.js.html","title":"Source: server/lib/utils/lib/pagination/remote-hooks.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/utils/lib/pagination/remote-hooks.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var loopback = require('loopback'); var jsUri = require('jsuri'); var debug = require('debug')('narengi-utils:pagination'); var app = require('narengi-utils').Common.app; module.exports = exports; /** * Wraps needed arguments in before remote hook to use in corresponding after remote * @param {array} neededQuery * @returns {Function} */ exports.argumentWrapper = function (neededQuery) { /** * Before remote * @param {AccessContext} ctx * @param {Model} instance * @param {Callback} next */ return function (ctx, instance, next) { var needed = []; if (neededQuery) { needed = neededQuery; } ctx.req.paginationNeededQuery = needed; next(); } }; /** * Before remote to refine pagination params * @param {AccessContext} ctx * @param {Model} instance Not used * @param {Callback} next */ exports.refinePaginationParams = function (ctx, instance, next) { var paging = ctx.args.paging; if (!paging.limit) { paging.limit = parseInt(app().settings.pagination.default.limit); } if (paging.limit &lt; 1) { paging.limit = 10; } ctx.args.paging = paging; next(); }; /** * Enriches http `response` with necessary headers * @param {AccesContext} ctx * @param {Model} instance Not used * @param {Callback} next */ exports.afterPaginatedService = function (ctx, instance, next) { var modelName = ctx.method.sharedClass.name; var model = loopback.getModel(modelName); var paging = ctx.args.paging; model.count(paging.where).then(countedHandler(ctx)).catch(() =&gt; { next() }); function countedHandler(context) { var ctx = context; var paging = ctx.args.paging; var neededQuery = ctx.req.paginationNeededQuery || []; return function (count) { ctx.res.append(&quot;X-Total-Count&quot;, count); // if there are instances then response header links should be injected if (count &gt; 0) { var limit = paging.limit; var skip = paging.skip; try { var links = &quot;&quot;; links += firstLink(limit, skip, count); links += beforeLink(limit, skip, count); links += nextLink(limit, skip, count); links += lastLink(limit, skip, count); ctx.res.append(&quot;Link&quot;, links); } catch (ex) { debug(&quot;Error : %j&quot;, ex); } } next(); }; function createLink(limit, skip) { var uri = new jsUri(); uri.setPath(ctx.req.baseUrl + ctx.method.http.path); neededQuery.forEach(function (item, index, collection) { uri.addQueryParam(item, ctx.args[item]); }); uri.addQueryParam(&quot;filter[limit]&quot;, limit); uri.addQueryParam(&quot;filter[skip]&quot;, skip); return uri.toString(); } function beforeLink(limit, skip, total) { var calcLimit = limit, calcSkip = skip; if (skip &gt; limit) { calcSkip -= limit; } else { calcSkip = 0; } return createLink(calcLimit, calcSkip) + &quot;; rel=\\&quot;prev\\&quot;&quot;; } function nextLink(limit, skip, total) { var calcLimit = limit, calcSkip = skip; if ((skip + limit) &lt;= total) { calcSkip += limit; } else { //do nothing, don't change url } return createLink(calcLimit, calcSkip) + &quot;; rel=\\&quot;next\\&quot;&quot;; } function firstLink(limit, skip, total) { var calcLimit = limit, calcSkip = 0; return createLink(calcLimit, calcSkip) + &quot;; rel=\\&quot;first\\&quot;&quot;; } function lastLink(limit, skip, total) { var calcLimit = limit, calcSkip = skip; calcSkip = Math.floor(total / limit) * limit; return createLink(calcLimit, calcSkip) + &quot;; rel=\\&quot;last\\&quot;&quot;; } } }; × Search results Close "},"server_lib_utils_lib_common_index.js.html":{"id":"server_lib_utils_lib_common_index.js.html","title":"Source: server/lib/utils/lib/common/index.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/utils/lib/common/index.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var loopback = require('loopback'); module.exports = exports; exports.Errors = require('./errors'); exports.RemoteHooks = require('./remote-hooks'); exports.PromiseCallback = require('./promise-callback'); /** * Get current application * @returns {Application} */ exports.app = require('./application'); exports.Size = require('./size'); exports.Dates = require('./dates'); × Search results Close "},"server_boot_application.js.html":{"id":"server_boot_application.js.html","title":"Source: server/boot/application.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/boot/application.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var loopback = require('loopback'); var ctx = require('loopback/lib/access-context'); var AccessContext = ctx.AccessContext; var Principal = ctx.Principal; var AccessRequest = ctx.AccessRequest; module.exports = function(app) { /** Here we change default behaviour of checking access levels in `Application`. **/ app[&quot;currentLocale&quot;] = app.settings.locale.default; Principal.USER = &quot;Account&quot;; var AuthToken = app.models.AuthToken; app.enableCustomAuth = function(options) { //var AUTH_MODELS = ['User', 'AccessToken', 'ACL', 'Role', 'RoleMapping']; var AUTH_MODELS = ['Account', 'ACL', 'Role', 'RoleMapping']; var remotes = this.remotes(); var app = this; if (options &amp;&amp; options.dataSource) { var appModels = app.registry.modelBuilder.models; AUTH_MODELS.forEach(function(m) { var Model = app.registry.findModel(m); if (!Model) { throw new Error( 'Authentication requires model ' + m + ' to be defined.'); } if (m.dataSource || m.app) return; for (var name in appModels) { var candidate = appModels[name]; var isSubclass = candidate.prototype instanceof Model; var isAttached = !!candidate.dataSource || !!candidate.app; if (isSubclass &amp;&amp; isAttached) return; } app.model(Model, { dataSource: options.dataSource, public: m === 'User' }); }); } remotes.authorization = function(ctx, next) { var method = ctx.method; var req = ctx.req; var Model = method.ctor; var modelInstance = ctx.instance; var modelId = modelInstance &amp;&amp; modelInstance.id || // replacement for deprecated req.param() (req.params &amp;&amp; req.params.id !== undefined ? req.params.id : req.body &amp;&amp; req.body.id !== undefined ? req.body.id : req.query &amp;&amp; req.query.id !== undefined ? req.query.id : undefined); var modelName = Model.modelName; var modelSettings = Model.settings || {}; var errStatusCode = modelSettings.aclErrorStatus || app.get('aclErrorStatus') || 401; if (!req.accessToken) { errStatusCode = 401; } // comes from `Model` code of `loopback` if (Model.checkAccess) { doCheckAccess( Model, req.accessToken, modelId, method, ctx, function(err, allowed) { if (err) { console.log(err); next(err); } else if (allowed) { next(); } else { var messages = { 403: { message: 'Access Denied', code: 'ACCESS_DENIED' }, 404: { message: ('could not find ' + modelName + ' with id ' + modelId), code: 'MODEL_NOT_FOUND' }, 401: { message: 'Authorization Required', code: 'AUTHORIZATION_REQUIRED' } }; var e = new Error(messages[errStatusCode].message || messages[403].message); e.statusCode = errStatusCode; e.code = messages[errStatusCode].code || messages[403].code; next(e); } } ); } else { next(); } }; this.isAuthEnabled = true; }; var doCheckAccess = function(Model, token, modelId, sharedMethod, ctx, cb) { var ANONYMOUS = AuthToken.ANONYMOUS; token = token || ANONYMOUS; var aclModel = Model._ACL(); ctx = ctx || {}; if (typeof ctx === 'function' &amp;&amp; cb === undefined) { cb = ctx; ctx = {}; } var checkingContext = { accessToken: token, model: Model, property: sharedMethod.name, method: sharedMethod.name, sharedMethod: sharedMethod, modelId: modelId, accessType: Model._getAccessTypeForMethod(sharedMethod), remotingContext: ctx }; var accessCtx = new AccessContext(checkingContext); aclModel.checkAccessForContext(checkingContext, function(err, accessRequest) { if (err) return cb(err); cb(null, accessRequest.isAllowed()); }); }; }; × Search results Close "},"server_boot_entities_role-mapping.js.html":{"id":"server_boot_entities_role-mapping.js.html","title":"Source: server/boot/entities/role-mapping.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/boot/entities/role-mapping.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // module.exports = function(app) { /** * Changing specific settings for `RoleMapping` model **/ // Replace `User` by `Account` app.models.RoleMapping.ACCOUNT = &quot;Account&quot;; app.models.RoleMapping.USER = &quot;Account&quot;; }; × Search results Close "},"server_lib_utils_lib_common_remote-hooks.js.html":{"id":"server_lib_utils_lib_common_remote-hooks.js.html","title":"Source: server/lib/utils/lib/common/remote-hooks.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/utils/lib/common/remote-hooks.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var changeCase = require('change-case'); var underscore = require('underscore'); var lodash = require('lodash'); var app = require('./application'); var loopback = require('loopback'); var Common = require('./index'); var debug = require('debug')('narengi-utils:common:remote-hooks'); module.exports = exports; /** * Returns a map containg each property key in lowerCase as key and original as value */ function getModelKeyMap(modelName) { var result = {}; try { var modelProperties = app().models[modelName].definition.properties; var modelKeys = underscore.keys(modelProperties); underscore.each(modelKeys, function (key) { result[changeCase.lowerCase(key)] = key; }); } catch (e) { } finally { } return result; } /** * Make `request.body` comply model definition * Wraps a callback for handling successful situations * @param {Function} cb `loopback` callback * @deprecated */ exports.correctCaseOfKeys = function (ctx, instance, next) { try { var data = ctx.req.body; if (!data) { return next(Common.Errors.DataEmpty()); } var modelName = ctx.method.sharedClass.name; var modelKeys = getModelKeyMap(modelName); var result = {}; var keys = underscore.keys(data); underscore.each(keys, function (key) { var loweredKey = changeCase.lowerCase(key); result[modelKeys[loweredKey]] = data[key]; }); ctx.req.body = result; next(); } catch (e) { next(); } finally { } }; exports.correctCaseOfKeysInArg = function (argName, deep) { return function (ctx, instance, next) { try { var data = ctx.args[argName]; if (!data) { return next(); } if (deep === undefined) { deep = false; } var result = {}; var keys = underscore.keys(data); underscore.each(keys, function (key) { var loweredKey = changeCase.snakeCase(key).toLowerCase(); var innerData = data[key]; if (deep) { //if(typeof data[key] === 'object'){ if (lodash.isPlainObject(data[key])) { var tmpInnerData = {}; underscore.each(underscore.keys(innerData), function (innerKey) { tmpInnerData[changeCase.snakeCase(innerKey).toLowerCase()] = innerData[innerKey]; }); innerData = tmpInnerData; } } result[loweredKey] = innerData; }); ctx.args[argName] = result; } catch (e) { } finally { next(); } }; }; /** * We should inject request body to `args` again. Because injection body to arguments is done at first calling of before remotes. * @param {Context} ctx * @param {Model} instance * @param {Callback} next */ exports.correctRequestData = function (ctx, instance, next) { ctx.args.data = ctx.req.body; next(); }; /** * Inject current language to data sent from client * @param {Context} ctx * @param {Model} instance * @param {Callback} next */ exports.injectLangToRequestData = function (ctx, instance, next) { ctx.args.data = ctx.args.data || {}; ctx.args.data['lang'] = app().currentLocale; next(); }; /** * Wrapper for after remote hook to convert entity to DTO * @param {Model|string} Entity * @param {object} options * @returns {Function} Returns remote hook */ exports.convert2Dto = function (Entity, options) { /** * Converts entity to dto for API endpoints * @param {Context} ctx * @param {Model} instance * @param {Callback} next */ return function (ctx, instance, next) { if (typeof Entity === &quot;string&quot;) { Entity = loopback.getModel(Entity); } debug(&quot;Convert to DTO =&gt; model: %j, options: %j&quot;, Entity, options); try { options = options || {}; if(options.byPassTransform === true){ return next(); } options.currentContext = ctx.req.narengi_context; options.ctx = ctx; var Model = loopback.findModel(Entity.definition.name + &quot;DTO&quot;); if (!underscore.isObject(Model)) return next(); var result = ctx.result; if (underscore.isArray(result)) { result = Model.ConvertArray(result, options); } else { result = Model.Convert(result, options); } ctx.result = result; next(); } catch (ex) { next(ex); } }; }; /** A `beforeRemote` hook validating input data for persisting in storage This method correct and sanitizes input data. * @deprecated **/ exports.dataOwnerCorrector = function (defaultForm) { return function (ctx, instance, next) { var data = ctx.req.body; if (!data) { return next(Common.Errors.DataEmpty()); } data = underscore.pick(data, underscore.keys(defaultForm)); ctx.req.body = data; next(); }; }; /** * Picks just fields defined in model definition * @param {string} argName Argument name * @param {string} modelName Model name * @returns {Function} */ exports.dataOwnerCorrectorInArg = function (argName, modelName) { return function (ctx, instance, next) { var data = ctx.args[argName]; if (!data) { return next(Common.Errors.DataEmpty()); } var modelKeys = getModelKeyMap(modelName); data = underscore.pick(data, underscore.values(modelKeys)); ctx.args[argName] = data; next(); }; }; /** * Validates the http request body should not be empty * @param {Context} ctx * @param {Model} instance * @param {Callback} next * @deprecated */ exports.dataShouldNotEmpty = function (ctx, instance, next) { var data = ctx.req.body; if (!data) return next(Common.Errors.DataEmpty()); next(); }; /** * Factory for remote hook to validate the argument * @param {string} argName * @returns {Function} */ exports.argShouldNotEmpty = function (argName) { /** * Validates the http request body should not be empty * @param {Context} ctx * @param {Model} instance * @param {Callback} next */ return function (ctx, instance, next) { var data = ctx.args[argName] || {}; if (underscore.size(underscore.keys(data)) &lt; 1) return next(Common.Errors.DataEmpty()); next(); }; }; × Search results Close "},"server_lib_utils_lib_persistency_crud-handlers.js.html":{"id":"server_lib_utils_lib_persistency_crud-handlers.js.html","title":"Source: server/lib/utils/lib/persistency/crud-handlers.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/utils/lib/persistency/crud-handlers.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var Persistency = require('./index'); module .exports = exports; /** * Wraps a callback for handling successful situations * @param {Function} cb `loopback` callback */ exports.successHandler = function(cb) { var callback = cb; return function(obj) { if(!obj) return callback(Persistency.Errors.NotFound()); callback(null, obj); }; }; /** * Wraps a callback for handling successful situations * - Use this for array * @param {Function} cb `loopback` callback */ exports.arraySuccessHandler = function(cb) { var callback = cb; return function(obj) { callback(null, obj); }; }; /** * Wraps a callback for handling failure situations * @param {Function} cb `loopback` callback */ exports.failureHandler = function(cb) { var callback = cb; return function(err) { callback(err); }; }; × Search results Close "},"server_models_geo_attraction.js.html":{"id":"server_models_geo_attraction.js.html","title":"Source: server/models/geo/attraction.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/geo/attraction.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var loopback = require('loopback'); var underscore = require('underscore'); var string = require('string'); var commonBeforeRemotes = require('narengi-utils').Common.RemoteHooks; var app = serverRequire('server'); var promiseCallback = require('narengi-utils').Common.PromiseCallback; var crudHandler = require('narengi-utils').Persistency.CrudHandlers; var Persistency = require('narengi-utils').Persistency; var Errors = require('narengi-utils').Common.Errors; var Pagination = require('narengi-utils').Pagination; var Common = require('narengi-utils').Common; module.exports = function (Attraction) { defineServices(Attraction); definePictureStuff(Attraction); }; /** * Before remote function to correct data sent from client * @param {HttpContext} ctx * @param {Attraction} instance If update method called then this parameter is valid * @param {Callback} next */ function dataCorrector(ctx, instance, next) { var data = ctx.req.body; if (!data) { next(Errors.DataEmpty()); } var defaultForm = { &quot;name&quot;: &quot;&quot;, &quot;summary&quot;: &quot;&quot;, &quot;description&quot;: &quot;&quot; }; data = underscore.pick(data, underscore.keys(defaultForm)); ctx.req.body = data; next(); } /** * Main function for creating or updating `Attraction` model * @param {string|null} attractionId * @param {object} data * @param {Callback} cb * @returns {Promise} */ function createOrUpdateAttraction(attractionId, data, cb) { if (attractionId === null) { app.models.Attraction.create(data).then(crudHandler.successHandler(cb)).catch(crudHandler.failureHandler(cb)); } else { app.models.Attraction.findOne({ where: {id: attractionId} }).then((attraction) =&gt; { if (!attraction) return cb(Persistency.Errors.NotFound()); attraction.updateAttributes(data).then(crudHandler.successHandler(cb)).catch(crudHandler.failureHandler(cb)); }).catch(crudHandler.failureHandler(cb)); } return cb.promise; } function defineServices(Attraction) { /** * Creates a new `Attraction` * @param {object} data * @param {Callback} cb * @returns {Promise} */ Attraction.Create = function (data, cb) { cb = cb || promiseCallback(); return createOrUpdateAttraction(null, data, cb); }; Attraction.beforeRemote('Create', commonBeforeRemotes.correctCaseOfKeys); Attraction.beforeRemote('Create', dataCorrector); Attraction.beforeRemote('Create', commonBeforeRemotes.correctRequestData); Attraction.beforeRemote('Create', commonBeforeRemotes.injectLangToRequestData); Attraction.afterRemote('Create', Common.RemoteHooks.convert2Dto(Attraction)); Attraction.remoteMethod( 'Create', { description: 'Creates a attraction.', accepts: [ { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], returns: { arg: 'attraction', type: 'object', root: true, }, http: { path: &quot;/&quot;, verb: 'post', status: 201 } } ); //======================================================================================== /** * Updates a `Attraction` * @param {string} attractionId * @param {object} data * @param {Callback} cb * @returns {Promise} */ Attraction.Update = function (attractionId, data, cb) { cb = cb || promiseCallback(); return createOrUpdateAttraction(attractionId, data, cb); }; Attraction.beforeRemote('Update', commonBeforeRemotes.correctCaseOfKeys); Attraction.beforeRemote('Update', dataCorrector); Attraction.beforeRemote('Update', commonBeforeRemotes.correctRequestData); Attraction.beforeRemote('Update', commonBeforeRemotes.injectLangToRequestData); Attraction.afterRemote(&quot;Update&quot;, function (ctx, instance, next) { ctx.result = {}; next(); }); Attraction.remoteMethod( 'Update', { description: 'Updates a attraction.', accepts: [ { arg: 'attractionId', type: 'string', required: true, http: { source: 'path' } }, { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], returns: { arg: 'attraction', type: 'object', root: true, }, http: { path: &quot;/:attractionId&quot;, verb: 'put', status: 204 } } ); //======================================================================================== /** * Deletes a `Attraction` by its id * @param {string} attractionId * @param {Callback} cb * @returns {Promise} */ Attraction.DeleteOne = function (attractionId, cb) { cb = cb || promiseCallback(); Attraction.findOne({where: {id: attractionId}}).then(function (attraction) { attraction.destroy().then(crudHandler.successHandler(cb)).catch(Errors.InternalError()); }).catch(() =&gt; { cb(Persistency.Errors.NotFound()); }); return cb.promise; }; Attraction.remoteMethod( 'DeleteOne', { description: 'Deletes a attraction.', accepts: [ { arg: 'attractionId', type: 'string', required: true, http: { source: 'path' } } ], http: { path: &quot;/:attractionId&quot;, verb: 'delete', status: 204 } } ); //======================================================================================== /** * Fetch a `Attraction` by its id * @param {string} attractionId * @param {Callback} cb * @returns {Promise} */ Attraction.GetById = function (attractionId, cb) { cb = cb || promiseCallback(); Attraction.findById(attractionId).then((attraction) =&gt; { if (attraction) { return cb(null, attraction); } cb(Persistency.Errors.NotFound()); }).catch(crudHandler.failureHandler(cb)); return cb.promise; }; Attraction.afterRemote('GetById', Common.RemoteHooks.convert2Dto(Attraction)); Attraction.remoteMethod( 'GetById', { description: 'Get a attraction by id', accepts: [ { arg: 'attractionId', type: 'string', required: true, http: { source: 'path' } } ], returns: { arg: 'attraction', type: 'object', root: true, }, http: { path: &quot;/:attractionId&quot;, verb: 'get', status: 200 } } ); //======================================================================================== /** * * @param {string | null} term Search term * @param {object} paging Like {skip: 0, limit: 10} * @param {HttpRequest} req * @param {HttpResponse} res * @param {Callback} cb * @returns {Promise} */ Attraction.Search = function (term, paging, req, res, cb) { cb = cb || promiseCallback(); var filter = paging; //type of argument is string so we test it by empty string if (term !== &quot;&quot;) { filter[&quot;where&quot;] = {name: {like: term, options: &quot;i&quot;}}; // i denotes insensitivity } Attraction.find(filter).then(crudHandler.successHandler(cb)).catch(crudHandler.failureHandler(cb)); return cb.promise; }; Attraction.beforeRemote(&quot;Search&quot;, Pagination.RemoteHooks.argumentWrapper(['term'])); /** * Refine pagination arg */ Attraction.beforeRemote(&quot;Search&quot;, Pagination.RemoteHooks.refinePaginationParams); Attraction.afterRemote(&quot;Search&quot;, Pagination.RemoteHooks.afterPaginatedService); Attraction.afterRemote('Search', Common.RemoteHooks.convert2Dto(Attraction)); Attraction.remoteMethod( 'Search', { description: 'Search in attractions', accepts: [ { arg: 'term', type: 'string', required: true, http: function (ctx) { var req = ctx.req; return (req.query &amp;&amp; req.query.term) ? req.query.term : &quot;&quot;; } }, { arg: 'paging', type: 'object', required: true, http: Pagination.Common.HttpPagingParam }, { arg: 'req', type: 'object', required: true, http: { source: 'req' } }, { arg: 'res', type: 'object', required: true, http: { source: 'res' } } ], returns: { arg: 'attraction', type: '[object]', root: true, }, http: { path: &quot;/search&quot;, verb: 'get', status: 200 } } ); //======================================================================================== Attraction.GetAll = function (paging, cb) { cb = cb || PromiseCallback(); var filter = paging; this.injectLangToFilter(filter); Attraction.find(filter).then(crudHandler.successHandler(cb)).catch(crudHandler.failureHandler(cb)); return cb.promise; }; /** * Refine pagination arg */ Attraction.beforeRemote(&quot;GetAll&quot;, Pagination.RemoteHooks.refinePaginationParams); Attraction.afterRemote(&quot;GetAll&quot;, Pagination.RemoteHooks.afterPaginatedService); Attraction.afterRemote(&quot;GetAll&quot;, Common.RemoteHooks.convert2Dto(Attraction)); Attraction.remoteMethod( 'GetAll', { description: 'Returns all `Attraction` instances based on input filtering', accepts: [ { arg: 'paging', type: 'object', required: true, http: Pagination.Common.HttpPagingParam, description: ['Calculated parameter.', 'In REST call should be like : `/attractions?limit=25&amp;skip=150`'] } ], returns: { arg: 'attractions', type: 'array', root: true, description: 'List of paginated `Attraction` instances' }, http: { path: &quot;/&quot;, verb: 'get', status: 200 } } ); } function definePictureStuff(Attraction) { /** * Module method for uploading one picture * @param {string} attractionId * @param {HttpContext} ctx * @param {Callback} cb * @returns {Promise} */ Attraction.UploadPicture = function (attractionId, ctx, cb) { cb = cb || promiseCallback(); Attraction.findById(attractionId).then(attractionFoundHandler).catch(attractionNotFoundHandler); return cb.promise; function attractionFoundHandler(attraction) { var options = {}; app.models.AttractionImageContainer.UploadPicture(attraction, ctx, options).then(uploadCompletedHandler).catch(uploadFailedHandler); function uploadCompletedHandler(result) { var pictures = result.db; //synced attraction.updateAttributes({pictures: pictures}).then(function (updatedAttraction) { var api = {}; api.url = `/attractions/${updatedAttraction.id}/pictures/${result.api[0].hash}`; api.styles = underscore.reduce(result.api[0].styles, function (memo, stylePack) { return underscore.extend(memo, stylePack.style); }, {}); cb(null, api); }).catch(uploadFailedHandler); } function uploadFailedHandler(err) { cb(err); } } function attractionNotFoundHandler(err) { cb(Persistency.Errors.NotFound()); } }; /** * Defines uploading picture service method as a REST API */ Attraction.remoteMethod(&quot;UploadPicture&quot;, { accepts: [ {arg: 'attractionId', type: 'string', http: {source: 'path'}}, {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'object', root: true }, http: {verb: 'post', status: 201, path: &quot;/:attractionId/picture&quot;} }); /** * Module method for uploading multiple pictures * @param {string} attractionId * @param {HttpContext} ctx * @param {Callback} cb * @returns {Promise} */ Attraction.UploadPictureAll = function (attractionId, ctx, cb) { cb = cb || promiseCallback(); Attraction.findById(attractionId).then(attractionFoundHandler).catch(attractionNotFoundHandler); return cb.promise; function attractionFoundHandler(attraction) { var options = {}; app.models.AttractionImageContainer.UploadPictureAll(attraction, ctx, options).then(uploadCompletedHandler).catch(uploadFailedHandler); function uploadCompletedHandler(result) { var pictures = result.db; //synced attraction.updateAttributes({pictures: pictures}).then(function (updatedattraction) { var apiArr = []; underscore.each(result.api, function (filePack) { var api = {}; api.url = `/attractions/${updatedattraction.id}/pictures/${filePack.hash}`; api.styles = underscore.reduce(filePack.styles, function (memo, stylePack) { return underscore.extend(memo, stylePack.style); }, {}); apiArr.push(api); }); cb(null, apiArr); }).catch(uploadFailedHandler); } function uploadFailedHandler(err) { cb(err); } } function attractionNotFoundHandler(err) { cb(Persistency.Errors.NotFound()); } }; /** * Defines uploading picture service method as a REST API */ Attraction.remoteMethod(&quot;UploadPictureAll&quot;, { accepts: [ {arg: 'attractionId', type: 'string', http: {source: 'path'}}, {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'array', root: true }, http: {verb: 'post', status: 201, path: &quot;/:attractionId/pictures&quot;} }); /** * Module method for downloading attraction picture by its name * @param {string} id * @param {string} hash * @param style * @param {HttpContext} ctx * @param {Callback} cb * @returns {Promise} */ Attraction.DownloadPicture = function (id, hash, style, ctx, cb) { cb = cb || promiseCallback(); Attraction.findById(id).then(attractionFoundHandler).catch(attractionNotFoundHandler); return cb.promise; function attractionFoundHandler(attraction) { try { app.models.AttractionImageContainer.DownloadPicture(attraction, hash, style, ctx); } catch (ex) { cb(ex); } } function attractionNotFoundHandler(err) { cb(err); } }; /** * Defines uploading picture service method as a REST API */ Attraction.remoteMethod(&quot;DownloadPicture&quot;, { accepts: [ {arg: 'id', type: 'string', required: true, http: {source: 'path'}}, {arg: 'hash', type: 'string', required: true, http: {source: 'path'}}, { arg: 'style', type: 'string', http: function (ctx) { var req = ctx.req; var query = req.query || {}; var style = query['style'] ? query['style'] : null; return style ? style.trim() : &quot;&quot;; } }, {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'object', root: true }, http: {verb: 'get', path: &quot;/:id/pictures/:hash&quot;} }); /** * Returns list of picture files * @param {string} attractionId * @param {HttpContext} ctx * @param {Callback} cb * @returns {Promise} */ Attraction.GetPictureList = function (attractionId, ctx, cb) { cb = cb || promiseCallback(); Attraction.findById(attractionId).then(attractionFoundHandler).catch(attractionNotFoundHandler); return cb.promise; function attractionFoundHandler(attraction) { if (!attraction) { return cb(Persistency.Errors.NotFound()); } try { var pictures = attraction.pictures; if (pictures) { var ret = app.models.Image.MakeFromDbArray(pictures); cb(null, ret); } else { cb(Persistency.Errors.NotFound()); } } catch (ex) { cb(ex); } } function attractionNotFoundHandler(err) { cb(err); } }; /** * Defines uploading picture service method as a REST API */ Attraction.remoteMethod(&quot;GetPictureList&quot;, { accepts: [ {arg: 'attractionId', type: 'string', http: {source: 'path'}}, {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'array', root: true }, http: {verb: 'get', path: &quot;/:attractionId/pictures&quot;} }); } × Search results Close "},"server_models_auth-token.js.html":{"id":"server_models_auth-token.js.html","title":"Source: server/models/auth-token.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/auth-token.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var uid = require('uid2'); var moment = require('moment'); var promiseCallback = require('narengi-utils').Common.PromiseCallback; var DEFAULT_TOKEN_LEN = 64; module.exports = function(AuthToken) { /** * Anonymous token used in ACL **/ AuthToken.ANONYMOUS = new AuthToken({ id: '$anonymous' }) /** * Creates a token as a hashed `string` **/ AuthToken.createToken = function(cb) { cb = cb || promiseCallback(); uid(DEFAULT_TOKEN_LEN, function(err, guid) { if (err) { cb(err); } else { cb(null, guid); } }); return cb.promise; }; /** * Checks if input `token` is expired or not. * Because `AuthToken` is not an entity, we can not define `prototype` methods **/ AuthToken.isExpired = function(token) { if (token) { return moment(token.updatedAt).add(token.ttl, 'm').isBefore(moment(), 'd'); } return false; }; }; × Search results Close "},"common_models_dto_base-dto.js.html":{"id":"common_models_dto_base-dto.js.html","title":"Source: common/models/dto/base-dto.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: common/models/dto/base-dto.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var underscore = require('underscore'); var loopback = require('loopback'); var app = serverRequire('server'); module.exports = function (BaseDTO) { /** * Convert an entity to corresponding DTO * @param {Model} entity * @param {object} EntityType * @param {object} options * @param {Context} options.ctx The remote method context. For example `ctx.req` is `HttpRequest` or `ctx.result` is the result of the method * @returns {object} */ BaseDTO.convert = function (entity, EntityType, options) { options = options || {}; var regEnum = app.RegistrationSourceEnum; var requestSource = regEnum.Mobile; var currentContext = options.currentContext; if (currentContext) { requestSource = currentContext.getReqSource(); } if (requestSource.is(regEnum.Mobile)) { if (underscore.isFunction(EntityType.convertForMobile)) return EntityType.convertForMobile(entity, EntityType, options); return BaseDTO.convertForMobile(...arguments); } if (underscore.isFunction(EntityType.convertForWeb)) return EntityType.convertForWeb(entity, EntityType, options); return BaseDTO.convertForWeb(...arguments); }; BaseDTO.convert_internal = function (entity, EntityType, options) { options = options || {}; var keys = underscore.keys(EntityType.definition.properties); if (options.skipId === true) { keys = underscore.filter(keys, function (key) { return key !== 'id'; }); } var params = underscore.pick(entity, keys); return params; }; BaseDTO.convertForMobile = BaseDTO.convert_internal; BaseDTO.convertForWeb = BaseDTO.convertForMobile; /** * Converts an array of entities to corresponding DTO`s * @param {array} entities * @param {object} options * @returns {Array} */ BaseDTO.ConvertArray = function (entities, options) { if (!entities) return []; options = options || {}; var self = this; return underscore.map(entities, function (entity) { return self.Convert(entity, options); }); }; }; × Search results Close "},"server_lib_messaging_lib_sms_kavenegar_service.js.html":{"id":"server_lib_messaging_lib_sms_kavenegar_service.js.html","title":"Source: server/lib/messaging/lib/sms/kavenegar/service.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/messaging/lib/sms/kavenegar/service.js &quot;use strict&quot;; // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // module.exports = exports; var debug = require('debug')('narengi-messaging:sms:kavenegar'); var underscore = require('underscore'); var request = require('request'); var Errors = require('narengi-messaging').SMS.Errors; var PromiseCallback = require('narengi-messaging').PromiseCallback; var SendOneResult = require('narengi-messaging').SMS.Results.SendOne; var defaults = { baseUrl: '', apikey: '', protocol: 'http', sender: null }; exports.Service = class { /** * * @param {Object} options Settings * @constructor * @public */ constructor(options) { options = options || {}; if (!options.apikey || !options.baseUrl) { debug('Kavenegar system settings is wrong'); throw new Errors.SystemDefinitionWrong(); } options = underscore.defaults(options, defaults); let baseUrl = `${options.protocol}://${options.baseUrl}/${options.apikey}`; this.request = request.defaults({ baseUrl: baseUrl }); this.options = options; } /** * @inheritDoc * @param {Object} packet * ``` * { * receiver: 'string. receiver number', * message: 'string. Encoded', * sender: 'string (optional). sender number', * date: 'string (optional). unix date', * type: 'integer (optional). ' * } * ``` * See @{link http://kavenegar.com/rest.html#result-msgmode|Send message types} * * @callback {Function}cb Callback function * @param {SMS.Errors.General} err * @param {SMS.Kavenegar.Result.SendOne} result * ``` * function(err, result){ * * } * ``` * @return {Promise} */ sendOne(sender, receiver, message, options, cb) { cb = cb || PromiseCallback(); let body = { receptor: receiver, message: message }; if (options.sender) { body.sender = options.sender; } if (sender) { body.sender = sender; } if (options.date) { body.date = options.date; } if (options.type) { body.type = options.type; } debug('Sending sms from %s to %s', body.sender, body.receptor); this.request.post({ url: '/sms/send.json', formData: body }, function (error, response, resBody) { if (error) { debug('error in sending request : %j', error); return cb(Errors.ParseInfrastructureError(error)); } resBody = JSON.parse(resBody); let result = {}; if (resBody) { if (resBody.return) { result.isSuccessful = resBody.return.status == 200; } if (underscore.isArray(resBody.entries)) { result.messageId = resBody.entries[0].messageid; result.sendDate = resBody.entries[0].date; } } result.extra = resBody; if (result.isSuccessful) { return cb(null, new SendOneResult(result)); } var ErrClass = Errors.SendError; var errParams = { errorKey: 'messaging.sms.kavenegar.402' }; if (resBody) { if (resBody.return) { errParams.status = resBody.return.status; errParams.statusText = resBody.return.message; } } if (errParams.status) { errParams.errorKey = `messaging.sms.kavenegar.${errParams.status}`; } cb(new ErrClass(errParams)); }); return cb.promise; } }; exports.ErrorDefTranslations = { &quot;messaging.sms.kavenegar.400&quot;: &quot;Wrong parameters&quot;, &quot;messaging.sms.kavenegar.401&quot;: &quot;Account suspended&quot;, &quot;messaging.sms.kavenegar.402&quot;: &quot;Operation failed&quot;, &quot;messaging.sms.kavenegar.403&quot;: &quot;Wrong ApiKey&quot;, &quot;messaging.sms.kavenegar.404&quot;: &quot;Unknown method&quot;, &quot;messaging.sms.kavenegar.405&quot;: &quot;Wrong method GET/POST&quot;, &quot;messaging.sms.kavenegar.406&quot;: &quot;Required fields are empty&quot;, &quot;messaging.sms.kavenegar.407&quot;: &quot;Access is denied&quot;, &quot;messaging.sms.kavenegar.409&quot;: &quot;Server is unresponsive&quot;, &quot;messaging.sms.kavenegar.411&quot;: &quot;Wrong receiver&quot;, &quot;messaging.sms.kavenegar.412&quot;: &quot;Wrong sender&quot;, &quot;messaging.sms.kavenegar.413&quot;: &quot;Message is empty overloaded&quot;, &quot;messaging.sms.kavenegar.414&quot;: &quot;Request volume is more than threshold&quot;, &quot;messaging.sms.kavenegar.415&quot;: &quot;&quot;, &quot;messaging.sms.kavenegar.417&quot;: &quot;Wrong date&quot;, &quot;messaging.sms.kavenegar.418&quot;: &quot;Charge is not enough&quot;, &quot;messaging.sms.kavenegar.419&quot;: &quot;Array of sender, receiver and messages are not equal&quot;, &quot;messaging.sms.kavenegar.422&quot;: &quot;Bad character in messages&quot;, &quot;messaging.sms.kavenegar.424&quot;: &quot;Pattern not found&quot;, &quot;messaging.sms.kavenegar.426&quot;: &quot;Not enough SLA&quot;, &quot;messaging.sms.kavenegar.431&quot;: &quot;Bad code structure&quot;, &quot;messaging.sms.kavenegar.432&quot;: &quot;Code not found in message&quot; }; × Search results Close "},"server_lib_utils_lib_security_remote-hooks.js.html":{"id":"server_lib_utils_lib_security_remote-hooks.js.html","title":"Source: server/lib/utils/lib/security/remote-hooks.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/utils/lib/security/remote-hooks.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var loopback = require('loopback'); var LoopBackContext = require('loopback-context'); var SecurityErrors = require('./errors'); var CommonErrors = require('narengi-utils').Errors; var Security = require('./security'); module.exports = exports; exports.checkCurrentUserIsAdmin = function (ctx, instance, next) { var ctx = ctx || LoopBackContext.getCurrentContext(); if (!ctx) { return next(CommonErrors.InternalError()); } var currentUser = ctx.get('currentUser'); if (!currentUser) { return next(SecurityErrors.NotAuthorized()); } Security.isUserAdmin(currentUser.username || currentUser.email).then(() =&gt; {next()}).catch((err) =&gt; {next(err)}); }; /** * Check if current user authenticated or not * @param {HttpContext} ctx * @param {Model} instance * @param {Callback} next */ exports.checkCurrentUserAuthorized = function (ctx, instance, next) { var ctx = ctx || LoopBackContext.getCurrentContext(); if (!ctx) { return next(CommonErrors.InternalError()); } var currentUser = ctx.get('currentUser'); if (!currentUser) { return next(SecurityErrors.NotAuthorized()); } next(); }; × Search results Close "},"server_lib_utils_lib_persistency_validations_remote-hooks_before_index.js.html":{"id":"server_lib_utils_lib_persistency_validations_remote-hooks_before_index.js.html","title":"Source: server/lib/utils/lib/persistency/validations/remote-hooks/before/index.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/utils/lib/persistency/validations/remote-hooks/before/index.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var loopback = require('loopback'); var Persistency = require('../../../index'); var underscore = require('underscore'); module.exports = exports; /** * Validate uniqueness of model based on keys * @param {string} modelName * @param {string} argName * @param {array} keys * @returns {Function} * @constructor */ exports.CheckUniqueness = function (modelName, argName, keys) { return function (ctx, instance, next) { var model = loopback.findModel(modelName); if (!model) { return next(Persistency.Errors.NotFound()); } keys = keys || []; if (keys.length == 0) { return next(); } var data = ctx.args[argName]; if (!data) { return next(); } var params = underscore.pick(data, keys); var def = {}; keys.forEach(function(item){ def[item] = null; }); params = underscore.defaults(params, def); model.count(params).then(countedHandler).catch((/*err*/) =&gt; { next(); }); function countedHandler(count) { if (count &gt; 0) { return next(Persistency.Validation.Errors.UniquenessViolation()); } next(); } }; }; × Search results Close "},"server_models_geo_city.js.html":{"id":"server_models_geo_city.js.html","title":"Source: server/models/geo/city.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/geo/city.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var loopback = require('loopback'); var underscore = require('underscore'); var string = require('string'); var commonBeforeRemotes = require('narengi-utils').Common.RemoteHooks; var app = serverRequire('server'); var promiseCallback = require('narengi-utils').Common.PromiseCallback; var crudHandler = require('narengi-utils').Persistency.CrudHandlers; var Persistency = require('narengi-utils').Persistency; var Errors = require('narengi-utils').Common.Errors; var Pagination = require('narengi-utils').Pagination; var Common = require('narengi-utils').Common; module.exports = function (City) { defineServices(City); definePictureStuff(City); }; /** * Before remote function to correct data sent from client * @param {HttpContext} ctx * @param {City} instance If update method called then this parameter is valid * @param {Callback} next */ function dataCorrector(ctx, instance, next) { var data = ctx.req.body; if (!data) { next(Errors.DataEmpty()); } var defaultForm = { &quot;name&quot;: &quot;&quot;, &quot;summary&quot;: &quot;&quot;, &quot;description&quot;: &quot;&quot; }; data = underscore.pick(data, underscore.keys(defaultForm)); ctx.req.body = data; next(); } /** * Main function for creating or updating `City` model * @param {string|null} cityId * @param {object} data * @param {Callback} cb * @returns {Promise} */ function createOrUpdateCity(cityId, data, cb) { if (cityId === null) { app.models.City.create(data).then(crudHandler.successHandler(cb)).catch(crudHandler.failureHandler(cb)); } else { app.models.City.findOne({ where: {id: cityId} }).then((city) =&gt; { if (!city) return cb(Persistency.Errors.NotFound()); city.updateAttributes(data).then(crudHandler.successHandler(cb)).catch(crudHandler.failureHandler(cb)); }).catch(crudHandler.failureHandler(cb)); } return cb.promise; } function defineServices(City) { /** * Creates a new `City` * @param {object} data * @param {Callback} cb * @returns {Promise} */ City.Create = function (data, cb) { cb = cb || promiseCallback(); return createOrUpdateCity(null, data, cb); }; City.beforeRemote('Create', commonBeforeRemotes.correctCaseOfKeys); City.beforeRemote('Create', dataCorrector); City.beforeRemote('Create', commonBeforeRemotes.correctRequestData); City.beforeRemote('Create', commonBeforeRemotes.injectLangToRequestData); City.afterRemote(&quot;Create&quot;, Common.RemoteHooks.convert2Dto(City)); City.remoteMethod( 'Create', { description: 'Creates a city.', accepts: [ { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], returns: { arg: 'city', type: 'object', root: true }, http: { path: &quot;/&quot;, verb: 'post', status: 201 } } ); //======================================================================================== /** * Updates a `City` * @param {string} cityId * @param {object} data * @param {Callback} cb * @returns {Promise} */ City.Update = function (cityId, data, cb) { cb = cb || promiseCallback(); return createOrUpdateCity(cityId, data, cb); }; City.beforeRemote('Update', commonBeforeRemotes.correctCaseOfKeys); City.beforeRemote('Update', dataCorrector); City.beforeRemote('Update', commonBeforeRemotes.correctRequestData); City.beforeRemote('Update', commonBeforeRemotes.injectLangToRequestData); City.afterRemote(&quot;Update&quot;, Common.RemoteHooks.convert2Dto(City)); City.remoteMethod( 'Update', { description: 'Updates a city.', accepts: [ { arg: 'cityId', type: 'string', required: true, http: { source: 'path' } }, { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], returns: { arg: 'city', type: 'object', root: true }, http: { path: &quot;/:cityId&quot;, verb: 'put', status: 201 } } ); //======================================================================================== /** * Deletes a `City` by its id * @param {string} cityId * @param {Callback} cb * @returns {Promise} */ City.DeleteOne = function (cityId, cb) { cb = cb || promiseCallback(); City.findOne({where: {id: cityId}}).then(function (city) { city.destroy().then(crudHandler.successHandler(cb)).catch(Errors.InternalError()); }).catch(() =&gt; { cb(Persistency.Errors.NotFound()); }); return cb.promise; }; City.remoteMethod( 'DeleteOne', { description: 'Deletes a city.', accepts: [ { arg: 'cityId', type: 'string', required: true, http: { source: 'path' } } ], http: { path: &quot;/:cityId&quot;, verb: 'delete', status: 204 } } ); //======================================================================================== /** * Fetch a `City` by its id * @param {string} cityId * @param {Callback} cb * @returns {Promise} */ City.GetById = function (cityId, cb) { cb = cb || promiseCallback(); City.findById(cityId).then((city) =&gt; { if (city) { return cb(null, city); } cb(Persistency.Errors.NotFound()); }).catch(crudHandler.failureHandler(cb)); return cb.promise; }; City.afterRemote(&quot;GetById&quot;, Common.RemoteHooks.convert2Dto(City)); City.remoteMethod( 'GetById', { description: 'Get a city by id', accepts: [ { arg: 'cityId', type: 'string', required: true, http: { source: 'path' } } ], returns: { arg: 'city', type: 'object', root: true, }, http: { path: &quot;/:cityId&quot;, verb: 'get', status: 200 } } ); //======================================================================================== /** * * @param {string | null} term Search term * @param {object} paging Like {skip: 0, limit: 10} * @param {HttpRequest} req * @param {HttpResponse} res * @param {Callback} cb * @returns {Promise} */ City.Search = function (term, paging, req, res, cb) { cb = cb || promiseCallback(); var filter = paging; //type of argument is string so we test it by empty string if (term !== &quot;&quot;) { filter[&quot;where&quot;] = {name: {like: term, options: &quot;i&quot;}}; // i denotes insensitivity } City.find(filter).then(crudHandler.successHandler(cb)).catch(crudHandler.failureHandler(cb)); return cb.promise; }; City.beforeRemote(&quot;Search&quot;, Pagination.RemoteHooks.argumentWrapper(['term'])); /** * Refine pagination arg */ City.beforeRemote(&quot;Search&quot;, Pagination.RemoteHooks.refinePaginationParams); City.afterRemote(&quot;Search&quot;, Pagination.RemoteHooks.afterPaginatedService); City.afterRemote(&quot;Search&quot;, Common.RemoteHooks.convert2Dto(City)); City.remoteMethod( 'Search', { description: 'Search in cities', accepts: [ { arg: 'term', type: 'string', required: true, http: function (ctx) { var req = ctx.req; return (req.query &amp;&amp; req.query.term) ? req.query.term : &quot;&quot;; } }, { arg: 'paging', type: 'object', required: true, http: Pagination.Common.HttpPagingParam } ], returns: { arg: 'city', type: '[object]', root: true }, http: { path: &quot;/search&quot;, verb: 'get', status: 200 } } ); //======================================================================================== City.GetAll = function (paging, cb) { cb = cb || PromiseCallback(); var filter = paging; this.injectLangToFilter(filter); City.find(filter).then(crudHandler.successHandler(cb)).catch(crudHandler.failureHandler(cb)); return cb.promise; }; /** * Refine pagination arg */ City.beforeRemote(&quot;GetAll&quot;, Pagination.RemoteHooks.refinePaginationParams); City.afterRemote(&quot;GetAll&quot;, Pagination.RemoteHooks.afterPaginatedService); City.afterRemote(&quot;GetAll&quot;, Common.RemoteHooks.convert2Dto(City)); City.remoteMethod( 'GetAll', { description: 'Returns all `City` instances based on input filtering', accepts: [ { arg: 'paging', type: 'object', required: true, http: Pagination.Common.HttpPagingParam, description: ['Calculated parameter.', 'In REST call should be like : `/cities?limit=25&amp;skip=150`'] } ], returns: { arg: 'cities', type: 'array', root: true, description: 'List of paginated `City` instances' }, http: { path: &quot;/&quot;, verb: 'get', status: 200 } } ); } function definePictureStuff(City) { /** * Module method for uploading one picture * @param {string} cityId * @param {HttpContext} ctx * @param {Callback} cb * @returns {Promise} */ City.UploadPicture = function (cityId, ctx, cb) { cb = cb || promiseCallback(); City.findById(cityId).then(cityFoundHandler).catch(cityNotFoundHandler); return cb.promise; function cityFoundHandler(city) { var options = {}; app.models.CityImageContainer.UploadPicture(city, ctx, options).then(uploadCompletedHandler).catch(uploadFailedHandler); function uploadCompletedHandler(result) { var pictures = result.db; //synced city.updateAttributes({pictures: pictures}).then(function (updatedCity) { var api = {}; api.url = `/cities/${updatedCity.id}/pictures/${result.api[0].hash}`; api.styles = underscore.reduce(result.api[0].styles, function (memo, stylePack) { return underscore.extend(memo, stylePack.style); }, {}); cb(null, api); }).catch(uploadFailedHandler); } function uploadFailedHandler(err) { cb(err); } } function cityNotFoundHandler(err) { cb(Persistency.Errors.NotFound()); } }; /** * Defines uploading picture service method as a REST API */ City.remoteMethod(&quot;UploadPicture&quot;, { accepts: [ {arg: 'cityId', type: 'string', http: {source: 'path'}}, {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'object', root: true }, http: {verb: 'post', status: 201, path: &quot;/:cityId/picture&quot;} }); /** * Module method for uploading multiple pictures * @param {string} cityId * @param {HttpContext} ctx * @param {Callback} cb * @returns {Promise} */ City.UploadPictureAll = function (cityId, ctx, cb) { cb = cb || promiseCallback(); City.findById(cityId).then(cityFoundHandler).catch(cityNotFoundHandler); return cb.promise; function cityFoundHandler(city) { var options = {}; app.models.CityImageContainer.UploadPictureAll(city, ctx, options).then(uploadCompletedHandler).catch(uploadFailedHandler); function uploadCompletedHandler(result) { var pictures = result.db; //synced city.updateAttributes({pictures: pictures}).then(function (updatedCity) { var apiArr = []; underscore.each(result.api, function (filePack) { var api = {}; api.url = `/cities/${updatedCity.id}/pictures/${filePack.hash}`; api.styles = underscore.reduce(filePack.styles, function (memo, stylePack) { return underscore.extend(memo, stylePack.style); }, {}); apiArr.push(api); }); cb(null, apiArr); }).catch(uploadFailedHandler); } function uploadFailedHandler(err) { cb(err); } } function cityNotFoundHandler(err) { cb(Persistency.Errors.NotFound()); } }; /** * Defines uploading picture service method as a REST API */ City.remoteMethod(&quot;UploadPictureAll&quot;, { accepts: [ {arg: 'cityId', type: 'string', http: {source: 'path'}}, {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'array', root: true }, http: {verb: 'post', status: 201, path: &quot;/:cityId/pictures&quot;} }); /** * Module method for downloading city picture by its name * @param {string} id * @param {string} hash * @param style * @param {HttpContext} ctx * @param {Callback} cb * @returns {Promise} */ City.DownloadPicture = function (id, hash, style, ctx, cb) { cb = cb || promiseCallback(); City.findById(id).then(cityFoundHandler).catch(cityNotFoundHandler); return cb.promise; function cityFoundHandler(city) { try { app.models.CityImageContainer.DownloadPicture(city, hash, style, ctx); } catch (ex) { cb(ex); } } function cityNotFoundHandler(err) { cb(err); } }; /** * Defines uploading picture service method as a REST API */ City.remoteMethod(&quot;DownloadPicture&quot;, { accepts: [ {arg: 'id', type: 'string', required: true, http: {source: 'path'}}, {arg: 'hash', type: 'string', required: true, http: {source: 'path'}}, { arg: 'style', type: 'string', http: function (ctx) { var req = ctx.req; var query = req.query || {}; var style = query['style'] ? query['style'] : null; return style ? style.trim() : &quot;&quot;; } }, {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'object', root: true }, http: {verb: 'get', path: &quot;/:id/pictures/:hash&quot;} }); /** * Returns list of picture files * @param {string} cityId * @param {HttpContext} ctx * @param {Callback} cb * @returns {Promise} */ City.GetPictureList = function (cityId, ctx, cb) { cb = cb || promiseCallback(); City.findById(cityId).then(cityFoundHandler).catch(cityNotFoundHandler); return cb.promise; function cityFoundHandler(city) { if (!city) { return cb(Persistency.Errors.NotFound()); } try { var pictures = city.pictures; if (pictures) { var ret = app.models.Image.MakeFromDbArray(pictures); cb(null, ret); } else { cb(Persistency.Errors.NotFound()); } } catch (ex) { cb(ex); } } function cityNotFoundHandler(err) { cb(err); } }; /** * Defines uploading picture service method as a REST API */ City.remoteMethod(&quot;GetPictureList&quot;, { accepts: [ {arg: 'cityId', type: 'string', http: {source: 'path'}}, {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'array', root: true }, http: {verb: 'get', path: &quot;/:cityId/pictures&quot;} }); } × Search results Close "},"server_lib_http-context_context.js.html":{"id":"server_lib_http-context_context.js.html","title":"Source: server/lib/http-context/context.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/http-context/context.js 'use strict'; // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // /** * @class Context * @memberOf http-context */ var Context = class { constructor(name) { this.name = name; this.user = null; this.token = null; this.locale = null; this.reqSource = null; } /** * * @param name * @returns {http-context.Context} * @static */ static CreateContext(name) { return new Context(name); } setUser(user) { this.user = user; } getUser() { return this.user; } setToken(token) { this.token = token; } setReqSource(source) { this.reqSource = source; } getReqSource() { return this.reqSource; } setLocale(locale) { this.locale = locale; } getLocale() { return this.locale; } }; module.exports = Context; × Search results Close "},"server_models_house_house-cancellation-policy.js.html":{"id":"server_models_house_house-cancellation-policy.js.html","title":"Source: server/models/house/house-cancellation-policy.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/house/house-cancellation-policy.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var Common = require('narengi-utils').Common; var Persistency = require('narengi-utils').Persistency; var app = serverRequire('server'); var underscore = require('underscore'); module.exports = function (HouseCancellationPolicy) { defineServices(HouseCancellationPolicy); defineRemoteMethods(HouseCancellationPolicy); }; /** * Create or update `HouseCancellationPolicy` * @param {Model} HouseCancellationPolicy * @param {string} id * @param {object} data * @param {Callback} cb */ function createOrUpdate(HouseCancellationPolicy, id, data, cb) { data.explanation = Persistency.Models.HouseCancellationPolicy.Explanation.Create(data.explanation); if (id === null) { HouseCancellationPolicy.create(data).then(Persistency.CrudHandlers.successHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); } else { HouseCancellationPolicy.findOne({ where: {id: id} }).then((entity) =&gt; { if (!entity) return cb(Persistency.Error.NotFound()); entity.updateAttributes(data).then(Persistency.CrudHandlers.successHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); }).catch(Persistency.CrudHandlers.failureHandler(cb)); } } function defineServices(HouseCancellationPolicy) { /** * Create `HouseCancellationPolicy` instance in storage. * @param {object} data * @param {Callback} cb * @returns {Promise} */ HouseCancellationPolicy.Create = function (data, cb) { cb = cb || Common.PromiseCallback(); createOrUpdate(HouseCancellationPolicy, null, data, cb); return cb.promise; }; /** * Update `HouseCancellationPolicy` instance * @param {string} id * @param {object} data * @param {Callback} cb * @returns {Promise} */ HouseCancellationPolicy.Update = function (id, data, cb) { cb = cb || Common.PromiseCallback(); createOrUpdate(HouseCancellationPolicy, id, data, cb); return cb.promise; }; /** * Returns all house cancellation policy. * @param {Callback} cb * @returns {Promise} */ HouseCancellationPolicy.GetAll = function (cb) { cb = cb || Common.PromiseCallback(); HouseCancellationPolicy.find({ where: {lang: app.currentLocale} }).then((entities) =&gt; { if (!entities) return cb(Persistency.Errors.NotFound()); entities = underscore.sortBy(entities, 'order'); cb(null, entities); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; /** * Returns policy by id * @param {string} id * @param {Callback} cb * @returns {Promise} */ HouseCancellationPolicy.GetById = function (id, cb) { cb = cb || Common.PromiseCallback(); HouseCancellationPolicy.findById(id).then((entity) =&gt; { if (!entity) return cb(Persistency.Errors.NotFound()); cb(null, entity); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; /** * Deletes policy instance by its id. * @param {string} id * @param {Callback} cb * @returns {Promise} */ HouseCancellationPolicy.DeleteById = function (id, cb) { cb = cb || Common.PromiseCallback(); HouseCancellationPolicy.destroyById(id).then(Persistency.CrudHandlers.successHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; } function defineRemoteMethods(HouseCancellationPolicy) { HouseCancellationPolicy.remoteMethod( 'Create', { description: 'Creates a cancellation policy', accepts: [ { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], returns: { arg: 'houseCancellationPolicy', type: 'object', root: true }, http: { path: &quot;/&quot;, verb: 'post', status: 201 } } ); HouseCancellationPolicy.beforeRemote('Create', Common.RemoteHooks.argShouldNotEmpty(&quot;data&quot;)); HouseCancellationPolicy.beforeRemote('Create', Common.RemoteHooks.correctCaseOfKeysInArg(&quot;data&quot;, &quot;HouseCancellationPolicy&quot;)); HouseCancellationPolicy.beforeRemote('Create', Common.RemoteHooks.dataOwnerCorrectorInArg(&quot;data&quot;, &quot;HouseCancellationPolicy&quot;)); HouseCancellationPolicy.beforeRemote('Create', Common.RemoteHooks.injectLangToRequestData); HouseCancellationPolicy.afterRemote(&quot;Create&quot;, Common.RemoteHooks.convert2Dto(HouseCancellationPolicy, {skipId: true})); //======================================================================================== HouseCancellationPolicy.remoteMethod( 'Update', { description: 'Updates a cancellation policy', accepts: [ { arg: 'id', type: 'string', required: true, http: { source: 'path' } }, { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], http: { path: &quot;/:id&quot;, verb: 'put', status: 204 } } ); HouseCancellationPolicy.beforeRemote('Update', Common.RemoteHooks.argShouldNotEmpty(&quot;data&quot;)); HouseCancellationPolicy.beforeRemote('Update', Common.RemoteHooks.correctCaseOfKeysInArg(&quot;data&quot;, &quot;HouseCancellationPolicy&quot;)); HouseCancellationPolicy.beforeRemote('Update', Common.RemoteHooks.dataOwnerCorrectorInArg(&quot;data&quot;, &quot;HouseCancellationPolicy&quot;)); HouseCancellationPolicy.beforeRemote('Update', Common.RemoteHooks.injectLangToRequestData); //======================================================================================== HouseCancellationPolicy.remoteMethod( 'GetAll', { description: 'Returns all cancellation policy', returns: { arg: 'policies', type: 'array', root: true }, http: { path: &quot;/&quot;, verb: 'get', status: 200 } } ); HouseCancellationPolicy.afterRemote(&quot;GetAll&quot;, Common.RemoteHooks.convert2Dto(HouseCancellationPolicy, {skipId: false})); //======================================================================================== HouseCancellationPolicy.remoteMethod( 'GetById', { description: 'Returns a cancellation policy by id', accepts: [ { arg: 'id', type: 'string', required: true, http: { source: 'path' } } ], returns: { arg: 'policy', type: 'HouseCancellationPolicyDTO', root: true }, http: { path: &quot;/:id&quot;, verb: 'get', status: 200 } } ); HouseCancellationPolicy.afterRemote(&quot;GetById&quot;, Common.RemoteHooks.convert2Dto(HouseCancellationPolicy, {skipId: false})); //======================================================================================== HouseCancellationPolicy.remoteMethod( 'DeleteById', { description: 'Deletes a cancellation policy by id', accepts: [ { arg: 'id', type: 'string', required: true, http: { source: 'path' } } ], http: { path: &quot;/:id&quot;, verb: 'delete', status: 204 } } ); } × Search results Close "},"server_models_house_house-feature.js.html":{"id":"server_models_house_house-feature.js.html","title":"Source: server/models/house/house-feature.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/house/house-feature.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var Common = require('narengi-utils').Common; var Pagination = require('narengi-utils').Pagination; var Persistency = require('narengi-utils').Persistency; var app = serverRequire('server'); var underscore = require('underscore'); var loopback = require('loopback'); module.exports = function (HouseFeature) { defineServices(HouseFeature); }; /** * Before remote function to correct data sent from client * @param {HttpContext} ctx * @param {House} instance If update method called then this parameter is valid * @param {Callback} next */ function dataCorrector(ctx, instance, next) { var data = ctx.req.body; if (!data) { next(Common.Errors.DataEmpty()); } var defaultForm = { &quot;key&quot;: &quot;&quot;, &quot;title&quot;: &quot;&quot;, &quot;description&quot;: &quot;&quot; }; data = underscore.pick(data, underscore.keys(defaultForm)); ctx.req.body = data; next(); } /** * Main function for creating or updating `HouseFeature` model * @param {string|null} houseFeatureId * @param {object} data * @param {Callback} cb * @returns {Promise} */ function createOrUpdateHouseFeature(houseFeatureId, data, cb) { if (houseFeatureId === null) { app.models.HouseFeature.create(data).then(Persistency.CrudHandlers.successHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); } else { app.models.HouseFeature.findOne({ where: {id: houseFeatureId} }).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); house.updateAttributes(data).then(Persistency.CrudHandlers.successHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); }).catch(Persistency.CrudHandlers.failureHandler(cb)); } return cb.promise; } /** * Add services to `HouseFeature` * @param {Model} HouseFeature */ function defineServices(HouseFeature) { /** * Creates a new `HouseFeature` * @param {object} data * @param {Callback} cb * @returns {Promise} */ HouseFeature.Create = function (data, cb) { cb = cb || Common.PromiseCallback(); return createOrUpdateHouseFeature(null, data, cb); }; HouseFeature.beforeRemote('Create', Common.RemoteHooks.correctCaseOfKeys); HouseFeature.beforeRemote('Create', dataCorrector); HouseFeature.beforeRemote('Create', Common.RemoteHooks.correctRequestData); HouseFeature.beforeRemote('Create', Common.RemoteHooks.injectLangToRequestData); HouseFeature.beforeRemote('Create', Persistency.Validation.RemoteHooks.Before.CheckUniqueness(HouseFeature.definition.name, &quot;data&quot;, [&quot;lang&quot;, &quot;key&quot;])); HouseFeature.afterRemote(&quot;Create&quot;, Common.RemoteHooks.convert2Dto(HouseFeature)); HouseFeature.remoteMethod( 'Create', { description: 'Creates a house feature.', accepts: [ { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], returns: { arg: 'houseFeature', type: 'object', root: true }, http: { path: &quot;/&quot;, verb: 'post', status: 201 } } ); //======================================================================================== /** * Updates a `HouseFeature` * @param {string} id * @param {object} data * @param {Callback} cb * @returns {Promise} */ HouseFeature.Update = function (id, data, cb) { cb = cb || Common.PromiseCallback(); return createOrUpdateHouseFeature(id, data, cb); }; HouseFeature.beforeRemote('Update', Common.RemoteHooks.correctCaseOfKeys); HouseFeature.beforeRemote('Update', dataCorrector); HouseFeature.beforeRemote('Update', Common.RemoteHooks.correctRequestData); HouseFeature.beforeRemote('Update', Common.RemoteHooks.injectLangToRequestData); HouseFeature.afterRemote(&quot;Update&quot;, Common.RemoteHooks.convert2Dto(HouseFeature)); HouseFeature.remoteMethod( 'Update', { description: 'Updates a house feature.', accepts: [ { arg: 'id', type: 'string', required: true, http: { source: 'path' } }, { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], returns: { arg: 'houseFeature', type: 'object', root: true }, http: { path: &quot;/:id&quot;, verb: 'put', status: 204 } } ); //======================================================================================== /** * Deletes a `HouseFeature` by its id * @param {string} id * @param {Callback} cb * @returns {Promise} */ HouseFeature.DeleteOne = function (id, cb) { cb = cb || Common.PromiseCallback(); HouseFeature.findOne({where: {id: id}}).then(function (house) { house.destroy().then(Persistency.CrudHandlers.successHandler(cb)).catch(Common.Errors.InternalError()); }).catch(() =&gt; { cb(Persistency.Errors.NotFound()); }); return cb.promise; }; HouseFeature.remoteMethod( 'DeleteOne', { description: 'Deletes a house feature.', accepts: [ { arg: 'id', type: 'string', required: true, http: { source: 'path' } } ], http: { path: &quot;/:id&quot;, verb: 'delete', status: 204 } } ); //======================================================================================== /** * Fetch a `HouseFeature` by its id * @param {string} id * @param {Callback} cb * @returns {Promise} */ HouseFeature.GetById = function (id, cb) { cb = cb || Common.PromiseCallback(); HouseFeature.findById(id).then((house) =&gt; { if (house) { return cb(null, house); } cb(Persistency.Errors.NotFound()); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; HouseFeature.afterRemote(&quot;GetById&quot;, Common.RemoteHooks.convert2Dto(HouseFeature)); HouseFeature.remoteMethod( 'GetById', { description: 'Get a house feature by id', accepts: [ { arg: 'id', type: 'string', required: true, http: { source: 'path' } } ], returns: { arg: 'houseFeature', type: 'object', root: true }, http: { path: &quot;/:id&quot;, verb: 'get', status: 200 } } ); //======================================================================================== HouseFeature.GetByKey = function (key, lang, cb) { cb = cb || Common.PromiseCallback(); HouseFeature.findOne({ where: { lang: lang, key: key } }).then((feature) =&gt; { cb(null, feature); }).catch((err) =&gt; { cb(err); }); return cb.promise; }; //======================================================================================== HouseFeature.GetAll = function (paging, cb) { cb = cb || PromiseCallback(); var filter = paging; this.injectLangToFilter(filter); HouseFeature.find(filter).then(Persistency.CrudHandlers.successHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; /** * Refine pagination arg */ HouseFeature.beforeRemote(&quot;GetAll&quot;, Pagination.RemoteHooks.refinePaginationParams); HouseFeature.afterRemote(&quot;GetAll&quot;, Pagination.RemoteHooks.afterPaginatedService); HouseFeature.afterRemote(&quot;GetAll&quot;, Common.RemoteHooks.convert2Dto(HouseFeature)); HouseFeature.remoteMethod( 'GetAll', { description: 'Returns all `HouseFeature` instances based on input filtering', accepts: [ { arg: 'paging', type: 'object', required: true, http: Pagination.Common.HttpPagingParam, description: ['Calculated parameter.', 'In REST call should be like : `/house-features?limit=25&amp;skip=150`'] } ], returns: { arg: 'features', type: 'array', root: true, description: 'List of paginated `HouseFeature` instances' }, http: { path: &quot;/&quot;, verb: 'get', status: 200 } } ); } × Search results Close "},"server_models_house_house-type.js.html":{"id":"server_models_house_house-type.js.html","title":"Source: server/models/house/house-type.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/house/house-type.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var Common = require('narengi-utils').Common; var Pagination = require('narengi-utils').Pagination; var Persistency = require('narengi-utils').Persistency; var app = serverRequire('server'); var underscore = require('underscore'); var loopback = require('loopback'); module.exports = function (HouseType) { defineServices(HouseType); }; /** * Create or update `HouseType` based on inputs. * I `houseId` is null so it creates a new or, otherwise updates existing one. * @param {string} typeId * @param {object} data * @param {Callback} cb */ function createOrUpdateHouseType(typeId, data, cb) { if (typeId === null) { delete data[&quot;id&quot;]; } else { data.id = typeId; } app.models.HouseType.upsert(data, cb); return cb.promise; } function defineServices(HouseType) { /** * Creates a `HouseType`. * House type specifies how the house should be accommodated to guests. * @param {object} data * @param {Callback} cb */ HouseType.Create = function (data, cb) { cb = cb || Common.PromiseCallback(); return createOrUpdateHouseType(null, data, cb); }; HouseType.beforeRemote('Create', Common.RemoteHooks.argShouldNotEmpty('data')); HouseType.beforeRemote('Create', Common.RemoteHooks.correctCaseOfKeys); HouseType.beforeRemote('Create', Common.RemoteHooks.dataOwnerCorrectorInArg('data', 'HouseType')); HouseType.beforeRemote('Create', Common.RemoteHooks.injectLangToRequestData); HouseType.beforeRemote('Create', Persistency.Validation.RemoteHooks.Before.CheckUniqueness(&quot;HouseType&quot;, &quot;data&quot;, [&quot;lang&quot;, &quot;key&quot;])); HouseType.afterRemote(&quot;Create&quot;, Common.RemoteHooks.convert2Dto(HouseType)); HouseType.remoteMethod( 'Create', { description: 'Creates a house type.', accepts: [ {arg: 'data', type: 'object', required: true, http: {source: 'body'}} ], returns: {arg: 'houseType', type: 'HouseTypeDTO', root: true}, http: {path: &quot;/&quot;, verb: 'post', status: 201} } ); //======================================================================================== /** * Updates a `HouseType`. * House type specifies how the house should be accommodated to guests. * @param {string} id house type id * @param {object} data * @param {Callback} cb */ HouseType.Update = function (id, data, cb) { cb = cb || Common.PromiseCallback(); return createOrUpdateHouseType(id, data, cb); }; HouseType.beforeRemote('Update', Common.RemoteHooks.argShouldNotEmpty('data')); HouseType.beforeRemote('Update', Common.RemoteHooks.correctCaseOfKeys); HouseType.beforeRemote('Update', Common.RemoteHooks.dataOwnerCorrectorInArg('data', 'HouseType')); HouseType.beforeRemote('Update', Common.RemoteHooks.injectLangToRequestData); HouseType.beforeRemote('Update', Persistency.Validation.RemoteHooks.Before.CheckUniqueness(&quot;HouseType&quot;, &quot;data&quot;, [&quot;lang&quot;, &quot;key&quot;])); HouseType.afterRemote(&quot;Update&quot;, Common.RemoteHooks.convert2Dto(HouseType)); HouseType.remoteMethod( 'Update', { description: 'Updates a house type.', accepts: [ {arg: 'id', type: 'string', required: true, http: {source: 'path'}}, {arg: 'data', type: 'object', required: true, http: {source: 'body'}} ], returns: {arg: 'houseType', type: 'HouseTypeDTO', root: true}, http: {path: &quot;/:id&quot;, verb: 'put', status: 204} } ); //======================================================================================== /** * Retrieves `HouseType` by its id * @param {string} id * @param {Callback} cb */ HouseType.GetById = function (id, cb) { cb = cb || Common.PromiseCallback(); HouseType.findById(id).then(Persistency.CrudHandlers.successHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; HouseType.afterRemote(&quot;GetById&quot;, Common.RemoteHooks.convert2Dto(HouseType)); HouseType.remoteMethod( 'GetById', { description: 'Retrieves a house type.', accepts: [ {arg: 'id', type: 'string', required: true, http: {source: 'path'}} ], returns: {arg: 'houseType', type: 'HouseTypeDTO', root: true}, http: {path: &quot;/:id&quot;, verb: 'get', status: 200} } ); //======================================================================================== /** * Retrieves all `HouseType`s * @param {Pagination} paging * @param {Callback} cb */ HouseType.GetAll = function (paging, cb) { cb = cb || Common.PromiseCallback(); HouseType.find(paging).then(Persistency.CrudHandlers.arraySuccessHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; /** * Refine pagination arg */ HouseType.beforeRemote(&quot;GetAll&quot;, Pagination.RemoteHooks.refinePaginationParams); HouseType.afterRemote(&quot;GetAll&quot;, Pagination.RemoteHooks.afterPaginatedService); HouseType.remoteMethod( 'GetAll', { description: 'Retrieves al house types.', accepts: [ { arg: 'paging', type: 'object', required: true, http: Pagination.Common.HttpPagingParam } ], returns: {arg: 'houseType', type: 'array', root: true}, http: {path: &quot;/&quot;, verb: 'get', status: 200} } ); //======================================================================================== /** * Deletes a `HouseType` by its id. * @param {string} id * @param {Callback} cb */ HouseType.DeleteById = function (id, cb) { cb = cb || Common.PromiseCallback(); HouseType.destroyById(id, (err) =&gt; { if (err) return cb(err); cb(null); }); return cb.promsie; }; HouseType.remoteMethod( 'DeleteById', { description: 'Deletes a house type.', accepts: [ {arg: 'id', type: 'string', required: true, http: {source: 'path'}} ], http: {path: &quot;/:id&quot;, verb: 'delete', status: 204} } ); } × Search results Close "},"server_models_financial-profile.js.html":{"id":"server_models_financial-profile.js.html","title":"Source: server/models/financial-profile.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/financial-profile.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var loopback = require('loopback'); var LoopBackContext = require('loopback-context'); var app = serverRequire('server'); var underscore = require('underscore'); var Common = require('narengi-utils').Common; var promiseCallback = require('narengi-utils').Common.PromiseCallback; var Persistency = require('narengi-utils').Persistency; var Security = require('narengi-utils').Security; module.exports = function (FinancialProfile) { defineServices(FinancialProfile); addHooks(FinancialProfile); defineRemoteMethods(FinancialProfile); defineAdminServices(FinancialProfile); addAdminHooks(FinancialProfile); defineAdminRemoteMethods(FinancialProfile); }; /** * Method for creating current user profile; */ function createProfile(userId, data, cb) { cb = cb || promiseCallback(); var promise = app.models.Person.GetByAccountId(userId); promise.then(createProfileHandler(data, cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; } /** * Creates an `FinancialProfile` after finding `Person` * This function is for handling callbacks from calling CRUD methods of `loopback' */ function createProfileHandler(data, cb) { return function (person) { cb = cb || promiseCallback(); if (!person) { cb(Persistency.Errors.NotFound()); return; } if (person.financialProfile.value()) { return cb(Persistency.Errors.Existed()); } person.financialProfile.create(data, function (err, profile) { if (err) { return cb(err); } cb(null, profile); }); return cb.promise; } } /** * Method for updating current user profile; */ function updateProfile(userId, data, cb) { cb = cb || promiseCallback(); var promise = app.models.Person.GetByAccountId(userId); promise.then(updateProfileHandler(data, cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; } /** * Creates or updates an `FinancialProfile` after finding `Person` * This function is for handling callbacks from calling CRUD methods of `loopback' */ function updateProfileHandler(data, cb) { return function (person) { cb = cb || promiseCallback(); if (!person) { cb(Persistency.Errors.NotFound()); return; } if (!person.financialProfile.value()) { return cb(Persistency.Errors.NotFound()); } person.financialProfile.update(data, function (err, profile) { if (err) { return cb(err); } cb(null, profile); }); return cb.promise; } } function addHooks(FinancialProfile) { var defaultForm = { currency: app.settings.currency.default }; FinancialProfile.beforeRemote('CreateProfile', Security.RemoteHooks.checkCurrentUserAuthorized); FinancialProfile.beforeRemote('CreateProfile', Common.RemoteHooks.correctCaseOfKeys); FinancialProfile.beforeRemote('CreateProfile', Common.RemoteHooks.dataOwnerCorrector(defaultForm)); FinancialProfile.beforeRemote('CreateProfile', Common.RemoteHooks.correctRequestData); FinancialProfile.beforeRemote('UpdateProfile', Security.RemoteHooks.checkCurrentUserAuthorized); FinancialProfile.beforeRemote('UpdateProfile', Common.RemoteHooks.correctCaseOfKeys); FinancialProfile.beforeRemote('UpdateProfile', Common.RemoteHooks.dataOwnerCorrector(defaultForm)); FinancialProfile.beforeRemote('UpdateProfile', Common.RemoteHooks.correctRequestData); } function defineServices(FinancialProfile) { /** * Creates `FinancialProfile` for current `Person` * @param {object} data * @param {Callback} cb */ FinancialProfile.CreateProfile = function (data, cb) { var ctx = LoopBackContext.getCurrentContext(); var currentUser = ctx.get('currentUser'); return createProfile(currentUser.id, data, cb); }; /** * Updates `FinancialProfile` for current `Person` * @param {object} data * @param {Callback} cb */ FinancialProfile.UpdateProfile = function (data, cb) { var ctx = LoopBackContext.getCurrentContext(); var currentUser = ctx.get('currentUser'); return updateProfile(currentUser.id, data, cb); }; } function defineRemoteMethods(FinancialProfile) { FinancialProfile.remoteMethod( 'CreateProfile', { description: 'Creates an financial profile.', accepts: [ { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], http: { path: &quot;/&quot;, verb: 'post', status: 201 } } ); FinancialProfile.remoteMethod( 'UpdateProfile', { description: 'Updates an financial profile.', accepts: [ { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], http: { path: &quot;/&quot;, verb: 'put', status: 204 } } ); } /** * Adds create-update user profile by admin capability * @param FinancialProfile */ function defineAdminServices(FinancialProfile) { /** * Creates `FinancialProfile` for current `Person` by admin * @param {object} data * @param {Callback} cb */ FinancialProfile.CreateProfileByAdmin = function (userId, data, cb) { return createProfile(userId, data, cb); }; /** * Updates `FinancialProfile` for current `Person` by admin * @param {object} data * @param {Callback} cb */ FinancialProfile.UpdateProfileByAdmin = function (userId, data, cb) { return updateProfile(userId, data, cb); }; } function addAdminHooks(FinancialProfile) { var defaultForm = { currency: app.settings.currency.default }; FinancialProfile.beforeRemote('CreateProfileByAdmin', Security.RemoteHooks.checkCurrentUserIsAdmin); FinancialProfile.beforeRemote('CreateProfileByAdmin', Common.RemoteHooks.correctCaseOfKeys); FinancialProfile.beforeRemote('CreateProfileByAdmin', Common.RemoteHooks.dataOwnerCorrector(defaultForm)); FinancialProfile.beforeRemote('CreateProfileByAdmin', Common.RemoteHooks.correctRequestData); FinancialProfile.beforeRemote('UpdateProfileByAdmin', Security.RemoteHooks.checkCurrentUserIsAdmin); FinancialProfile.beforeRemote('UpdateProfileByAdmin', Common.RemoteHooks.correctCaseOfKeys); FinancialProfile.beforeRemote('UpdateProfileByAdmin', Common.RemoteHooks.dataOwnerCorrector(defaultForm)); FinancialProfile.beforeRemote('UpdateProfileByAdmin', Common.RemoteHooks.correctRequestData); } function defineAdminRemoteMethods(FinancialProfile) { FinancialProfile.remoteMethod( 'CreateProfileByAdmin', { description: 'Creates an financial profile by admin.', accepts: [ { arg: 'userId', type: 'string', required: true, http: { source: 'path' } }, { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], http: { path: &quot;/:userId&quot;, verb: 'post', status: 201 } } ); FinancialProfile.remoteMethod( 'UpdateProfileByAdmin', { description: 'Updates an financial profile by admin.', accepts: [ { arg: 'userId', type: 'string', required: true, http: { source: 'path' } }, { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], http: { path: &quot;/:userId&quot;, verb: 'put', status: 204 } } ); } × Search results Close "},"server_lib_messaging_lib_push_index.js.html":{"id":"server_lib_messaging_lib_push_index.js.html","title":"Source: server/lib/messaging/lib/push/index.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/messaging/lib/push/index.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // module.exports = exports; exports.Errors = require('./errors'); var ServiceClass = require('./service').Service; /** * Creates a service proxying destination PN system * @param {Object} options */ exports.CreateService = function(options){ options = options || {}; if(!options.deviceType) throw new exports.Errors.SystemDefinitionWrong(); var osTypeClass = null; if(options.deviceType.toLowerCase() === 'android'){ osTypeClass = require('./gcm').Service; } else if(options.deviceType.toLowerCase() === 'ios'){ osTypeClass = require('./apn').Service; } if(osTypeClass){ return new ServiceClass(new osTypeClass(options), options.deviceType); } throw new exports.Errors.NotImplemented(); }; × Search results Close "},"server_models_settings_currency.js.html":{"id":"server_models_settings_currency.js.html","title":"Source: server/models/settings/currency.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/settings/currency.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var Enum = require('enum'); var app = serverRequire('server'); var underscore = require('underscore'); var money = require('money'); var Common = require('narengi-utils').Common; /** * `Currency` model is a wrapper around an `Enum` object as `CurrencyEnum` * @param Currency */ module.exports = function (Currency) { defineEnum(Currency); defineServices(Currency); }; function defineEnum(Currency) { //just currencies defined in system configuration var currencyList = app.settings.currency.available; var currencyMap = underscore.object(currencyList, currencyList); var currencyEnum = new Enum( currencyMap , { name: &quot;CurrencyEnum&quot;, ignoreCase: true, freez: true } ); Object.defineProperty(Currency, &quot;CurrencyEnum&quot;, { get: function () { return currencyEnum; } }, { enumerable: true }); Object.defineProperty(Currency, &quot;Default&quot;, { get: function () { return currencyEnum.get(app.settings.currency.default); } }, { enumerable: false, configurable: false, writable: false }); } function defineServices(Currency) { /** * Returns `Enum` object corresponding `currency` input. * @param {string} currency * @returns {Enum} */ Currency.Get = function (currency) { return Currency.CurrencyEnum.get(currency); }; /** * Returns all currencies defined in system. * @param {Callback} cb * @returns {Promise} */ Currency.GetAll = function (cb) { cb = cb || Common.PromiseCallback(); cb(null, Currency.CurrencyEnum.toJSON()); return cb.promise; }; Currency.remoteMethod( 'GetAll', { description: 'Get all currencies as an object.', returns: { arg: 'currencies', type: 'object', root: true }, http: { path: &quot;/&quot;, verb: 'get', status: 200 } } ); } × Search results Close "},"server_lib_utils_lib_common_dates.js.html":{"id":"server_lib_utils_lib_common_dates.js.html","title":"Source: server/lib/utils/lib/common/dates.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/utils/lib/common/dates.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var moment = require('moment'); var underscore = require('underscore'); module.exports = exports; /** * Creates an array consisting of dates from `startDate` to `endDate`. * @param {string|Date} startDate * @param {string|Date} endDate * @param {object} options * ``` * { * stringDate: {boolean} If true, each date representing date format string, else JS Date object * } * ``` * @returns {Array} */ exports.DateRange = function (startDate, endDate, options) { options = options || {}; var stringDate = options.hasOwnProperty(&quot;stringDate&quot;) ? options.stringDate : true; startDate = moment.utc(startDate); endDate = moment.utc(endDate); var dates = []; var currentDate = startDate.clone(); while (!currentDate.isAfter(endDate, 'd')) { if (stringDate) dates.push(currentDate.format(&quot;YYYY-MM-DD&quot;)); else dates.push(currentDate.toDate()); currentDate = currentDate.add(1, 'd'); } dates = underscore.uniq(dates); return dates; }; /** * Normalize dates in array. * @param {array} dates Containing strings representing dates. * @param {object} options * ``` * { * stringDate: true|false, //If true, each date representing date format string, else JS Date object * format: {string}, //date format * sort: true|false * } * ``` * @returns {array} Normalized dates */ exports.Normalize = function (dates, options) { options = options || {}; dates = dates || []; var format = options.hasOwnProperty(&quot;format&quot;) ? options.format : &quot;YYYY-MM-DD&quot;; var stringDate = options.hasOwnProperty(&quot;stringDate&quot;) ? options.stringDate : true; var sort = options.hasOwnProperty(&quot;sort&quot;) ? options.sort : false; dates = underscore.each(dates, function (item) { if (stringDate) item = moment.utc(item).format(format); else item = moment.utc(item).toDate(); }); dates = underscore.uniq(dates); if (sort) dates = underscore.sortBy(dates, function (item) { return moment.utc(item); }); return dates; }; × Search results Close "},"server_models_search_global-search.js.html":{"id":"server_models_search_global-search.js.html","title":"Source: server/models/search/global-search.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/search/global-search.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var app = serverRequire('server'); var loopback = require('loopback'); var promiseCallback = require('narengi-utils').Common.PromiseCallback; var async = require('async'); var underscore = require('underscore'); var Pagination = require('narengi-utils').Pagination; /** * This is main module for searching in the system * @param {Model} GlobalSearch */ module.exports = function (GlobalSearch) { defineMethods(GlobalSearch); defineGeneralServices(GlobalSearch); defineHooks(GlobalSearch); defineRemoteMethods(GlobalSearch); }; /** * Defines static methods * @param GlobalSearch */ function defineMethods(GlobalSearch) { GlobalSearch.count = function (where) { function countModel(Model, where, asyncCallback) { Model.count(where).then((result) =&gt; { asyncCallback(null, result); }).catch((err) =&gt; { asyncCallback(err); }); } return new Promise(function (resolve, reject) { async.parallel([ function (houseCb) { //do nothing currently houseCb(null, 0); }, function (attractionCb) { countModel(app.models.Attraction, where, attractionCb); }, function (cityCb) { countModel(app.models.City, where, cityCb); } ], function (err, result) { if (err) return reject(err); var sum = underscore.reduce(result, function (memo, num) { return memo + num; }, 0); resolve(sum); }); }); }; } /** * Add general services * @param GlobalSearch */ function defineGeneralServices(GlobalSearch) { function findInModel(Model, term, paging, req, res, asyncCallback) { Model.Search(term, paging, req, res).then((result) =&gt; { var ret = underscore.map(result, function (item) { return { Type: Model.definition.name, Data: item }; }); asyncCallback(null, ret); }).catch((err) =&gt; { asyncCallback(err); }); } /** * Search in 3 main models and paginate the results. * *Note* : At future we should add some filters like ranks of entities. * @param {string} term * @param {object} paging * @param {HttpResquest} req * @param {HttpResponse} res * @param {Callback} cb * @returns {Promise} */ GlobalSearch.Search = function (term, paging, req, res, cb) { cb = cb || promiseCallback(); if (paging.limit === 0) paging.limit = app.settings.pagination.globalSearch.limit; //because of 3 main models and union them if (paging.limit &lt; 3) paging.limit = 3; //not to interfere in pagination remote hook var pagingCloned = underscore.clone(paging); pagingCloned.limit = Math.floor(pagingCloned.limit / 3); async.parallel([ function (houseCb) { findInModel(app.models.House, term, pagingCloned, req, res, houseCb); }, function (attractionCb) { findInModel(app.models.Attraction, term, pagingCloned, req, res, attractionCb); }, function (cityCb) { findInModel(app.models.City, term, pagingCloned, req, res, cityCb); } ], function (err, result) { if (err) return cb(err); result = result || []; result = underscore.flatten(result); result = underscore.shuffle(result); cb(null, result); }); return cb.promise; }; } /** * Defines after/before remotes for global searching * @param {Model} GlobalSearch */ function defineHooks(GlobalSearch) { GlobalSearch.beforeRemote(&quot;Search&quot;, Pagination.RemoteHooks.argumentWrapper(['term'])); /** * Refine pagination arg */ GlobalSearch.beforeRemote(&quot;Search&quot;, Pagination.RemoteHooks.refinePaginationParams); GlobalSearch.afterRemote(&quot;Search&quot;, Pagination.RemoteHooks.afterPaginatedService); GlobalSearch.afterRemote(&quot;Search&quot;, function (ctx, instance, next) { var result = ctx.result; result = underscore.map(result, function (item) { var dtoModel = loopback.findModel(item.Type + &quot;DTO&quot;); var converted = dtoModel.Convert(item.Data, {}); return { Type: item.Type, Data: converted }; }); ctx.result = result; next(); }); } /** * Define API endpoints * @param GlobalSearch */ function defineRemoteMethods(GlobalSearch) { GlobalSearch.remoteMethod(&quot;Search&quot;, { description: &quot;Search in models&quot;, accepts: [ { arg: 'term', type: 'string', required: true, http: function (ctx) { var req = ctx.req; return (req.query &amp;&amp; req.query.term) ? req.query.term : &quot;&quot;; } }, { arg: 'paging', type: 'object', required: true, http: function (ctx) { var req = ctx.req; var query = req.query; var ret = {limit: 0, skip: 0}; if (!query || !query.filter) { return ret; } var filter = query.filter; if (filter.limit) { ret.limit = parseInt(filter.limit); } if (filter.skip) { ret.skip = parseInt(filter.skip); } return ret; } }, { arg: 'req', type: 'object', required: true, http: { source: 'req' } }, { arg: 'res', type: 'object', required: true, http: { source: 'res' } } ], returns: { arg: &quot;result&quot;, type: &quot;array&quot;, root: true }, http: { path: &quot;/&quot;, verb: &quot;get&quot;, status: 200 } }); } × Search results Close "},"server_lib_utils_lib_http_downloader.js.html":{"id":"server_lib_utils_lib_http_downloader.js.html","title":"Source: server/lib/utils/lib/http/downloader.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/utils/lib/http/downloader.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var nodeMime = require('mime'); var nodeFs = require('fs'); module.exports = exports; /** * Sends file in http response. * @param {HttpResponse} res * @param {string} filename filename to be sent to client * @param {string} filepath Absolute file path */ exports.download = function(res, filename, filepath){ var mimetype = nodeMime.lookup(filepath); res.setHeader('Content-disposition', 'attachment; filename=' + filename); res.setHeader('Content-type', mimetype); var filestream = nodeFs.createReadStream(filepath); filestream.pipe(res); }; × Search results Close "},"server_lib_utils_lib_persistency_models_house-cancellation-policy_explanation.js.html":{"id":"server_lib_utils_lib_persistency_models_house-cancellation-policy_explanation.js.html","title":"Source: server/lib/utils/lib/persistency/models/house-cancellation-policy/explanation.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/utils/lib/persistency/models/house-cancellation-policy/explanation.js &quot;use strict&quot;; // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var underscore = require('underscore'); module.exports = exports; var FIELDS = ['title', 'date', 'order', 'description']; /** * This class is part of house cancellation policy explaining the policy by sample. * @type {Explanation} * @class */ exports.Explanation = class Explanation { constructor(data) { this.title = &quot;&quot;; this.date = &quot;&quot;; this.order = 1; this.description = &quot;&quot;; if (underscore.isObject(data)) { var self = this; underscore.each(FIELDS, function (field) { if (underscore.has(data, field)) { self[field] = data[field]; } }); } } /** * Creates array or single object of `Explanation` type. * If `data` is nothing then `null` returned. * @param {array|object} data * @returns {array|object} */ static Create(data) { var ret = []; if (underscore.isArray(data)) { underscore.each(data, function (item) { ret.push(new Explanation(item)); }); } else if (underscore.isObject(data)) { ret = new Explanation(data); } else { return null; } return ret; } toJSON() { var ret = { title: this.title, date: this.date, order: this.order, description: this.description }; return ret; } toString() { return JSON.stringify(this.toJSON()); } }; × Search results Close "},"server_lib_utils_lib_file-system_core.js.html":{"id":"server_lib_utils_lib_file-system_core.js.html","title":"Source: server/lib/utils/lib/file-system/core.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/utils/lib/file-system/core.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var Common = require('narengi-utils').Common; var bluebird = require('bluebird'); var fs = require('fs'); var fsAccess = bluebird.promisify(fs.access); var fsMkdir = bluebird.promisify(require('fs-extra').mkdirs); var fsCopy = bluebird.promisify(require('fs-extra').copy); var fsMove = bluebird.promisify(require('fs-extra').move); var FsErrors = require('./errors'); module.exports = exports; function mkdirPath(path, mode) { return fsMkdir(path, mode); } /** * Check if path exists. If not then creates it. * @param {string} path * @param options * @public * @namespace FileSystem.Core */ exports.ensurePathExists = function (path, options) { var mode = &quot;0777&quot;; if (!options) { options = {}; } if (options.mode) { mode = options.mode; } return new Promise(function (resolve, reject) { function handleAccess(err) { if (err) { if (err.path) { mkdirPath(err.path, mode).then(() =&gt; { resolve(err.path); }).catch(() =&gt; { reject(FsErrors.NoAccess(err.path)); }); } } else { resolve(path); } }; fsAccess(path, fs.F_OK).then(handleAccess).catch(handleAccess); }); }; /** * Copies file or directory from source to destination * Proxies `fs-extra` module , `copy` function * @param {string} src * @param {string} dest * @param {object} options * @returns {Promise} * @public * @namespace FileSystem.Core */ exports.copy = function (src, dest, options) { options = options || {}; return fsCopy(src, dest, options); }; /** * Moves file or directory from source to destination * Proxies `fs-extra` module , `move` function * @param {string} src * @param {string} dest * @param {object} options * @returns {Promise} * @public * @namespace FileSystem.Core */ exports.move = function (src, dest, options) { options = options || {}; options[&quot;clobber&quot;] = true; return fsMove(src, dest, options); }; /** * Get size of input file * @param {String} filePath Absolute file path * @param {Function} cb Callback * @return {Promise} Resolving an object containing `file` and `size` * @public * @namespace FileSystem.Core */ exports.getSize = function (filePath, cb) { cb = cb || Common.PromiseCallback(); var fstat = bluebird.promisify(fs.stat); fstat(filePath).then((stat) =&gt; { if (!stat) return cb(new Error()); cb(null, { file: filePath, size: stat.size }); }).catch((err) =&gt; {cb(err);}); return cb.promise; }; × Search results Close "},"server_lib_messaging_lib_email_index.js.html":{"id":"server_lib_messaging_lib_email_index.js.html","title":"Source: server/lib/messaging/lib/email/index.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/messaging/lib/email/index.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // module.exports = exports; var TransporterClass = require('./transporter').Transporter; var instance = null; /** * * @options {Object} [options] Required * * @options {Object} [smtp] Required * @property {String} host Host name * @property {Integer} port * @property {Boolean} secure * @property {Boolean} pool * * @options {Object} [auth] * @property {String} user Username/Account * @property {String} pass Password * * @options {Object} engine * @options {Object} viewEngine Settings for handlebars view engine * &lt;br/&gt;See [Configuration](https://github.com/ericf/express-handlebars#configuration-and-defaults) * @property {String} extName Extension name of layout files * @property {String} layoutsDir * @property {String} defaultLayout * @property {String} partialsDir * * @property {String} viewPath * @property {String} extName * * @constructor * @public */ exports.GetService = function (options) { //because of limitation in lib, we should create a singleton function createInstance(){ instance = new TransporterClass(options); } if(!instance) createInstance(); return instance; }; × Search results Close "},"server_server.js.html":{"id":"server_server.js.html","title":"Source: server/server.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/server.js var loopback = require('loopback'); var boot = require('loopback-boot'); var path = require('path'); /** * Add `global` method for requiring from `root` */ global.serverRequire = function (req) { var p = path.normalize(__dirname + '/./' + req); return require(p); }; /** * monkey patch `JSON.stringify` because `Error` class does not include `message` field */ var jsoner = JSON.stringify; JSON.stringify = function () { var args = Array.prototype.slice.call(arguments); if (args &amp;&amp; args[0] &amp;&amp; args[0] instanceof Error) { var err = args[0]; return `{&quot;statusCode:${err.statusCode},&quot;code&quot;:&quot;${err.code}&quot;,&quot;message&quot;:&quot;${err.message}&quot;}`; } return jsoner.apply(this, arguments); }; var app = module.exports = loopback(); app.start = function () { // start the web server return app.listen(function () { app.emit('started'); var baseUrl = app.get('url').replace(/\\/$/, ''); console.log('Web server listening at: %s', baseUrl); if (app.get('loopback-component-explorer')) { var explorerPath = app.get('loopback-component-explorer').mountPath; console.log('Browse your REST API at %s%s', baseUrl, explorerPath); } }); }; // Bootstrap the application, configure models, datasources and middleware. // Sub-apps like REST API are mounted via boot scripts. boot(app, { appRootDir: __dirname }, function (err) { if (err) throw err; // start the server if `$ node server.js` if (require.main === module) app.start(); }); × Search results Close "},"server_models_geo_house.js.html":{"id":"server_models_geo_house.js.html","title":"Source: server/models/geo/house.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/geo/house.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var Common = require('narengi-utils').Common; var Pagination = require('narengi-utils').Pagination; var Persistency = require('narengi-utils').Persistency; var app = serverRequire('server'); var underscore = require('underscore'); var lodash = require('lodash'); var loopback = require('loopback'); var LoopBackContext = require('loopback-context'); var randomString = require('randomstring'); var async = require('async'); var debug = require('debug')('narengi:geo:house'); var moment = require('moment'); /** * @namespace Models.House * @module House */ module.exports = function (House) { House.setMaxListeners(50); //prevent from warning. Because this class has a lot of remote hooks, warning raised defineInstanceServices(House); defineMainServices(House); definePictureStuff(House); defineFeatureStuff(House); defineExtraServicesStuff(House); defineHouseTypeServiceStuff(House); defineHouseSpecServiceStuff(House); defineAvailableDateServiceStuff(House); definePriceDateServiceStuff(House); definePriceProfileServiceStuff(House); defineCancellationPolicyServiceStuff(House); }; /** * @param houseId * @param data * @param cb * @return {*} * @ignore */ function createOrUpdateHouse(houseId, data, cb) { var plainProps = ['name', 'location', 'summary', 'description', 'lang']; var plainData = underscore.pick(data, plainProps); async.waterfall([ function (callback) { //create or update instance by plain properties if (houseId !== null) { plainData.id = houseId; } app.models.House.upsert(plainData, callback); }, function (house, callback) { //set owner if (houseId == null) { setOwner(callback)(house); } else { callback(null, house); } }, function (house, callback) { //set house type. if (data.type_id) { app.models.HouseType.findById(data.type_id).then((type) =&gt; { house.houseType(type); callback(null, house); }).catch(() =&gt; { callback(null, house);HouseBookingRequest }); } else { callback(null, house); } }, function (house, callback) { //set spec if (data.spec) { var spec = app.models.HouseSpec.RefineInput(data.spec); house.spec = house.spec || {}; spec = underscore.defaults(spec, house.spec.toJSON()); house.spec = spec; } callback(null, house); }, function (house, callback) { //set house features if (lodash.isArray(data.features)) { app.models.HouseFeature.find({where: {id: {inq: lodash.compact(data.features)}}}).then((features) =&gt; { //we should add those which are not persisted before var existedFeatures = house.houseFeatures.value(); var refinedFeatures = lodash.reject(features, function (item) { var found = lodash.find(existedFeatures, function (inner) { return item.id === inner.id || (item.key === inner.key &amp;&amp; item.lang === inner.lang); }); return !lodash.isNil(found); }); async.each(refinedFeatures, house.houseFeatures.create, function (err) { callback(null, house); }); }).catch(() =&gt; { callback(null, house); }); } else { callback(null, house); } } ], function (err, house) { if (err) return cb(err); house.save(cb); }); return cb.promise; } /** * Set owner of house based on current logged in user * @param {Callback} cb * @ignore */ function setOwner(cb) { return function (house) { if (!house) return cb(Persistency.Errors.NotFound()); var loopbackCtx = LoopBackContext.getCurrentContext(); if (loopbackCtx) { var currentUser = loopbackCtx.get('currentUser'); } if (currentUser) { app.models.Person.GetByAccountId(currentUser.id).then(personFoundHandler(house, cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); } else Persistency.CrudHandlers.successHandler(cb)(house); }; function personFoundHandler(house, callback) { return function (person) { house.owner(person); //house.save().then(Persistency.CrudHandlers.successHandler(callback)).catch(Persistency.CrudHandlers.failureHandler(callback)); callback(null, house); } } } function defineInstanceServices(House){ /** * Is the current user can book * @memberOf House */ House.prototype.canBook = function (id, req, cb) { }; } function defineMainServices(House) { /** * Creates a new `House` instance. * @param {Object} data User input data * @param {String} data.name * @param {Object} data.location * @param {Object} data.location.point * @param {Number} data.location.point.latitude * @param {Number} data.location.point.longitude * @param {String} data.location.province * @param {String} data.location.city * @param {String} data.summary * @param {String} data.description * @param {Object} data.spec * @param {Number} data.spec.accommodate * @param {Number} data.spec.bedroom * @param {Number} data.spec.bed * @param {Number} data.spec.bathroom * @param {String} data.type_id * @param {Array} data.features * @param {Callback} cb * @returns {HouseDTO} */ House.Create = function (data, cb) { cb = cb || Common.PromiseCallback(); return createOrUpdateHouse(null, data, cb); }; House.beforeRemote('Create', Common.RemoteHooks.correctCaseOfKeysInArg('data', true)); House.beforeRemote('Create', Common.RemoteHooks.injectLangToRequestData); House.afterRemote(&quot;Create&quot;, Common.RemoteHooks.convert2Dto(House)); House.remoteMethod( 'Create', { description: 'Creates a house.', accepts: [ { arg: 'data', type: 'object', required: true, http: {source: 'body'}, description: 'Data attributes to create new instance' } ], returns: { arg: 'house', type: 'object', root: true }, http: { path: &quot;/&quot;, verb: 'post', status: 201 } } ); //=================================================================================================================== /** * Updates a `House` instance. * @param {String} id House id * @param {Object} data User input data * @param {String} data.name * @param {Object} data.location * @param {Object} data.location.point * @param {Number} data.location.point.latitude * @param {Number} data.location.point.longitude * @param {String} data.location.province * @param {String} data.location.city * @param {String} data.summary * @param {String} data.description * @param {Object} data.spec * @param {Number} data.spec.accommodate * @param {Number} data.spec.bedroom * @param {Number} data.spec.bed * @param {Number} data.spec.bathroom * @param {String} data.type_id * @param {Array} data.features * @param {Callback} cb * @returns {HouseDTO} */ House.Update = function (id, data, cb) { cb = cb || Common.PromiseCallback(); return createOrUpdateHouse(id, data, cb); }; House.beforeRemote('Update', Common.RemoteHooks.correctCaseOfKeysInArg('data', true)); House.beforeRemote('Update', Common.RemoteHooks.injectLangToRequestData); House.afterRemote(&quot;Update&quot;, Common.RemoteHooks.convert2Dto(House)); House.remoteMethod( 'Update', { description: 'Updates a house.', accepts: [ { arg: 'id', type: 'string', required: true, http: { source: 'path' } }, { arg: 'data', type: 'object', required: true, http: { source: 'body' } } ], returns: { arg: 'house', type: 'object', root: true }, http: { path: &quot;/:id&quot;, verb: 'put', status: 201 } } ); //=================================================================================================================== /** * Deletes a `House` by its id * @param {string} id * @param {Callback} cb */ House.DeleteOne = function (id, cb) { cb = cb || Common.PromiseCallback(); House.upsert({id: id, deleted: true}, cb); return cb.promise; }; House.remoteMethod( 'DeleteOne', { description: 'Deletes a house.', accepts: [ { arg: 'id', type: 'string', required: true, http: { source: 'path' } } ], http: { path: &quot;/:id&quot;, verb: 'delete', status: 204 } } ); //=================================================================================================================== /** * Fetch a `House` by its id * @param {string} id * @param {Callback} cb * @returns {HouseDTO} */ House.GetById = function (id, cb) { cb = cb || Common.PromiseCallback(); House.findById(id).then((house) =&gt; { if (house) { return cb(null, house); } cb(Persistency.Errors.NotFound()); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.afterRemote(&quot;GetById&quot;, Common.RemoteHooks.convert2Dto(House)); House.remoteMethod( 'GetById', { description: 'Get a house by id', accepts: [ { arg: 'id', type: 'string', required: true, http: { source: 'path' } } ], returns: { arg: 'house', type: 'object', root: true }, http: { path: &quot;/:id&quot;, verb: 'get', status: 200 } } ); //=================================================================================================================== /** * Returns all `House` instances based on filter * @param {Object} paging {limit, skip} * @param {Callback} cb * @returns {HouseDTO[]} */ House.GetAll = function (paging, cb) { cb = cb || PromiseCallback(); var filter = paging; this.injectLangToFilter(filter); filter.where = filter.where || {}; filter.where.deleted = false; House.find(filter).then(Persistency.CrudHandlers.successHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; /** * Refine pagination arg */ House.beforeRemote(&quot;GetAll&quot;, Pagination.RemoteHooks.refinePaginationParams); House.afterRemote(&quot;GetAll&quot;, Pagination.RemoteHooks.afterPaginatedService); House.afterRemote(&quot;GetAll&quot;, Common.RemoteHooks.convert2Dto(House)); House.remoteMethod( 'GetAll', { description: 'Returns all `House` instances based on input filtering', accepts: [ { arg: 'paging', type: 'object', required: true, http: Pagination.Common.HttpPagingParam, description: ['Calculated parameter.', 'In REST call should be like : `/houses?limit=25&amp;skip=150`'] } ], returns: { arg: 'houses', type: 'array', root: true, description: 'List of paginated `House` instances' }, http: { path: &quot;/&quot;, verb: 'get', status: 200 } } ); //======================================================================================== /** * * @param {string | null} term Search term * @param {object} paging Like {skip: 0, limit: 10} * @param {HttpRequest} req * @param {HttpResponse} res * @param {Callback} cb * @returns {HouseDTO[]} */ House.Search = function (term, paging, req, res, cb) { cb = cb || Common.PromiseCallback(); var filter = paging; //type of argument is string so we test it by empty string if (term !== &quot;&quot;) { filter[&quot;where&quot;] = {name: {like: term, options: &quot;i&quot;}}; // i denotes insensitivity } filter.where = filter.where || {}; filter.where.deleted = false; House.find(filter).then(Persistency.CrudHandlers.successHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.beforeRemote(&quot;Search&quot;, Pagination.RemoteHooks.argumentWrapper(['term'])); /** * Refine pagination arg */ House.beforeRemote(&quot;Search&quot;, Pagination.RemoteHooks.refinePaginationParams); House.afterRemote(&quot;Search&quot;, Pagination.RemoteHooks.afterPaginatedService); House.afterRemote(&quot;Search&quot;, Common.RemoteHooks.convert2Dto(House)); House.remoteMethod( 'Search', { description: 'Search in houses', accepts: [ { arg: 'term', type: 'string', required: true, http: function (ctx) { var req = ctx.req; return (req.query &amp;&amp; req.query.term) ? req.query.term : &quot;&quot;; } }, { arg: 'paging', type: 'object', required: true, http: Pagination.Common.HttpPagingParam }, { arg: 'req', type: 'object', required: true, http: { source: 'req' } }, { arg: 'res', type: 'object', required: true, http: { source: 'res' } } ], returns: { arg: 'houses', type: '[object]', root: true, }, http: { path: &quot;/search&quot;, verb: 'get', status: 200 } } ); } /** * @param House * @ignore */ function definePictureStuff(House) { /** * Module method for uploading one picture * @param id * @param {HttpContext} ctx * @param {Callback} cb * @returns {Object} * @memberOf Models.House */ House.UploadPicture = function (id, ctx, cb) { cb = cb || Common.PromiseCallback(); House.findById(id).then(houseFoundHandler).catch(houseNotFoundHandler); return cb.promise; function houseFoundHandler(house) { var options = {}; app.models.HouseImageContainer.UploadPicture(house, ctx, options).then(uploadCompletedHandler).catch(uploadFailedHandler); function uploadCompletedHandler(result) { var pictures = result.db; //synced house.updateAttributes({pictures: pictures}).then(function (updatedhouse) { var api = {}; api.url = `/houses/${updatedhouse.id}/pictures/${result.api[0].hash}`; api.styles = underscore.reduce(result.api[0].styles, function (memo, stylePack) { return underscore.extend(memo, stylePack.style); }, {}); cb(null, api); }).catch(uploadFailedHandler); } function uploadFailedHandler(err) { cb(err); } } function houseNotFoundHandler(err) { cb(Persistency.Errors.NotFound()); } }; /** * Defines uploading picture service method as a REST API * @ignore */ House.remoteMethod(&quot;UploadPicture&quot;, { accepts: [ {arg: 'id', type: 'string', required: true, http: {source: 'path'}}, {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'object', root: true }, http: {verb: 'post', status: 201, path: &quot;/:id/picture&quot;} }); /** * Module method for uploading multiple pictures * @param {string} houseId * @param {HttpContext} ctx * @param {Callback} cb * @returns {Array} * @memberOf Models.House */ House.UploadPictureAll = function (houseId, ctx, cb) { cb = cb || Common.PromiseCallback(); House.findById(houseId).then(houseFoundHandler).catch(houseNotFoundHandler); return cb.promise; function houseFoundHandler(house) { var options = {}; app.models.HouseImageContainer.UploadPictureAll(house, ctx, options).then(uploadCompletedHandler).catch(uploadFailedHandler); function uploadCompletedHandler(result) { var pictures = result.db; //synced house.updateAttributes({pictures: pictures}).then(function (updatedHouse) { var apiArr = []; underscore.each(result.api, function (filePack) { var api = {}; api.url = `/houses/${updatedHouse.id}/pictures/${filePack.hash}`; api.styles = underscore.reduce(filePack.styles, function (memo, stylePack) { return underscore.extend(memo, stylePack.style); }, {}); apiArr.push(api); }); cb(null, apiArr); }).catch(uploadFailedHandler); } function uploadFailedHandler(err) { cb(err); } } function houseNotFoundHandler(err) { console.log(err); cb(Persistency.Errors.NotFound()); } }; /** * Defines uploading picture service method as a REST API * @ignore */ House.remoteMethod(&quot;UploadPictureAll&quot;, { accepts: [ {arg: 'id', type: 'string', required: true, http: {source: 'path'}}, {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'array', root: true }, http: {verb: 'post', status: 201, path: &quot;/:id/pictures&quot;} }); /** * Module method for downloading house picture by its name * @param {string} id * @param {string} hash Picture hash * @param {String} style * @param {HttpContext} ctx * @param {Callback} cb * @returns {Stream} * @memberOf Models.House */ House.DownloadPicture = function (id, hash, style, ctx, cb) { cb = cb || Common.PromiseCallback(); House.findById(id).then(houseFoundHandler).catch(houseNotFoundHandler); return cb.promise; function houseFoundHandler(house) { try { app.models.HouseImageContainer.DownloadPicture(house, hash, style, ctx); } catch (ex) { cb(ex); } } function houseNotFoundHandler(err) { cb(err); } }; /** * Defines uploading picture service method as a REST API * @ignore */ House.remoteMethod(&quot;DownloadPicture&quot;, { accepts: [ {arg: 'id', type: 'string', required: true, http: {source: 'path'}}, {arg: 'hash', type: 'string', required: true, http: {source: 'path'}}, { arg: 'style', type: 'string', http: function (ctx) { var req = ctx.req; var query = req.query || {}; var style = query['style'] ? query['style'] : null; return style ? style.trim() : &quot;&quot;; } }, {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'object', root: true }, http: {verb: 'get', path: &quot;/:id/pictures/:hash&quot;} }); /** * Returns list of picture files * @param {string} houseId * @param {HttpContext} ctx * @param {Callback} cb * @returns {Array} */ House.GetPictureList = function (houseId, ctx, cb) { cb = cb || Common.PromiseCallback(); House.findById(houseId).then(houseFoundHandler).catch(houseNotFoundHandler); return cb.promise; function houseFoundHandler(house) { if (!house) { return cb(Persistency.Errors.NotFound()); } try { var pictures = app.models.HouseDTO.GetPictures(house); cb(null, pictures); } catch (ex) { cb(ex); } } function houseNotFoundHandler(err) { cb(err); } }; /** * Defines uploading picture service method as a REST API */ House.remoteMethod(&quot;GetPictureList&quot;, { accepts: [ {arg: 'houseId', type: 'string', http: {source: 'path'}}, {arg: 'ctx', type: 'object', http: {source: 'context'}} ], returns: { arg: 'fileObject', type: 'array', root: true }, http: {verb: 'get', path: &quot;/:houseId/pictures&quot;} }); } function defineFeatureStuff(House) { function houseFoundForFeatureErrorHandler(cb) { return function (err) { cb(err); }; } function houseFoundForAddFeatureHandler(ids, cb) { return function (house) { if (!house) { return cb(Persistency.Errors.NotFound()); } app.models.HouseFeature.find({where: {id: {inq: lodash.compact(ids)}}}).then((features) =&gt; { //we should add those which are not persisted before var existedFeatures = house.houseFeatures.value(); var refinedFeatures = lodash.reject(features, function (item) { var found = lodash.find(existedFeatures, function (inner) { return item.id === inner.id || (item.key === inner.key &amp;&amp; item.lang === inner.lang); }); return !lodash.isNil(found); }); async.each(refinedFeatures, house.houseFeatures.create, function (err) { house.reload(cb); }); }).catch(() =&gt; { cb(null, house); }); }; } function houseFoundForDeleteFeatureHandler(key, cb) { return function (house) { if (!house) { return cb(Persistency.Errors.NotFound()); } house.houseFeatures.destroyAll({or: [{id: key}, {key: key}]}, function (err) { if (err) return cb(err); house.reload(cb); }); }; } /** * Add feature to house. * Note that we persist plain feature object i.e json format of feature without id * @param {string} id House id * @param {Array} ids HouseFeature id array * @param {Callback} cb */ House.AddFeature = function (id, ids, cb) { cb = cb || Common.PromiseCallback(); House.findById(id).then(houseFoundForAddFeatureHandler(ids, cb)).catch(houseFoundForFeatureErrorHandler(cb)); return cb.promise; }; House.afterRemote(&quot;AddFeature&quot;, Common.RemoteHooks.convert2Dto(House)); House.remoteMethod(&quot;AddFeature&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}}, {arg: 'ids', type: 'array', http: {source: 'path'}} ], returns: { arg: 'house', type: 'HouseDTO', root: true }, http: {verb: 'post', status: 201, path: &quot;/:id/features/:ids&quot;} }); /** * Removes a feature from a house * @param {string} id House id * @param {string} key HouseFeature key * @param {Callback} cb */ House.DeleteFeature = function (id, key, cb) { cb = cb || Common.PromiseCallback(); House.findById(id).then(houseFoundForDeleteFeatureHandler(key, cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.afterRemote(&quot;DeleteFeature&quot;, Common.RemoteHooks.convert2Dto(House)); House.remoteMethod(&quot;DeleteFeature&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}}, {arg: 'key', type: 'string', http: {source: 'path'}} ], returns: { arg: 'house', type: 'HouseDTO', root: true }, http: {verb: 'delete', status: 201, path: &quot;/:id/features/:key&quot;} }); } function defineExtraServicesStuff(House) { House.beforeRemote('CreateExtraService', function (ctx, instance, next) { var args = ctx.args; if (args) { if (args.data) { args.data.id = randomString.generate({ charset: &quot;hex&quot; }); if (args.data.price &amp;&amp; !args.data.price.currency) { args.data.price.currency = app.settings.currency.default; } } } next(); }); function houseFoundForCreatingExtraService(data, cb) { return function (house) { if (!house) { return cb(Persistency.Errors.NotFound()); } house.extraServices.create(data).then((service) =&gt; { cb(null, service); }).catch((e) =&gt; { cb(e); }); } } /** * Creates an `HouseExtraService` as an extra service for house * @param {string} id House id * @param {object} data * @param {Callback} cb */ House.CreateExtraService = function (id, data, cb) { cb = cb || Common.PromiseCallback(); House.findById(id).then(houseFoundForCreatingExtraService(data, cb)).catch((e) =&gt; { cb(e); }); return cb.promise; }; House.remoteMethod(&quot;CreateExtraService&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}}, {arg: 'data', type: 'object', http: {source: 'body'}} ], http: {verb: 'post', status: 204, path: &quot;/:id/extra-services&quot;} }); /** * Delete an extra service by id * @param {string} id House id * @param {string} extraServiceId extra service id * @param {Callback} cb */ House.DeleteExtraService = function (id, extraServiceId, cb) { cb = cb || Common.PromiseCallback(); House.findById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); house.extraServices.unset(extraServiceId, cb); }).catch((e) =&gt; { cb(e); }); return cb.promise; }; House.remoteMethod(&quot;DeleteExtraService&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}}, {arg: 'extraServiceId', type: 'string', http: {source: 'path'}} ], http: {verb: 'delete', status: 204, path: &quot;/:id/extra-services/:extraServiceId&quot;} }); /** * Get all extra services of the house * @param {string} id house id * @param {Callback} cb */ House.GetAllExtraServices = function (id, cb) { cb = cb || Common.PromiseCallback(); House.findById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); cb(null, house.extraServices.value()); }).catch((e) =&gt; { cb(e); }); return cb.promise; }; House.remoteMethod(&quot;GetAllExtraServices&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}} ], returns: [ { arg: 'service', type: 'array', root: true } ], http: {verb: 'get', status: 200, path: &quot;/:id/extra-services&quot;} }); /** * Get an extra service by its id * @param {string} id house id * @param {service} extraServiceId extra service id * @param {Callback} cb */ House.GetExtraServiceById = function (id, extraServiceId, cb) { cb = cb || Common.PromiseCallback(); House.findById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); house.__findById__extraServices(extraServiceId, function (e, service) { if (e) return cb(e); if (!service) return cb(Persistency.Errors.NotFound()); cb(null, service); }); }).catch((e) =&gt; { cb(e); }); return cb.promise; }; House.remoteMethod(&quot;GetExtraServiceById&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}}, {arg: 'extraServiceId', type: 'string', http: {source: 'path'}} ], returns: [ { arg: 'service', type: 'object', root: true } ], http: {verb: 'get', status: 200, path: &quot;/:id/extra-services/:extraServiceId&quot;} }); } function defineHouseTypeServiceStuff(House) { /** * Set type of house * @param {string} id house id * @param {string} typeId house type id * @param {Callback} cb */ House.SetType = function (id, typeId, cb) { cb = cb || Common.PromiseCallback(); async.parallel([ function (callback) { app.models.HouseType.GetById(typeId, callback); }, function (callback) { House.GetById(id, callback); } ], function (err, result) { if (err) return cb(err); var houseType = result[0]; var house = result[1]; house.houseType(houseType); house.save().then(Persistency.CrudHandlers.successHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); }); return cb.promise; }; House.afterRemote(&quot;SetType&quot;, Common.RemoteHooks.convert2Dto(House)); House.remoteMethod(&quot;SetType&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}}, {arg: 'typeId', type: 'string', http: {source: 'path'}} ], returns: [ { arg: 'house', type: 'HouseDTO', root: true } ], http: {verb: 'put', status: 201, path: &quot;/:id/type/:typeId&quot;} }); /** * Unset type of house * @param {string} id house id * @param {Callback} cb */ House.UnsetType = function (id, cb) { cb = cb || Common.PromiseCallback(); House.GetById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); house.houseType.destroy(cb); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.afterRemote(&quot;UnsetType&quot;, Common.RemoteHooks.convert2Dto(House)); House.remoteMethod(&quot;UnsetType&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}} ], returns: [ { arg: 'house', type: 'HouseDTO', root: true } ], http: {verb: 'delete', status: 201, path: &quot;/:id/type&quot;} }); } function defineHouseSpecServiceStuff(House) { /** * @param {String} id House id * @param {Object} spec * @param {Number} spec.accommodate * @param {Number} spec.bedroom * @param {Number} spec.bed * @param {Number} spec.bathroom * @param {Callback} cb * @return {*} * @memberOf Models.House */ House.UpdateSpec = function (id, spec, cb) { cb = cb || Common.PromiseCallback(); House.GetById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); if (spec) { spec = app.models.HouseSpec.RefineInput(spec); house.spec = house.spec || {}; spec = lodash.defaults(spec, house.spec.toJSON()); house.spec = spec; house.save().then(Persistency.CrudHandlers.successHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); } cb(null, house); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.beforeRemote('UpdateSpec', Common.RemoteHooks.argShouldNotEmpty(&quot;spec&quot;)); House.beforeRemote('UpdateSpec', Common.RemoteHooks.correctCaseOfKeysInArg(&quot;spec&quot;, &quot;HouseSpec&quot;)); House.beforeRemote('UpdateSpec', Common.RemoteHooks.dataOwnerCorrectorInArg(&quot;spec&quot;, &quot;HouseSpec&quot;)); House.afterRemote(&quot;UpdateSpec&quot;, Common.RemoteHooks.convert2Dto(House)); House.remoteMethod(&quot;UpdateSpec&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}}, {arg: 'spec', type: 'object', http: {source: 'body'}} ], returns: [ { arg: 'house', type: 'HouseDTO', root: true } ], http: {verb: 'post', status: 201, path: &quot;/:id/spec&quot;} }); //======================================================================================== House.ResetSpec = function (id, cb) { cb = cb || Common.PromiseCallback(); House.GetById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); house.updateAttribute(&quot;spec&quot;, app.models.HouseSpec.Create(), cb); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.afterRemote(&quot;ResetSpec&quot;, Common.RemoteHooks.convert2Dto(House)); House.remoteMethod(&quot;ResetSpec&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}} ], returns: [ { arg: 'house', type: 'HouseDTO', root: true } ], http: {verb: 'delete', status: 204, path: &quot;/:id/spec&quot;} }); //======================================================================================== House.GetSpec = function (id, cb) { cb = cb || Common.PromiseCallback(); House.GetById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); cb(null, house.spec); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.remoteMethod(&quot;GetSpec&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}} ], returns: [ {arg: 'spec', type: 'HouseSpec', root: true} ], http: {verb: 'get', status: 200, path: &quot;/:id/spec&quot;} }); } function defineAvailableDateServiceStuff(House) { /** * Add specified dates to house as available. * @param {string} id House ID * @param {object} data Includes date array as GMT * @param {Callback} cb */ House.AddAvailableDates = function (id, data, cb) { cb = cb || Common.PromiseCallback(); var currentUser = LoopBackContext.getCurrentContext().get(&quot;currentUser&quot;); var accessCtx = { model: House, modelId: id, principalType: &quot;Account&quot;, principalId: currentUser.id, accessToken: LoopBackContext.getCurrentContext().active.http.req.accessToken }; async.waterfall([ function (callback) { app.models.Role.isInRole('houseOwner', accessCtx, function (err, isInRole) { if (err) return callback(err); callback(null, isInRole); }); }, function (isHouseOwner, callback) { app.models.Role.isInRole(app.models.Role.ADMIN, accessCtx, function (err, isInRole) { if (err) return callback(err); callback(null, [isHouseOwner, isInRole]); }); } ], function (err, result) { if (err) return cb(err); var isHouseOwner = result[0]; var isAdmin = result[1]; debug(&quot;AddAvailableDates() =&gt; [isOwner, isAdmin] = [%s, %s]&quot;, isHouseOwner, isAdmin); House.GetById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); app.models.HouseAvailableDate.AddDates(house, data.dates, isAdmin, isHouseOwner, cb); }).catch(Persistency.CrudHandlers.failureHandler(cb)); }); return cb.promise; }; House.remoteMethod(&quot;AddAvailableDates&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}}, {arg: 'data', type: 'object', http: {source: 'body'}} ], http: {verb: 'put', status: 204, path: &quot;/:id/available-dates&quot;} }); House.beforeRemote('AddAvailableDates', Common.RemoteHooks.argShouldNotEmpty(&quot;data&quot;)); House.beforeRemote('AddAvailableDates', function (ctx, instance, next) { var dates = ctx.args[&quot;data&quot;].dates || []; dates = underscore.map(dates, function (strDate) { try { return moment(strDate).format(&quot;YYYY-MM-DD&quot;); } catch (ex) { return null; } }); dates = underscore.filter(dates, function (date) { return date != null; }); ctx.args[&quot;data&quot;].dates = dates; next(); }); //======================================================================================== /** * Removes specified dates to house as available. * Or make unavailable some dates. * @param {string} id House ID * @param {object} data Includes date array as GMT * @param {Callback} cb */ House.RemoveAvailableDates = function (id, data, cb) { cb = cb || Common.PromiseCallback(); House.GetById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); app.models.HouseAvailableDate.DeleteDates(house, data.dates, cb); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.remoteMethod(&quot;RemoveAvailableDates&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}}, {arg: 'data', type: 'object', http: {source: 'body'}} ], http: {verb: 'put', status: 204, path: &quot;/:id/available-dates/remove&quot;} }); House.beforeRemote('RemoveAvailableDates', Common.RemoteHooks.argShouldNotEmpty(&quot;data&quot;)); House.beforeRemote('RemoveAvailableDates', function (ctx, instance, next) { var dates = ctx.args[&quot;data&quot;].dates || []; dates = underscore.map(dates, function (strDate) { try { return moment(strDate).format(&quot;YYYY-MM-DD&quot;); } catch (ex) { return null; } }); dates = underscore.filter(dates, function (date) { return date != null; }); ctx.args[&quot;data&quot;].dates = dates; next(); }); //======================================================================================== /** * Returns dates which are available in date range starting from `startDate` and `endDate` input parameters. * @param {string} id House ID * @param {string} startDate Start date in ISO format * @param {string} endDate End date in ISO format * @param {Callback} cb */ House.GetAvailableDates = function (id, startDate, endDate, cb) { cb = cb || Common.PromiseCallback(); House.GetById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); var start = moment(startDate); start = start.isValid() ? start.toDate() : new Date(); var end = moment(endDate); end = end.isValid() ? end.toDate() : new Date(); app.models.HouseAvailableDate.GetDatesInRange(house, start, end, cb); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.remoteMethod(&quot;GetAvailableDates&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}, description: &quot;House ID&quot;}, {arg: 'startDate', type: 'string', http: {source: 'path'}, description: &quot;Start date in ISO format&quot;}, {arg: 'endDate', type: 'string', http: {source: 'path'}, description: &quot;End date in ISO format&quot;} ], returns: [ { arg: 'availableDates', type: 'array', root: true, description: [&quot;Dates which are available in date range between `startDate` and `endDate` inputs.&quot;] } ], http: {verb: 'get', status: 200, path: &quot;/:id/available-dates/start-:startDate/end-:endDate&quot;}, description: [&quot;Returns dates which are available in date range starting &quot;, &quot;from `startDate` and `endDate` input parameters.&quot;] }); House.afterRemote(&quot;GetAvailableDates&quot;, Common.RemoteHooks.convert2Dto(&quot;HouseAvailableDate&quot;)); } function definePriceDateServiceStuff(House) { /** * Add or update prices of house which is attached to a specific date. * @param {string} id House Id * @param {array} data * @param {Callback} cb * @returns {promise} */ House.AddOrUpdateDatePrices = function (id, data, cb) { cb = cb || Common.PromiseCallback(); House.GetById(id).then((house) =&gt; { app.models.HouseDatePrice.AddOrUpdate(house, data, cb); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.remoteMethod(&quot;AddOrUpdateDatePrices&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}, description: &quot;House ID&quot;}, { arg: 'data', type: 'array', http: {source: 'body'}, description: [ &quot;`data` should be an array containing objects like :&quot;, &quot;```&quot;, &quot;{&quot;, &quot;date: JSDate,&quot;, &quot;price: {&quot;, &quot;amount: Number,&quot;, &quot;currency:: String&quot;, &quot;}&quot;, &quot;}&quot;, &quot;```&quot; ] } ], http: {verb: 'put', status: 201, path: &quot;/:id/date-prices&quot;}, description: [&quot;Adds new instances or updates existing entities based on input `data`.&quot;] }); //======================================================================================== /** * Get prices of house which is attached to a specific date. * @param {string} id House Id * @param {string} startDate Start date string in ISO format * @param {string} endDate End date string in ISO format * @param {Callback} cb * @returns {promise} */ House.GetDatePricesInRange = function (id, startDate, endDate, cb) { cb = cb || Common.PromiseCallback(); House.GetById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); app.models.HouseDatePrice.GetInRange(house, startDate, endDate, cb); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.remoteMethod(&quot;GetDatePricesInRange&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}, description: &quot;House ID&quot;}, {arg: 'startDate', type: 'string', http: {source: 'path'}, description: &quot;Start date string in ISO format&quot;}, {arg: 'endDate', type: 'string', http: {source: 'path'}, description: &quot;End date string in ISO format&quot;} ], returns: [ { arg: 'datePrices', type: '[HouseDatePrice]', root: true, description: [&quot;Date prices objects which are available in date range between `startDate` and `endDate` inputs.&quot;] } ], http: {verb: 'get', status: 200, path: &quot;/:id/date-prices/start-:startDate/end-:endDate&quot;}, description: [&quot;Returns date prices which are available between `startDate` and `endDate`.&quot;] }); //======================================================================================== /** * Set prices of dates which are in date array to default. * @param {string} id House Id * @param {array} dates Array of dates in ISO format * @param {Callback} cb * @returns {Promise} */ House.UnsetDatePricesInRange = function (id, dates, cb) { cb = cb || Common.PromiseCallback(); House.GetById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); app.models.HouseDatePrice.UnSetInRange(house, dates, cb); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.remoteMethod(&quot;UnsetDatePricesInRange&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}, description: &quot;House ID&quot;}, {arg: 'dates', type: 'array', http: {source: 'body'}, description: &quot;Array of dates in ISO format&quot;} ], http: {verb: 'put', status: 201, path: &quot;/:id/date-prices/unset&quot;}, description: [&quot;Set prices of dates which are in `dates` array to default &quot;] }); } function definePriceProfileServiceStuff(House) { /** * Set/Update `HousePriceProfile` as price profile (`priceProfile`) for the house recognized by `id` * @param {string} id House Id * @param {object} data Input data. `HousePriceProfile` * @param {Callback} cb * @returns {Promise} */ House.SetPriceProfile = function (id, data, cb) { cb = cb || Common.PromiseCallback(); House.GetById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); app.models.HousePriceProfile.SetForHouse(house, data, cb); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.remoteMethod(&quot;SetPriceProfile&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}, description: &quot;House ID&quot;}, { arg: 'data', type: 'object', http: {source: 'body'}, description: &quot;Input profile data as `HousePriceProfile`&quot; } ], http: {verb: 'put', status: 201, path: &quot;/:id/price-profile&quot;}, description: [&quot;Set price profile for the house.&quot;] }); House.beforeRemote('SetPriceProfile', Common.RemoteHooks.argShouldNotEmpty(&quot;data&quot;)); House.beforeRemote('SetPriceProfile', Common.RemoteHooks.correctCaseOfKeysInArg(&quot;data&quot;, &quot;HousePriceProfile&quot;)); House.beforeRemote('SetPriceProfile', Common.RemoteHooks.dataOwnerCorrectorInArg(&quot;data&quot;, &quot;HousePriceProfile&quot;)); //======================================================================================== /** * Unset/Delete price profile of the house recognized by `id` as `priceProfile` field. * @param {string} id House Id * @param {Callback} cb * @returns {Promise} */ House.UnsetPriceProfile = function (id, cb) { cb = cb || Common.PromiseCallback(); House.GetById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); house.priceProfile.destroy().then(Persistency.CrudHandlers.successHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.remoteMethod(&quot;UnsetPriceProfile&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}, description: &quot;House ID&quot;} ], http: {verb: 'delete', status: 201, path: &quot;/:id/price-profile&quot;}, description: [&quot;Unset price profile for the house.&quot;] }); //======================================================================================== /** * Returns `priceProfile` of the house recognized by `id`. * @param {string} id House Id * @param {Callback} cb * @returns {Promise} */ House.GetPriceProfile = function (id, cb) { cb = cb || Common.PromiseCallback(); House.GetById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); var priceProfile = house.priceProfile.value(); if (!priceProfile) return cb(null); cb(null, priceProfile); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.remoteMethod(&quot;GetPriceProfile&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}, description: &quot;House ID&quot;} ], returns: [ { arg: 'priceProfile', type: 'HousePriceProfile', root: true, description: [&quot;Price profile of the house.&quot;, &quot;It is configuration of price of the house.&quot; ] } ], http: {verb: 'get', status: 200, path: &quot;/:id/price-profile&quot;}, description: [&quot;Get price profile for the house.&quot;] }); } function defineCancellationPolicyServiceStuff(House) { /** * Set cancellation policy for the house. It should be selected from existing `HouseCancellationPolicy` instances. * @param {string} id House id * @param {string} policyId `HouseCancellationPlicy` id * @param {Callback} cb * @returns {Promise} */ House.SetCancellationPolicy = function (id, policyId, cb) { cb = cb || Common.PromiseCallback(); async.parallel([ function (callback) { House.GetById(id, callback); }, function (callback) { app.models.HouseCancellationPolicy.GetById(policyId, callback); } ], function (err, result) { if (err) return cb(err); var house = result[0]; var policy = result[1]; house.cancellationPolicy = policy; house.save().then(Persistency.CrudHandlers.successHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); }); return cb.promise; }; House.remoteMethod(&quot;SetCancellationPolicy&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}, description: &quot;House ID&quot;}, { arg: 'policyId', type: 'string', http: {source: 'path'}, description: &quot;Cancellation policy ID. `HouseCancellationPolicy` model&quot; } ], http: {verb: 'put', status: 204, path: &quot;/:id/cancellation-policy/:policyId&quot;}, description: [&quot;Set cancellation policy for the house.&quot;, &quot;It should be selected from existing `HouseCancellationPolicy` instances.&quot;] }); //======================================================================================== /** * Unset cancellation policy for the house. * @param {string} id House id * @param {Callback} cb * @returns {Promise} */ House.UnsetCancellationPolicy = function (id, cb) { cb = cb || Common.PromiseCallback(); House.GetById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); house.cancellationPolicyRel.destroy().then(Persistency.CrudHandlers.successHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.remoteMethod(&quot;UnsetCancellationPolicy&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}, description: &quot;House ID&quot;} ], http: {verb: 'delete', status: 204, path: &quot;/:id/cancellation-policy&quot;}, description: [&quot;Unset cancellation policy for the house.&quot;] }); //======================================================================================== /** * Returns cancellation policy for the house. If nothing existed returns empty object. * @param {string} id House id * @param {Callback} cb * @returns {Promise} */ House.GetCancellationPolicy = function (id, cb) { cb = cb || Common.PromiseCallback(); House.GetById(id).then((house) =&gt; { if (!house) return cb(Persistency.Errors.NotFound()); house.__get__cancellationPolicyRel(cb); }).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; House.remoteMethod(&quot;GetCancellationPolicy&quot;, { accepts: [ {arg: 'id', type: 'string', http: {source: 'path'}, description: &quot;House ID&quot;} ], returns: [ { arg: 'cancellationPolicy', type: 'HouseCancellationPolicyDTO', root: true, description: [&quot;Cancellation policy of the house.&quot;] } ], http: {verb: 'get', status: 200, path: &quot;/:id/cancellation-policy&quot;}, description: [&quot;Returns cancellation policy for the house. If nothing existed returns empty object.&quot;] }); House.afterRemote(&quot;GetCancellationPolicy&quot;, Common.RemoteHooks.convert2Dto(&quot;HouseCancellationPolicy&quot;)); } × Search results Close "},"server_lib_utils_lib_persistency_models_available-date.js.html":{"id":"server_lib_utils_lib_persistency_models_available-date.js.html","title":"Source: server/lib/utils/lib/persistency/models/available-date.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/utils/lib/persistency/models/available-date.js &quot;use strict&quot;; // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var moment = require('moment'); var Enum = require('enum'); module.exports = exports; /** * Class `AvailableDate` indicating house available date. * @class */ exports.HouseAvailableDate = class { constructor() { console.log('Calling HouseAvailableDate constructor : ' + arguments); if (arguments &amp;&amp; arguments.length == 2) { this.date = arguments[0]; this.type = arguments[1]; } else { this._date = moment(); this._type = FillType.Default; } } get date() { if (this._date) { return this._date.toDate(); } else { return null; } } set date(value) { //TODO: add validation here if (!value) { this._date = null; } else { this._date = moment(value); } } get type() { if (!this._type) { this._type = FillType.Default; } return this._type.value; } set type(value) { if (!value) { this._type = null; } else { var tempType = FillType.get(value); if (!tempType) { tempType = FillType.Default; } this._type = tempType; } } toJSON() { var ret = { date: this.date, type: this.type }; return ret; } toString() { return JSON.stringify(this.toJSON()); } }; var FillType = new Enum({'Default': 'default', 'ByAdmin': 'by-admin', 'ByOwner': 'by-owner'}, { name: 'HouseAvailableDateFillType', freez: true, ignoreCase: true }); × Search results Close "},"server_models_house_house-available-date.js.html":{"id":"server_models_house_house-available-date.js.html","title":"Source: server/models/house/house-available-date.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/house/house-available-date.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var Enum = require('enum'); var underscore = require('underscore'); var async = require('async'); var debug = require('debug')('narengi:geo:house:available-dates'); var moment = require('moment'); var Common = require('narengi-utils').Common; module.exports = function (HouseAvailableDate) { defineTypes(HouseAvailableDate); defineServices(HouseAvailableDate); }; function defineTypes(HouseAvailableDate) { var fillType = new Enum({ 'Default': 'default', 'ByAdmin': 'by_admin', 'ByOwner': 'by_owner' }, { name: &quot;HouseAvailableDateFillType&quot;, ignoreCase: true, freez: true }); Object.defineProperty(HouseAvailableDate, &quot;FillTypeEnum&quot;, { get: function () { return fillType; } }, { enumerable: true }); HouseAvailableDate.MatchType = function (isAdmin, isOwner) { if (isAdmin) return HouseAvailableDate.FillTypeEnum.get('ByAdmin'); if (isOwner) return HouseAvailableDate.FillTypeEnum.get('ByOwner'); return HouseAvailableDate.FillTypeEnum.get('Default'); }; } function defineServices(HouseAvailableDate) { Object.defineProperty(HouseAvailableDate.prototype, &quot;fillType&quot;, { get: function () { return HouseAvailableDate.FillTypeEnum.get(this.type); } }, { enumerable: false }); /** * Add dates as available dates for `house`. * It adds only non-existing dates in storage. * @param {House} house * @param {array} inDates * @param {boolean} isAdmin * @param {boolean} isOwner * @param {Callback} cb */ HouseAvailableDate.AddDates = function (house, inDates, isAdmin, isOwner, cb) { cb = cb || Common.PromiseCallback(); if (!inDates) { cb(Common.Errors.DataEmpty()); } else { async.waterfall([ function (callback) { house.__get__availableDates(function (err, dates) { callback(null, dates || []); }); }, function (dates, callback) { var persistedDates = underscore.map(dates, function (avDate) { return moment(avDate.date).format(&quot;YYYY-MM-DD&quot;); }); var refined = underscore.difference(inDates, persistedDates); debug(&quot;input dates : %j&quot;, inDates); debug(&quot;persisted dates : %j&quot;, persistedDates); debug(&quot;refined dates : %j&quot;, refined); callback(null, refined); } ], function (err, dates) { if (err) return cb(err); if (!dates || dates.length &lt; 1) return cb(null, []); var fillBy = HouseAvailableDate.MatchType(isAdmin, isOwner); var persistingObjects = underscore.map(dates, function (date) { return { date: date, type: fillBy, houseId: house.id }; }); house.__create__availableDates(persistingObjects, cb); }); } return cb.promise; }; /** * Remove dates as unavailable dates for `house`. * @param {House} house * @param {array} dates * @param {Callback} cb */ HouseAvailableDate.DeleteDates = function (house, dates, cb) { cb = cb || Common.PromiseCallback(); house.__delete__availableDates({ date: {inq: dates} }, cb); return cb.promise; }; /** * Returns dates which are in `startDate`-`endDate` range. * @param {House} house * @param {Date} startDate * @param {Date} endDate * @param {Callback} cb */ HouseAvailableDate.GetDatesInRange = function (house, startDate, endDate, cb) { cb = cb || Common.PromiseCallback(); house.__get__availableDates({ date: {between: [startDate, endDate]} }, function (err, dates) { if (err) return cb(err); cb(null, dates); }); return cb.promise; }; } × Search results Close "},"server_models_house_house-booking-request.js.html":{"id":"server_models_house_house-booking-request.js.html","title":"Source: server/models/house/house-booking-request.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/house/house-booking-request.js 'use strict'; // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var app = serverRequire('server'); var Common = require('narengi-utils').Common; var Pagination = require('narengi-utils').Pagination; var Http = require('narengi-utils').Http; var Persistency = require('narengi-utils').Persistency; var Security = require('narengi-utils').Security; var moment = require('moment'); var async = require('async'); var lodash = require('lodash'); var StateMachine = require('javascript-state-machine'); /** * Booking requests to a house * @namespace HouseBookingRequest */ module.exports = function (Housebookingrequest) { setupStateMachine(Housebookingrequest); addMainServices(Housebookingrequest); }; function addMainServices(Model) { /** * Add request to a house. When an user books a house this request would be created. * @param {String} houseId House ID * @param {Object} data Data * @param {HttpRequest} req * @param {Array} data.dates Array of date-price id's * @param {Callback} cb * @memberOf HouseBookingRequest */ Model.AddRequest = function (houseId, data, req, cb) { cb = cb || Common.PromiseCallback(); async.parallel({ house: function (callback) { app.models.House.findById(houseId).then((house) =&gt; { if (!house) return callback(Persistency.Errors.NotFound({message: 'error.persistency.house.not_found'})); if (house.deleted === true) return callback(Persistency.Errors.NotFound({message: 'error.persistency.house.deleted'})); callback(null, house); }).catch((e) =&gt; { callback(e); }); }, guest: function (callback) { var currentUser = req.getNarengiContext().getCurrentUser(); if (!currentUser) return callback(Security.Errors.NotAuthorized()); app.models.Person.GetByAccountId(currentUser.id).then((person) =&gt; { if (!person) return callback(Persistency.Errors.NotFound({message: 'error.persistency.person.not_found'})); callback(null, person); }).catch((e) =&gt; { callback(e); }); } }, function (err, result) { if (err) return cb(err); //we should forbid house owner to book his/her house if (result.house.ownerId == result.guest.id) { return cb(Common.Errors.GeneralError({message: 'error.house.booking.house_owner_is_requester', statusCode: 403})); } createRequest(result.house, result.guest, cb); }); return cb.promise; /** * * @param {House} house * @param {Person} guest * @param {Callback} cb */ function createRequest(house, guest, cb) { async.waterfall([ function (callback) { app.models.HouseDatePrice.find({where: {id: {inq: data.dates}}}, callback); } ], function (err, dates) { if (err) return cb(err); if (!lodash.isArray(dates)) return cb(Persistency.Errors.NotFound({message: 'error.persistency.house.dates_not_found'})); var obj = { requestDate: moment.utc().toDate(), requesterId: guest.id }; var request = house.bookingRequests.build(obj); request.houseSnapshot(house); request.bookedDates(dates); request.save().then((saved) =&gt; { saved.setupStates(); async.parallel({ houseOwner: function (callback) { async.waterfall([ function (wCallback) { house.owner(wCallback); }, function (hOwnerPerson, wCallback) { if (!hOwnerPerson) return wCallback(Persistency.Errors.NotFound({message: 'error.persistency.house.owner_not_found'})); hOwnerPerson.account(wCallback); } ], callback); }, guest: function (callback) { guest.account(callback); } }, function (err, result) { if (err) return cb(err); var options = { house: house, houseOwner: result.houseOwner, guest: result.guest, cb: function (err, bookRequest) { if (err) return cb(err); cb(null, bookRequest); } }; saved.stateMachine.Book(options); }); }).catch((e) =&gt; { cb(e); }); }); } }; Model.remoteMethod( 'AddRequest', { description: 'Create a new book request.', accepts: [ { arg: 'houseId', type: 'string', required: true, http: {source: 'path'}, description: 'ID of the house to be booked' }, { arg: 'data', type: 'object', required: true, http: {source: 'body'}, description: 'Data attributes to create new instance' }, { arg: 'req', type: 'object', http: {source: 'req'}, description: 'Http request' } ], returns: { arg: 'bookRequest', type: 'object', root: true }, http: { path: &quot;/:houseId&quot;, verb: 'post', status: 201 } } ); //========================================================================= Model.CancelRequest = function (id, req, cb) { cb = cb || Common.PromiseCallback(); async.parallel({ request: function (callback) { Model.findById(id, callback); }, guest: function (callback) { var currentUser = req.getNarengiContext().getCurrentUser(); if (!currentUser) return callback(Security.Errors.NotAuthorized()); app.models.Person.GetByAccountId(currentUser.id).then((person) =&gt; { if (!person) return callback(Persistency.Errors.NotFound({message: 'error.persistency.person.not_found'})); callback(null, person); }).catch((e) =&gt; { callback(e); }); } }, function (err, result) { if (err) return cb(err); var {request, guest} = result; if (!request) { return cb(Persistency.Errors.NotFound({message: 'error.house.booking.request_not_found'})); } if (request.requesterId !== guest.id) { return cb(Common.Errors.GeneralError({message: 'error.house.booking.not_owner', statusCode: 403})); } request.setupStates(); cancelRequest(request, guest, cb); }); return cb.promise; }; Model.remoteMethod( 'CancelRequest', { description: 'Guest cancels his/her request', accepts: [ { arg: 'id', type: 'string', required: true, http: {source: 'path'}, description: 'ID of the house booking request ' }, { arg: 'req', type: 'object', http: {source: 'req'}, description: 'Http request' } ], returns: { arg: 'bookRequest', type: 'object', root: true }, http: { path: &quot;/:id/cancel&quot;, verb: 'put', status: 201 } } ); //========================================================================= Model.RejectRequest = function (id, req, cb) { cb = cb || Common.PromiseCallback(); async.parallel({ request: function (callback) { Model.findById(id, callback); }, houseOwnerPerson: function (callback) { var currentUser = req.getNarengiContext().getCurrentUser(); if (!currentUser) return callback(Security.Errors.NotAuthorized()); app.models.Person.GetByAccountId(currentUser.id).then((person) =&gt; { if (!person) return callback(Persistency.Errors.NotFound({message: 'error.persistency.person.not_found'})); callback(null, person); }).catch((e) =&gt; { callback(e); }); } }, function (err, result) { if (err) return cb(err); var {request, houseOwnerPerson} = result; if (!request) { return cb(Persistency.Errors.NotFound({message: 'error.house.booking.request_not_found'})); } if (houseOwnerPerson.id !== request.houseSnapshot.value().ownerId) { return cb(Common.Errors.GeneralError({message: 'error.house.booking.not_owner', statusCode: 403})); } request.setupStates(); rejectRequest(request, houseOwnerPerson, cb); }); return cb.promise; }; Model.remoteMethod( 'RejectRequest', { description: 'House owner rejects the request', accepts: [ { arg: 'id', type: 'string', required: true, http: {source: 'path'}, description: 'ID of the house booking request ' }, { arg: 'req', type: 'object', http: {source: 'req'}, description: 'Http request' } ], returns: { arg: 'bookRequest', type: 'object', root: true }, http: { path: &quot;/:id/reject&quot;, verb: 'put', status: 201 } } ); //========================================================================= //TODO this service should be done after payment module Model.PayForRequest = function (id, req, cb) { cb = cb || Common.PromiseCallback(); return cb.promise; }; //TODO check if this remote method should be existed or not Model.remoteMethod( 'PayForRequest', { description: 'House owner rejects the request', accepts: [ { arg: 'id', type: 'string', required: true, http: {source: 'path'}, description: 'ID of the house booking request ' }, { arg: 'req', type: 'object', http: {source: 'req'}, description: 'Http request' } ], returns: { arg: 'bookRequest', type: 'object', root: true }, http: { path: &quot;/:id/paid&quot;, verb: 'put', status: 201 } } ); //========================================================================= Model.ConfirmRequest = function (id, data, req, cb) { cb = cb || Common.PromiseCallback(); async.parallel({ request: function (callback) { Model.findById(id, callback); }, houseOwnerPerson: function (callback) { var currentUser = req.getNarengiContext().getCurrentUser(); if (!currentUser) return callback(Security.Errors.NotAuthorized()); app.models.Person.GetByAccountId(currentUser.id).then((person) =&gt; { if (!person) return callback(Persistency.Errors.NotFound({message: 'error.persistency.person.not_found'})); callback(null, person); }).catch((e) =&gt; { callback(e); }); } }, function (err, result) { if (err) return cb(err); var {request, houseOwnerPerson} = result; if (!request) { return cb(Persistency.Errors.NotFound({message: 'error.house.booking.request_not_found'})); } if (houseOwnerPerson.id !== request.houseSnapshot.value().ownerId) { return cb(Common.Errors.GeneralError({message: 'error.house.booking.not_owner', statusCode: 403})); } request.setupStates(); if (request.securityCode !== data.securityCode) { return cb(Common.Errors.GeneralError({message: 'error.house.booking.confirm.wrong_code', statusCode: 400})); } confirmRequest(request, houseOwnerPerson, data.securityCode, cb); }); return cb.promise; }; Model.remoteMethod( 'ConfirmRequest', { description: 'House owner confirms the request', accepts: [ { arg: 'id', type: 'string', required: true, http: {source: 'path'}, description: 'ID of the house booking request ' }, { arg: 'data', type: 'object', required: true, http: {source: 'body'}, description: ['Data attributes :\\n', ' {String} `data.securityCode` '] }, { arg: 'req', type: 'object', http: {source: 'req'}, description: 'Http request' } ], returns: { arg: 'bookRequest', type: 'object', root: true }, http: { path: &quot;/:id/confirm&quot;, verb: 'put', status: 201 } } ); //========================================================================= Model.Settle = function (id, req, cb) { cb = cb || Common.PromiseCallback(); async.parallel({ request: function (callback) { Model.findById(id, callback); }, actor: function (callback) { var currentUser = req.getNarengiContext().getCurrentUser(); if (!currentUser) return callback(Security.Errors.NotAuthorized()); app.models.Person.GetByAccountId(currentUser.id).then((person) =&gt; { if (!person) return callback(Persistency.Errors.NotFound({message: 'error.persistency.person.not_found'})); callback(null, person); }).catch((e) =&gt; { callback(e); }); } }, function (err, result) { if (err) return cb(err); var {request, actor, houseOwnerPerson} = result; if (!request) { return cb(Persistency.Errors.NotFound({message: 'error.house.booking.request_not_found'})); } request.setupStates(); settlement(request, actor, cb); }); return cb.promise; }; //========================================================================= Model.GetAliveRequestsOfGuest = function (req, params, cb) { cb = cb || Common.PromiseCallback(); var currentUser = req.getNarengiContext().getCurrentUser(); if (!currentUser) return callback(Security.Errors.NotAuthorized()); async.waterfall([ function (callback) { app.models.Person.GetByAccountId(currentUser.id, callback); } ], function (err, guestPerson) { if (err) return cb(err); if (!guestPerson) return cb(Persistency.Errors.NotFound({message: 'error.house.booking.person_not_found'})); Model.Alive({ where: {requesterId: guestPerson.id} }, cb); }); return cb.promise; }; Model.remoteMethod( 'GetAliveRequestsOfGuest', { description: 'Returns requests of guest (considering current user is guest)', accepts: [ { arg: 'req', type: 'object', http: {source: 'req'}, description: 'Http request' }, { arg: 'params', type: 'object', http: Http.Params.QueryParams, description: ['Query params eg `?by=house` converts to `{by: &quot;house&quot;}`\\n', 'Allowed params is : `by=house` or nothing\\n', '`by=house` returns the result based on each house\\n', 'and nothing return the `HouseBookingRequest` results'] } ], returns: { arg: 'bookRequest', type: 'array', root: true }, http: { path: &quot;/guest&quot;, verb: 'get', status: 200 } } ); //========================================================================= Model.GetAliveRequestsOfHost = function (req, params, cb) { cb = cb || Common.PromiseCallback(); var currentUser = req.getNarengiContext().getCurrentUser(); if (!currentUser) return callback(Security.Errors.NotAuthorized()); async.parallel({ hostAccount: function (callback) { app.models.Account.GetById(currentUser.id, callback); }, hostPerson: function (callback) { async.waterfall([ function (wCb) { app.models.Person.GetByAccountId(currentUser.id, wCb); } ], function (err, hostPerson) { if (err) return callback(err); if (!hostPerson) return callback(Persistency.Errors.NotFound({message: 'error.house.booking.person_not_found'})); callback(null, hostPerson); }); } }, function (err, result) { if (err) return cb(err); Model.Alive({ where: {'house_snapshot.ownerId': result.hostPerson.id}, include: { relation: 'owner', scope: { include: {relation: 'account'} } }, order: 'requestDate DESC' }, transform(result.hostPerson, result.hostAccount)); }); return cb.promise; function transform(person, account) { return function (err, result) { if (err) return cb(err); var mapped = lodash.map(result, function (item) { return { houseId: item.houseId.toString(), request: item }; }); var reduced = lodash.reduce(mapped, function (result, item) { (result[item.houseId] || (result[item.houseId] = [])).push(item.request); return result; }, {}); var arr = []; lodash.forEach(reduced, function (requests, houseId) { var obj = { house: {}, requests: null }; obj.house.id = houseId; obj.house.detailUrl = requests[0].houseSnapshot.getDetailUrl(); obj.house.type = requests[0].houseSnapshot.type; obj.house.name = requests[0].houseSnapshot.name; obj.house.location = requests[0].houseSnapshot.location; var reqObjects = lodash.map(requests, function (request) { var reqObj = { guest: {} }; reqObj.state = request.state; reqObj.requestDate = request.requestDate; reqObj.dates = request.bookedDates.value(); reqObj.guest.name = request.owner().account().DisplayName; reqObj.guest.location = request.owner().account().profile.value().location; reqObj.guest.detailUrl = request.owner().account().getProfileDetailUrl(); return reqObj; }); obj.requests = reqObjects; arr.push(obj); }); ctx.result = arr; next(); }; } }; Model.remoteMethod( 'GetAliveRequestsOfHost', { description: 'Returns requests of host (considering current user is host)', accepts: [ { arg: 'req', type: 'object', http: {source: 'req'}, description: 'Http request' }, { arg: 'params', type: 'object', http: Http.Params.QueryParams, description: ['Query params eg `?by=house` converts to `{by: &quot;house&quot;}`\\n', 'Allowed params is : `by=house` or nothing\\n', '`by=house` returns the result based on each house\\n', 'and nothing return the `HouseBookingRequest` results'] } ], returns: { arg: 'bookRequest', type: 'array', root: true }, http: { path: &quot;/host&quot;, verb: 'get', status: 200 } } ); } function cancelRequest(request, guest, cb) { async.parallel({ houseOwner: function (callback) { app.models.Account.findById(request.houseSnapshot.value().id, callback); }, guestAccount: function (callback) { guest.account(callback); } }, function (err, result) { if (err) return cb(err); var {houseOwner, guestAccount} = result; if (!houseOwner) { return cb(Persistency.Errors.NotFound({message: 'error.house.booking.house_owner_not_found'})); } if (!guestAccount) { return cb(Persistency.Errors.NotFound({message: 'error.house.booking.guest_account_not_found'})); } request.stateMachine.cancel(houseOwner, guestAccount, cb); }); } function rejectRequest(request, houseOwnerPerson, cb) { async.parallel({ houseOwnerAccount: function (callback) { houseOwnerPerson.account(callback); }, guestAccount: function (callback) { async.waterfall([ function (wCallback) { request.owner(wCallback); }, function (guestPerson, wCallback) { if (!guestPerson) return wCallback(Persistency.Errors.NotFound({message: 'error.house.booking.guest_account_not_found'})); guestPerson.account(wCallback); } ], function (err, result) { if (err) return callback(err); callback(null, result); }); } }, function (err, result) { if (err) return cb(err); var {houseOwnerAccount, guestAccount} = result; if (!houseOwnerAccount) { return cb(Persistency.Errors.NotFound({message: 'error.house.booking.house_owner_not_found'})); } if (!houseOwnerAccount) { return cb(Persistency.Errors.NotFound({message: 'error.house.booking.guest_account_not_found'})); } request.stateMachine.reject(houseOwnerAccount, guestAccount, cb); }); } function confirmRequest(request, houseOwnerPerson, securityCode, cb) { async.parallel({ houseOwnerAccount: function (callback) { houseOwnerPerson.account(callback); }, guestAccount: function (callback) { async.waterfall([ function (wCallback) { request.owner(wCallback); }, function (guestPerson, wCallback) { if (!guestPerson) return wCallback(Persistency.Errors.NotFound({message: 'error.house.booking.guest_account_not_found'})); guestPerson.account(wCallback); } ], function (err, result) { if (err) return callback(err); callback(null, result); }); } }, function (err, result) { if (err) return cb(err); var {houseOwnerAccount, guestAccount} = result; if (!houseOwnerAccount) { return cb(Persistency.Errors.NotFound({message: 'error.house.booking.house_owner_not_found'})); } if (!guestAccount) { return cb(Persistency.Errors.NotFound({message: 'error.house.booking.guest_account_not_found'})); } request.stateMachine.confirm(houseOwnerAccount, guestAccount, securityCode, cb); }); } function settlement(request, actor, cb) { async.parallel({ houseOwnerAccount: function (callback) { async.waterfall([ function (wCallback) { request.houseSnapshot.value().owner(wCallback); }, function (houseOwnerPerson, wCallback) { if (!houseOwnerPerson) return wCallback(Persistency.Errors.NotFound({message: 'error.house.booking.house-owner_not_found'})); houseOwnerPerson.account(wCallback); } ], function (err, result) { if (err) return callback(err); callback(null, result); }); houseOwnerPerson.account(callback); }, actorAccount: function (callback) { actor.account(callback); }, guestAccount: function (callback) { async.waterfall([ function (wCallback) { request.owner(wCallback); }, function (guestPerson, wCallback) { if (!guestPerson) return wCallback(Persistency.Errors.NotFound({message: 'error.house.booking.guest_account_not_found'})); guestPerson.account(wCallback); } ], function (err, result) { if (err) return callback(err); callback(null, result); }); } }, function (err, result) { if (err) return cb(err); var {actorAccount, guestAccount, houseOwnerAccount} = result; if (!actorAccount) { return cb(Persistency.Errors.NotFound({message: 'error.house.booking.actor_not_found'})); } if (!houseOwnerAccount) { return cb(Persistency.Errors.NotFound({message: 'error.house.booking.house_owner_not_found'})); } if (!guestAccount) { return cb(Persistency.Errors.NotFound({message: 'error.house.booking.guest_account_not_found'})); } request.stateMachine.settlement(actorAccount, houseOwnerAccount, guestAccount, cb); }); } function setupStateMachine(Model) { //NOTE that all business logic of the booking are done in this class /** * Handles all lifecycle of a book request. * Actually this is a finite state machine. * @class RequestState * @memberOf HouseBookingRequest */ class RequestState { constructor(bookRequest) { this.bookRequest = bookRequest; } //NOTE that we have to use `onbeforeX` hook, because we have some async operations which should be done in these hooks //And just `onbeforeX` has this functionality //action &quot;Book&quot; causes /** * * @param {String} event * @param {String} from * @param {String} to * @param {Object} options * @param {House} options.house * @param {Account} options.houseOwner * @param {Account} options.guest * @param {Callback} options.cb * @returns {string} */ onleaveNONE(event, from, to, options) { var self = this; var {house, houseOwner, guest, cb} = options; /** * 1) Send email to host denoting a guest issues a book request * 2) Send sms to host denoting a guest issues a book request * 3) Persist log of book request process * * The result of this event callback is the book request passed in */ async.parallel({ request: function (callback) { self.bookRequest.updateAttribute('state', 'ISSUED', callback); }, email: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendEmailBookRequestIssuedToHost(houseOwner.email, houseOwner, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, sms: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendSMSBookRequestIssuedToHost(houseOwner.cellNumber, houseOwner, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, eventPersistency: function (callback) { app.models.HouseBookingRequestMQPersister.Persist(self.bookRequest, event, from, to).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); } }, function (err, result) { if (err) { cb(err); self.transition(); return; } cb(null, result.request); self.transition(); }); return StateMachine.ASYNC; } /** * * @param {String} event * @param {String} from * @param {String} to * @param {Object} options * @param {Account} options.houseOwner * @param {Account} options.guest * @param {Callback} options.cb * @returns {String} */ onleaveISSUED(event, from, to, options) { var {houseOwner, guest, cb} = options; switch (event) { case 'CancelIssued': return this.doCancelIssued(houseOwner, guest, cb); break; case 'RejectIssued': return this.doRejectIssued(houseOwner, guest, cb); break; case 'Accept': return this.doAccept(houseOwner, guest, cb); break; default: break; } //illegal . should not happen cb(Common.Errors.GeneralError({message: 'error.house.booking.illegal_situation', statusCode: 500})); } /** * * @param {String} event * @param {String} from * @param {String} to * @param {Object} options * @param {Account} options.houseOwner * @param {Account} options.guest * @param {Callback} options.cb * @returns {String} */ onleaveACCEPTED(event, from, to, options) { var {houseOwner, guest, cb} = options; switch (event) { case 'CancelAccepted': return this.doCancelAccepted(houseOwner, guest, cb); break; case 'RejectAccepted': return this.doRejectAccepted(houseOwner, guest, cb); break; case 'Pay': return this.doPay(houseOwner, guest, cb); break; default: break; } //illegal . should not happen cb(Common.Errors.GeneralError({message: 'error.house.booking.illegal_situation', statusCode: 500})); } /** * * @param {String} event * @param {String} from * @param {String} to * @param {Object} options * @param {Account} options.houseOwner * @param {Account} options.guest * @param {String} options.securityCode (OPTIONAL) * @param {Callback} options.cb * @returns {String} */ onleavePAID(event, from, to, options) { var {houseOwner, guest, cb} = options; switch (event) { case 'CancelPaid': return this.doCancelPaid(houseOwner, guest, cb); break; case 'RejectPaid': return this.doRejectPaid(houseOwner, guest, cb); break; case 'Confirm': return this.doConfirm(houseOwner, guest, options.securityCode, cb); break; default: break; } //illegal . should not happen cb(Common.Errors.GeneralError({message: 'error.house.booking.illegal_situation', statusCode: 500})); } /** * * @param {String} event * @param {String} from * @param {String} to * @param {Object} options * @param {Account} options.actor * @param {Account} options.houseOwner * @param {Account} options.guest * @param {Callback} options.cb * @returns {String} */ onleaveCONFIRMED(event, from, to, options) { return this.doSettle(options.actor, options.houseOwner, options.guest, options.cb); } // business methods /** * Cancels a request. Decides based on current state * @param {Account} houseOwner * @param {Account} guest * @param {Callback} cb * @memberOf HouseBookingRequest.RequestState */ cancel(houseOwner, guest, cb) { switch (this.current) { case 'ISSUED': return this.CancelIssued({houseOwner: houseOwner, guest: guest, cb: cb}); break; case 'ACCEPTED': return this.CancelAccepted({houseOwner: houseOwner, guest: guest, cb: cb}); break; case 'PAID': return this.CancelPaid({houseOwner: houseOwner, guest: guest, cb: cb}); break; default: break; } return cb(Common.Errors.GeneralError({message: 'error.house.booking.cancel_not_allowed_by_state', statusCode: 403})); } /** * House owner rejects the request * @param {Account} houseOwner * @param {Account} guest * @param {Callback} cb * @memberOf HouseBookingRequest.RequestState */ reject(houseOwner, guest, cb) { switch (this.current) { case 'ISSUED': return this.RejectIssued({houseOwner: houseOwner, guest: guest, cb: cb}); break; case 'ACCEPTED': return this.RejectAccepted({houseOwner: houseOwner, guest: guest, cb: cb}); break; case 'PAID': return this.RejectPaid({houseOwner: houseOwner, guest: guest, cb: cb}); break; default: break; } return cb(Common.Errors.GeneralError({message: 'error.house.booking.cancel_not_allowed_by_state', statusCode: 403})); } /** * House owner confirms the request * @param {Account} houseOwnerAccount * @param {Account} guestAccount * @param {String} securityCode * @param {Callback} cb */ confirm(houseOwnerAccount, guestAccount, securityCode, cb) { if (this.current === 'PAID') { return this.Confirm({houseOwner: houseOwnerAccount, guest: guestAccount, securityCode: securityCode, cb: cb}); } return cb(Common.Errors.GeneralError({message: 'error.house.booking.cancel_not_allowed_by_state', statusCode: 403})); } /** * * @param {Account} actorAccount eg admin * @param {Account} houseOwnerAccount * @param {Account} guestAccount * @param {Callback} cb */ settlement(actorAccount, houseOwnerAccount, guestAccount, cb) { if (this.current === 'CONFIRMED') { return this.Settle({actor: actorAccount, houseOwner: houseOwnerAccount, guest: guestAccount, cb: cb}); } return cb(Common.Errors.GeneralError({message: 'error.house.booking.cancel_not_allowed_by_state', statusCode: 403})); } /** * * @param {Account} houseOwner * @param {Account} guest * @param {Callback} cb * @memberOf HouseBookingRequest.RequestState * @private */ doCancelIssued(houseOwner, guest, cb) { var self = this; var house = this.houseSnapshot.value(); /** * 1) Send email to host denoting a guest cancels a book request * 2) Send sms to host denoting a guest cancels a book request * 3) Persist log of book request process * * The result of this event callback is the book request passed in */ async.parallel({ request: function (callback) { self.bookRequest.updateAttribute('state', 'CANCELED', callback); }, email: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendEmailBookRequestCanceledToHost(houseOwner.email, houseOwner, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, sms: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendSMSBookRequestCanceledToHost(houseOwner.cellNumber, houseOwner, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, eventPersistency: function (callback) { app.models.HouseBookingRequestMQPersister.Persist(self.bookRequest, 'CancelIssued', 'ISSUED', 'CANCELED').then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); } }, function (err, result) { if (err) { cb(err); self.transition(); return; } cb(null, result.request); self.transition(); }); return StateMachine.ASYNC; } /** * * @param {Account} houseOwner * @param {Account} guest * @param {Callback} cb * @memberOf HouseBookingRequest.RequestState * @private */ doRejectIssued(houseOwner, guest, cb) { var self = this; var house = this.houseSnapshot.value(); /** * 1) Send email to host denoting a house owner rejects a book request * 2) Send sms to host denoting a house owner rejects a book request * 3) Persist log of book request process * * The result of this event callback is the book request passed in */ async.parallel({ request: function (callback) { self.bookRequest.updateAttribute('state', 'REJECTED', callback); }, email: function (callback) { var locals = { displayName: guest.DisplayName, houseName: house.name, guestName: houseOwner.DisplayName }; app.models.Notification.SendEmailBookRequestRejectedToGuest(guest.email, guest, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, sms: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendSMSBookRequestRejectedToGuest(guest.cellNumber, guest, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, eventPersistency: function (callback) { app.models.HouseBookingRequestMQPersister.Persist(self.bookRequest, 'RejectIssued', 'ISSUED', 'REJECTED').then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); } }, function (err, result) { if (err) { cb(err); self.transition(); return; } cb(null, result.request); self.transition(); }); return StateMachine.ASYNC; } /** * * @param {Account} houseOwner * @param {Account} guest * @param {Callback} cb * @memberOf HouseBookingRequest.RequestState * @private */ doAccept(houseOwner, guest, cb) { var self = this; var house = this.houseSnapshot.value(); /** * 1) Send email to host denoting a house owner accepts a book request * 2) Send sms to host denoting a house owner accepts a book request * 3) Persist log of book request process * * The result of this event callback is the book request passed in */ async.parallel({ request: function (callback) { self.bookRequest.updateAttribute('state', 'ACCEPTED', callback); }, email: function (callback) { var locals = { displayName: guest.DisplayName, houseName: house.name, guestName: houseOwner.DisplayName }; app.models.Notification.SendEmailBookRequestAcceptedToGuest(guest.email, guest, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, sms: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendSMSBookRequestAcceptedToGuest(guest.cellNumber, guest, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, eventPersistency: function (callback) { app.models.HouseBookingRequestMQPersister.Persist(self.bookRequest, 'Accept', 'ISSUED', 'ACCEPTED').then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); } }, function (err, result) { if (err) { cb(err); self.transition(); return; } cb(null, result.request); self.transition(); }); return StateMachine.ASYNC; } /** * * @param {Account} houseOwner * @param {Account} guest * @param {Callback} cb * @memberOf HouseBookingRequest.RequestState * @private */ doCancelAccepted(houseOwner, guest, cb) { var self = this; var house = this.houseSnapshot.value(); /** * 1) Send email to host denoting a guest cancels a book request * 2) Send sms to host denoting a guest cancels a book request * 3) Persist log of book request process * * The result of this event callback is the book request passed in */ async.parallel({ request: function (callback) { self.bookRequest.updateAttribute('state', 'CANCELED', callback); }, email: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendEmailBookRequestCanceledToHost(houseOwner.email, houseOwner, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, sms: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendSMSBookRequestCanceledToHost(houseOwner.cellNumber, houseOwner, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, eventPersistency: function (callback) { app.models.HouseBookingRequestMQPersister.Persist(self.bookRequest, 'CancelAccepted', 'ACCEPTED', 'CANCELED').then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); } }, function (err, result) { if (err) { cb(err); self.transition(); return; } cb(null, result.request); self.transition(); }); return StateMachine.ASYNC; } /** * * @param {Account} houseOwner * @param {Account} guest * @param {Callback} cb * @memberOf HouseBookingRequest.RequestState * @private */ doRejectAccepted(houseOwner, guest, cb) { var self = this; var house = this.houseSnapshot.value(); /** * 1) Send email to host denoting a house owner rejects a book request * 2) Send sms to host denoting a house owner rejects a book request * 3) Persist log of book request process * * The result of this event callback is the book request passed in */ async.parallel({ request: function (callback) { self.bookRequest.updateAttribute('state', 'ISSUED', callback); }, email: function (callback) { var locals = { displayName: guest.DisplayName, houseName: house.name, guestName: houseOwner.DisplayName }; app.models.Notification.SendEmailBookRequestRejectAcceptedToGuest(guest.email, guest, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, sms: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendSMSBookRequestRejectAcceptedToGuest(guest.cellNumber, guest, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, eventPersistency: function (callback) { app.models.HouseBookingRequestMQPersister.Persist(self.bookRequest, 'RejectAccepted', 'ACCEPTED', 'ISSUED').then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); } }, function (err, result) { if (err) { cb(err); self.transition(); return; } cb(null, result.request); self.transition(); }); return StateMachine.ASYNC; } /** * * @param {Account} houseOwner * @param {Account} guest * @param {Callback} cb * @memberOf HouseBookingRequest.RequestState * @private */ doPay(houseOwner, guest, cb) { var self = this; var house = this.houseSnapshot.value(); /** * 1) Send email to host denoting a house owner accepts a book request * 2) Send sms to host denoting a house owner accepts a book request * 3) Persist log of book request process * * The result of this event callback is the book request passed in */ async.parallel({ request: function (callback) { self.bookRequest.updateAttributes({ state: 'PAID', securityCode: require('randomstring').generate({length: 6, charset: 'numeric'}) }, callback); }, email: function (callback) { var locals = { displayName: guest.DisplayName, houseName: house.name, guestName: houseOwner.DisplayName }; app.models.Notification.SendEmailBookRequestAcceptedToGuest(guest.email, guest, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, sms: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendSMSBookRequestAcceptedToGuest(guest.cellNumber, guest, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, eventPersistency: function (callback) { app.models.HouseBookingRequestMQPersister.Persist(self.bookRequest, 'Pay', 'ACCEPTED', 'PAID').then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); } }, function (err, result) { if (err) { cb(err); self.transition(); return; } cb(null, result.request); self.transition(); }); return StateMachine.ASYNC; } /** * * @param {Account} houseOwner * @param {Account} guest * @param {Callback} cb * @memberOf HouseBookingRequest.RequestState * @private */ doCancelPaid(houseOwner, guest, cb) { var self = this; var house = this.houseSnapshot.value(); /** * 1) Send email to host denoting a guest cancels a book request * 2) Send sms to host denoting a guest cancels a book request * 3) Persist log of book request process * * The result of this event callback is the book request passed in */ async.parallel({ request: function (callback) { self.bookRequest.updateAttribute('state', 'CANCELED', callback); }, email: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendEmailBookRequestCanceledToHost(houseOwner.email, houseOwner, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, sms: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendSMSBookRequestCanceledToHost(houseOwner.cellNumber, houseOwner, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, eventPersistency: function (callback) { app.models.HouseBookingRequestMQPersister.Persist(self.bookRequest, 'CancelPaid', 'PAID', 'CANCELED').then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); } }, function (err, result) { if (err) { cb(err); self.transition(); return; } cb(null, result.request); self.transition(); }); return StateMachine.ASYNC; } /** * * @param {Account} houseOwner * @param {Account} guest * @param {Callback} cb * @memberOf HouseBookingRequest.RequestState * @private */ doRejectPaid(houseOwner, guest, cb) { var self = this; var house = this.houseSnapshot.value(); /** * 1) Send email to host denoting a house owner rejects a book request * 2) Send sms to host denoting a house owner rejects a book request * 3) Persist log of book request process * * The result of this event callback is the book request passed in */ async.parallel({ request: function (callback) { self.bookRequest.updateAttribute('state', 'ISSUED', callback); }, email: function (callback) { var locals = { displayName: guest.DisplayName, houseName: house.name, guestName: houseOwner.DisplayName }; app.models.Notification.SendEmailBookRequestRejectPaidToGuest(guest.email, guest, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, sms: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendSMSBookRequestRejectPaidToGuest(guest.cellNumber, guest, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, eventPersistency: function (callback) { app.models.HouseBookingRequestMQPersister.Persist(self.bookRequest, 'RejectPaid', 'PAID', 'ISSUED').then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); } }, function (err, result) { if (err) { cb(err); self.transition(); return; } cb(null, result.request); self.transition(); }); return StateMachine.ASYNC; } /** * * @param {Account} houseOwner * @param {Account} guest * @param {String} securityCode (entered by house owner) * @param {Callback} cb * @memberOf HouseBookingRequest.RequestState * @private */ doConfirm(houseOwner, guest, securityCode, cb) { var self = this; var house = this.houseSnapshot.value(); /** * 1) Send email to host denoting a house owner confirms the book request * 2) Send sms to host denoting a house owner confirms the book request * 3) Persist log of book request process * * The result of this event callback is the book request passed in */ async.parallel({ request: function (callback) { self.bookRequest.updateAttributes({ state: 'CONFIRMED' }, callback); }, email: function (callback) { var locals = { displayName: guest.DisplayName, houseName: house.name, guestName: houseOwner.DisplayName }; app.models.Notification.SendEmailBookRequestConfirmToGuest(guest.email, guest, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, sms: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendSMSBookRequestConfirmToGuest(guest.cellNumber, guest, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, eventPersistency: function (callback) { app.models.HouseBookingRequestMQPersister.Persist(self.bookRequest, 'Confirm', 'PAID', 'CONFIRMED').then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); } }, function (err, result) { if (err) { cb(err); self.transition(); return; } cb(null, result.request); self.transition(); }); return StateMachine.ASYNC; } /** * * @param {Account} actor * @param {Account} houseOwner * @param {Account} guest * @param {Callback} cb * @memberOf HouseBookingRequest.RequestState * @private */ doSettle(actor, houseOwner, guest, cb) { var self = this; var house = this.houseSnapshot.value(); /** * 1) Send email to host denoting payment settled to guest * 2) Send sms to host denoting payment settled to guest * 3) Send email to guest denoting payment settled to guest * 4) Send sms to guest denoting payment settled to guest * 5) Persist log of book request process * * The result of this event callback is the book request passed in */ async.parallel({ request: function (callback) { self.bookRequest.updateAttributes({ state: 'SETTLED' }, callback); }, emailToGuest: function (callback) { var locals = { displayName: guest.DisplayName, houseName: house.name, guestName: houseOwner.DisplayName }; app.models.Notification.SendEmailBokRequestSettlementToGuest(guest.email, guest, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, smsToGuest: function (callback) { var locals = { displayName: guest.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendSMSBokRequestSettlementToGuest(guest.cellNumber, guest, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, emailToHost: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendEmailBokRequestSettlementToHost(houseOwner.email, houseOwner, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, smsToHost: function (callback) { var locals = { displayName: houseOwner.DisplayName, houseName: house.name, guestName: guest.DisplayName }; app.models.Notification.SendSMSBokRequestSettlementToHost(houseOwner.cellNumber, houseOwner, locals).then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); }, eventPersistency: function (callback) { app.models.HouseBookingRequestMQPersister.Persist(self.bookRequest, 'Settle', 'CONFIRMED', 'SETTLED').then((res) =&gt; { callback(null, res); }).catch((e) =&gt; { callback(null, null); }); } }, function (err, result) { if (err) { cb(err); self.transition(); return; } cb(null, result.request); self.transition(); }); return StateMachine.ASYNC; } } Model.prototype.setupStates = function () { var reqState = new RequestState(this); var self = this; var sm = StateMachine.create({ target: reqState, initial: self.state, events: [ {name: 'Book', from: 'NONE', to: 'ISSUED'}, {name: 'CancelIssued', from: 'ISSUED', to: 'CANCELED'}, {name: 'RejectIssued', from: 'ISSUED', to: 'REJECTED'}, {name: 'Accept', from: 'ISSUED', to: 'ACCEPTED'}, {name: 'CancelAccepted', from: 'ACCEPTED', to: 'CANCELED'}, {name: 'RejectAccepted', from: 'ACCEPTED', to: 'ISSUED'}, {name: 'Pay', from: 'ACCEPTED', to: 'PAID'}, {name: 'CancelPaid', from: 'PAID', to: 'CANCELED'}, {name: 'RejectPaid', from: 'PAID', to: 'ISSUED'}, {name: 'Confirm', from: 'PAID', to: 'CONFIRMED'}, {name: 'Settle', from: 'CONFIRMED', to: 'SETTLED'} ], error: function (eventName, from, to, args, errorCode, errorMessage) { //TODO: Handle errors } }); this.stateMachine = sm; }; } × Search results Close "},"server_models_house_house-booking-request-mq-persister.js.html":{"id":"server_models_house_house-booking-request-mq-persister.js.html","title":"Source: server/models/house/house-booking-request-mq-persister.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/house/house-booking-request-mq-persister.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var app = serverRequire('server'); var Common = require('narengi-utils').Common; var Persistency = require('narengi-utils').Persistency; var moment = require('moment'); var async = require('async'); var MQ = require('bull'); /** * This module is responsible for persisting logs of house book request lifecycle * @namespace HouseBookingRequestMQPersister */ module.exports = function(Model) { setupMQ(Model); addServices(Model); }; function setupMQ(Model){ Model.PersisterQ = MQ('house-book-request:persister', app.settings.notification.redis.port, app.settings.notification.redis.host, app.settings.notification.redis); Model.PersisterQ.process(function (job, done) { var data = job.data; async.waterfall([ function(callback){ Model.create({requestId: data.bookRequest.id, event: data.event, from: data.from, to: data.to}, callback); }, function(entity, callback){ if(!entity) return callback(Persistency.Errors.NotSaved()); entity.request.create(data.request, callback); } ], function(err, result){ if(err) return done(err); done(null, job); }); }); Model.PersisterQ.on('failed', function (error) { //TODO log }); Model.PersisterQ.on('error', function (error) { //TODO log }); } function addServices(Model){ /** * Quques a job processing changes to states of house book request `HouseBookingRequest` * @param {HouseBookingRequest} bookRequest * @param {String} event * @param {String} from * @param {String} to * @param {Callback} cb * @memberOf HouseBookingRequestMQPersister */ Model.Persist = function(bookRequest, event, from, to, cb){ cb = cb || Common.PromiseCallback(); Model.PersisterQ.add({bookRequest: bookRequest, event: event, from: from, to: to, data: moment.utc().toDate()}, {attempts: 10, backoff: {type: 'fixed', delay: 30000}}, cb); return cb.promise; }; } × Search results Close "},"server_models_house_house-date-price.js.html":{"id":"server_models_house_house-date-price.js.html","title":"Source: server/models/house/house-date-price.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/house/house-date-price.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var Common = require('narengi-utils').Common; var Persistency = require('narengi-utils').Persistency; var async = require('async'); var underscore = require('underscore'); var moment = require('moment'); var debug = require('debug')('narengi:geo:house:date-price'); var app = serverRequire('server'); module.exports = function (HouseDatePrice) { defineServices(HouseDatePrice); }; function defineServices(HouseDatePrice) { /** * Add price for each date. * Any date is acceptable. Dates are not needed to be available date. * @param {House} house House model * @param {array} datePricesIn JS Date. An array containing objects with fields `date` and `price` object. * ``` * [ * { * date: &quot;&quot;, * price: {amount: N, currency: &quot;&quot;} * } * ] * ``` * @param {Callback} cb * @returns {Promise} */ HouseDatePrice.AddOrUpdate = function (house, datePricesIn, cb) { if (!datePricesIn) return cb(Persistency.Errors.DataEmpty()); cb = cb || Common.PromiseCallback(); var Currency = app.models.Currency; async.waterfall([ //refine inputs function (callback) { var defCurrency = Currency.Default.toString(); var withoutRedundant = {}; underscore.each(datePricesIn, function (item) { item.date = moment.utc(item.date).format(&quot;YYYY-MM-DD&quot;); if (!item.price) { item.price = {}; } item.price = underscore.defaults(item.price, {amount: 0, currency: defCurrency}); if (!Currency.Get(item.price.currency)) item.price.currency = defCurrency; withoutRedundant[item.date] = item; }); datePricesIn = underscore.values(withoutRedundant); debug(&quot;AddOrUpdate() =&gt; refined input : %j&quot;, datePricesIn); callback(null, datePricesIn); }, //find existing function (datePrices, callback) { var dateRange = underscore.map(datePrices, function (item) { return item.date; }); house.__get__prices({ where: {date: {inq: dateRange}} }, function (err, dates) { if (err) return callback(err); dates = dates || []; underscore.each(dates, function (item) { item.date = moment.utc(item.date).format(&quot;YYYY-MM-DD&quot;); }); callback(null, dates, datePrices, dateRange); }); }, //split `datePrices` which are persisted function (existingPersisted, datePrices, dateRange, callback) { var datePricesToBeUpdated = underscore.map(existingPersisted, function (item) { return { entity: item, data: underscore.find(datePrices, function (datePrice) { return moment.utc(datePrice.date).isSame(item.date); }) }; }); datePricesToBeUpdated = underscore.filter(datePricesToBeUpdated, function (item) { return item.entity &amp;&amp; item.data; }); var datePricesToBeInserted = underscore.difference(datePrices, underscore.pluck(datePricesToBeUpdated, &quot;data&quot;)); debug(&quot;AddOrUpdate() =&gt; Existing DatePrices : %j&quot;, existingPersisted); debug(&quot;AddOrUpdate() =&gt; ToBeUpdated : %j&quot;, datePricesToBeUpdated); debug(&quot;AddOrUpdate() =&gt; ToBeInserted : %j&quot;, datePricesToBeInserted); callback(null, datePricesToBeInserted, datePricesToBeUpdated); } ], //datePricesToBeUpdated is an array of `object` like //``` // {entity: object, data: object} //``` function (err, datePricesToBeInserted, datePricesToBeUpdated) { if (err) return cb(err); async.parallel([ //insert function (callback) { house.__create__prices(datePricesToBeInserted, function (e, result) { if (e) return callback(e); callback(null, result); }); }, //update function (callback) { var updatedList = []; async.each(datePricesToBeUpdated, function (toBeUpdated, toBeUpdatedCallback) { toBeUpdated.entity.updateAttributes(toBeUpdated.data, function (innerErr, updatedEntity) { if (innerErr) return toBeUpdatedCallback(innerErr); updatedList.push(updatedEntity); toBeUpdatedCallback(null); }); }, function (err) { if (err) return callback(err); callback(null, updatedList); }); } ], function (pErr, result) { if (pErr) return cb(pErr); result = underscore.flatten(result, true); debug(&quot;AddOrUpdate() =&gt; The result is : %j&quot;, result); cb(null, result); }); }); return cb.promise; }; //======================================================================================== /** * Returns all date prices between `startDate` and `endDate`. * Implicitly this method create a default price for dates not existed in storage. * Dates are inclusive. * @param {House} house * @param {string} startDate Start date string in ISO format * @param {string} endDate End date string in ISO format * @param {Callback} cb * @returns {Promise} */ HouseDatePrice.GetInRange = function (house, startDate, endDate, cb) { cb = cb || Common.PromiseCallback(); var defCurrency = app.models.Currency.Default.toString(); var defPrice = {amount: 0, currency: defCurrency}; async.waterfall([ //create date range function (callback) { dates = Common.Dates.DateRange(startDate, endDate); debug(&quot;GetInRange() =&gt; Refined dates : %j&quot;, dates); callback(null, dates); }, //find persisted function (dates, callback) { //should clone because database connector change format of `dates` array var clonedDates = underscore.clone(dates); house.prices( { where: {date: {inq: clonedDates}}, order: &quot;date ASC&quot; }, function (error, foundEntities) { if (error) return callback(error); callback(null, foundEntities || [], dates); }); }, //create default values for those one not persisted function (foundEntities, dates, callback) { var persistedDates = underscore.map(foundEntities, function (item) { console.log(item); return moment.utc(item.date).format(&quot;YYYY-MM-DD&quot;); }); var unPersistedDates = underscore.difference(dates, persistedDates); var toBeMerged = underscore.map(unPersistedDates, function (item) { return { //houseId: house.id, //not needed. because it's fake data not to be persisted date: moment.utc(item).toDate(), price: defPrice }; }); debug(&quot;GetInRange() =&gt; Persisted dates : %j&quot;, persistedDates); debug(&quot;GetInRange() =&gt; To be merged if not existed objects : %j&quot;, unPersistedDates); var result = toBeMerged.concat(foundEntities); callback(null, result); } ], function (error, result) { debug(&quot;GetInRange() =&gt; Final result : %j&quot;, result); if (error) return cb(error); result = result || []; result = underscore.sortBy(result, function(item){ return moment.utc(item.date).toDate(); }); cb(null, result); }); return cb.promise; }; //======================================================================================== /** * Set prices of dates which are in date range between `startDate` and `endDate` to zero. * @param {House} house * @param {array} dates Array of date strings in ISO format * @param {Callback} cb * @returns {Promise} */ HouseDatePrice.UnSetInRange = function (house, dates, cb) { cb = cb || Common.PromiseCallback(); var defCurrency = app.models.Currency.Default.toString(); dates = Common.Dates.Normalize(dates); async.waterfall([ //find those one to be unset function (callback) { house.prices({date: {inq: dates}}, function (error, entities) { if (error) return callback(error); callback(null, entities || []); }); }, //do unset function (entities, callback) { async.each(entities, function (datePrice, eachCallback) { datePrice.updateAttributes({price: {amount: 0, currency: defCurrency}}, function (error, updated) { if (error) return eachCallback(error); eachCallback(null); }); }, function (error) { if (error) return callback(error); callback(null); }); } ], function (error, result) { if (error) return cb(error); cb(null, []); }); return cb.promise; }; } × Search results Close "},"server_models_house_house-price-profile.js.html":{"id":"server_models_house_house-price-profile.js.html","title":"Source: server/models/house/house-price-profile.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/house/house-price-profile.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var Common = require('narengi-utils').Common; var Persistency = require('narengi-utils').Persistency; var debug = require('debug')('narengi:geo:house:price-profile'); var app = serverRequire('server'); var underscore = require('underscore'); module.exports = function (HousePriceProfile) { defineServices(HousePriceProfile); }; function refineInputData(data) { if (!data) return; var defPrice = app.models.Price.ZeroValue(); if (data.extraGuestFee) { data.extraGuestFee = underscore.defaults(data.extraGuestFee, defPrice); } if (data.securityDeposit) { data.securityDeposit = underscore.defaults(data.securityDeposit, defPrice); } } function defineServices(HousePriceProfile) { /** * Set/Update price profile * @param {House} house * @param {object} data Input Data * @param {Callback} cb * @returns {Promise} */ HousePriceProfile.SetForHouse = function (house, data, cb) { cb = cb || Common.PromiseCallback(); debug(&quot;SetForHouse() =&gt; Input data : %j&quot;, data); refineInputData(data); if (!house.priceProfile.value()) { house.priceProfile.build({}); } house.priceProfile.update(data).then(Persistency.CrudHandlers.successHandler(cb)).catch(Persistency.CrudHandlers.failureHandler(cb)); return cb.promise; }; } × Search results Close "},"server_lib_http-context_index.js.html":{"id":"server_lib_http-context_index.js.html","title":"Source: server/lib/http-context/index.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/http-context/index.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // /** * @namespace http-context */ module.exports = exports; //exports.perRequest = require('./middleware/per-request'); exports.Context = require('./context'); × Search results Close "},"server_lib_http-context_middleware_per-request.js.html":{"id":"server_lib_http-context_middleware_per-request.js.html","title":"Source: server/lib/http-context/middleware/per-request.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/http-context/middleware/per-request.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var Context = require('../context'); var LoopbackContext = require('loopback-context'); module.exports = perRequestContextFactory; /** * Create a context and assign to current http request * @param options * @property options.name Name of context which is be accessible through the http request * @returns {Function} Middleware * @memberOf http-context */ function perRequestContextFactory(options) { options = options || {}; var name = options.name || &quot;narengi_context&quot;; return function (req, res, next) { var context = LoopbackContext.getCurrentContext(); if (!context) { return next(); } var ctx = context.get(name); if (!ctx) { return next(); } ctx = Context.CreateContext(name); LoopbackContext.getCurrentContext().set(name, ctx); req[name] = ctx; next(); } } × Search results Close "},"common_models_image.js.html":{"id":"common_models_image.js.html","title":"Source: common/models/image.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: common/models/image.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var nodePath = require('path'); var underscore = require('underscore'); module.exports = function (Image) { /** * This is just an data holder and not be an independent persistent **/ Image.MakeFromFormidable = function (root, file) { if(!file){ return {}; } return { filename: file.name, size: file.size, type: file.type }; }; /** * Converts an array to result array * This is just an data holder and not be an independent persistent **/ Image.MakeFromFormidableArray = function (root, files) { if(!files){ return []; } return underscore.map(files, function(file){ return { filename: file.name, size: file.size, type: file.type }; }); }; /** * Converts db images to api images * @param files * @constructor */ Image.MakeFromDbArray = function(files){ if(!files){ return []; } return underscore.map(files, function(file){ return { filename: file.filename, size: file.size, type: file.type }; }); }; }; × Search results Close "},"server_lib_utils_lib_security_security.js.html":{"id":"server_lib_utils_lib_security_security.js.html","title":"Source: server/lib/utils/lib/security/security.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/utils/lib/security/security.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var PersistencyErrors = require('narengi-utils').Persistency.Errors; var async = require('async'); var loopback = require('loopback'); module.exports = exports; /** * Check is input user is in `ADMIN` role or not * @param {Application} app * @param {string} usernameOrEmail * @returns {Promise} */ exports.isUserAdmin = function (usernameOrEmail) { var Account = loopback.findModel('Account'); var Role = loopback.findModel('Role'); function executor(resolve, reject) { async.waterfall([ function (callback) { Account.findByUsernameOrEmail(usernameOrEmail, callback); }, function (account, callback) { if(!account) return callback(PersistencyErrors.NotFound()); Role.isInRole(Role.ADMIN, { model: &quot;Account&quot;, modelId: account.id, principalType: &quot;Account&quot;, principalId: account.id }, function (err, isInRole) { if (err) return callback(null, false); callback(null, isInRole === true); }); } ], function (err, result) { if (err) return reject(PersistencyErrors.NotFound()); resolve(result); }); } return new Promise(executor); }; × Search results Close "},"server_mixins_is-admin.js.html":{"id":"server_mixins_is-admin.js.html","title":"Source: server/mixins/is-admin.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/mixins/is-admin.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var loopback = require('loopback'); var LoopBackContext = require('loopback-context'); var app = serverRequire('server'); var security = require('narengi-utils').Security; var PromiseCallback = require('narengi-utils').Common.PromiseCallback; module.exports = function (Model, options) { var Role = app.models.Role; /** * Check if current user is admin or not */ Model.IsCurrentAdminSync = function () { var ctx = LoopBackContext.getCurrentContext(); var currentUser = ctx.get('currentUser'); if(!currentUser) return false; return Model.IsAdmin(currentUser.username || currentUser.email); }; /** * Check if current user is admin or not */ Model.IsCurrentAdmin = function (cb) { cb = cb || PromiseCallback(); Model.IsCurrentAdminSync().then((result) =&gt; {cb(null, result);}).catch((e) =&gt; {cb(e);}); return cb.promise; }; /** * Check if specified user is admin or not */ Model.IsAdminSync = function (userPrincipal) { return security.Common.isUserAdmin(userPrincipal); }; /** * Check if specified user is admin or not */ Model.IsAdmin = function (userPrincipal, cb) { cb = cb || PromiseCallback(); Model.IsAdminSync(userPrincipal).then((result) =&gt; {cb(null, result);}).catch(() =&gt; {cb(null, &quot;false&quot;);}); return cb.promise; }; }; × Search results Close "},"server_middleware_context.js.html":{"id":"server_middleware_context.js.html","title":"Source: server/middleware/context.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/middleware/context.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var Context = require('narengi-http-context').Context; var LoopBackContext = require('loopback-context'); /** * Create a context and assign to current http request * @param options * @property options.name Name of context which is be accessible through the http request * @returns {Function} Middleware */ module.exports = function (options) { options = options || {}; var name = options.name || &quot;narengi_context&quot;; return function (req, res, next) { var context = LoopBackContext.getCurrentContext(); if (!context) { return next(); } var ctx = context.get(name); if (ctx) { return next(); } ctx = Context.CreateContext(name); LoopBackContext.getCurrentContext().set(name, ctx); req[name] = ctx; req.getNarengiContext = function () { return req[name]; }; next(); } }; × Search results Close "},"server_boot_role-resolver.js.html":{"id":"server_boot_role-resolver.js.html","title":"Source: server/boot/role-resolver.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/boot/role-resolver.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // module.exports = function(app) { /** * Loads all boot scripts in `roles` folder. **/ var normalizedPath = require(&quot;path&quot;).join(__dirname, &quot;roles&quot;); require(&quot;fs&quot;).readdirSync(normalizedPath).forEach(function(file) { require(&quot;./roles/&quot; + file)(app); }); }; × Search results Close "},"server_boot_entitiy-loader.js.html":{"id":"server_boot_entitiy-loader.js.html","title":"Source: server/boot/entitiy-loader.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/boot/entitiy-loader.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // module.exports = function(app) { /** * Loads all boot scripts in `entities` folder. **/ var normalizedPath = require(&quot;path&quot;).join(__dirname, &quot;entities&quot;); require(&quot;fs&quot;).readdirSync(normalizedPath).forEach(function(file) { require(&quot;./entities/&quot; + file)(app); }); } × Search results Close "},"server_models_communication_notification-mq.js.html":{"id":"server_models_communication_notification-mq.js.html","title":"Source: server/models/communication/notification-mq.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/communication/notification-mq.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var app = serverRequire('server'); var Common = require('narengi-utils').Common; var EmailModule = require('narengi-messaging').Email; var SmsModule = require('narengi-messaging').SMS; var NotificationConstants = require('../../../common/constants/notification-constants'); var debugEmail = require('debug')('narengi:service:notification-mq:email'); var debugSms = require('debug')('narengi:service:notification-mq:sms'); var MQ = require('bull'); var path = require('path'); var fs = require('fs'); var smsCompiler = require('string-template/compile'); var emailServices = {}; var emailOptions = {}; var smsServices = {}; /** * This is responsible for job queueing and processing them * @namespace NotificationMQ */ module.exports = function (Notificationmq) { setupServices(Notificationmq); setupMQ(Notificationmq); addServices(Notificationmq); }; function getEmailService(lang){ if(!emailServices[lang]){ try { emailServices[lang] = EmailModule.GetService(emailOptions[lang]); } catch (e) { debugEmail(&quot;Creating mail service failed&quot;); } } return emailServices[lang]; } function getSMSService(lang){ if(!smsServices[lang]){ options = app.settings.notification.sms[app.settings.notification.sms.current]; try { smsService = SmsModule.CreateService(options); } catch (e) { debugSms(&quot;service does not created&quot;); return cb(e); } } return smsServices[lang]; } function setupServices(Model) { for (var lang in app.settings.locale.allowed) { var templatePath = path.join(__dirname, '..', '..', '..', 'common', 'templates', lang, 'email'); var options = {}; options.smtp = app.settings.notification.email.default.smtp; options.engine = { viewEngine: { extname: '.hbs', layoutsDir: templatePath, defaultLayout: 'base', partialsDir: path.join(templatePath, 'partials') }, viewPath: templatePath, extName: '.hbs' }; emailOptions[lang] = options; } //=========== SMS loadSmsTemplates(Model); } function loadSmsTemplates(Model) { Model.SmsTemplates = {}; for (var lang in app.settings.locale.allowed) { var templates = {}; var tmplPath = path.join(__dirname, '..', '..', '..', 'common', 'templates', lang, 'sms'); NotificationConstants.SmsType.enums.forEach(function (type) { try { var fileContent = fs.readFileSync(path.join(tmplPath, type.value + &quot;.txt&quot;), {encoding: &quot;utf8&quot;}); templates[type.value] = smsCompiler(fileContent, true); } catch (e) { } }); Model.SmsTemplates[lang] = templates; } } function defCallback(err, result) { } function setupMQ(Model) { Model.EmailQ = MQ('notification:email', app.settings.notification.redis.port, app.settings.notification.redis.host, app.settings.notification.redis); Model.EmailQ.process(function (job, done) { var data = job.data; sendEmail(data.from, data.to, data.type, data.locals, done); }); Model.EmailQ.on('completed', function (job, result) { app.models.NotificationMQPersister.PersistJobCompleted(job, result, 'notification:email', defCallback); }); Model.EmailQ.on('failed', function (job, error) { app.models.NotificationMQPersister.PersistJobFailure(job, error, 'notification:email', defCallback); }); Model.EmailQ.on('error', function (error) { app.models.NotificationMQPersister.PersistJobError(error, 'notification:email', defCallback); }); Model.SMSQ = MQ('notification:sms', app.settings.notification.redis.port, app.settings.notification.redis.host, app.settings.notification.redis); Model.SMSQ.process(function (job, done) { var data = job.data; sendSms(data.to, data.type, data.locals, Model.SmsTemplates[app.i18n.getLocale()][data.type], done); }); Model.SMSQ.on('completed', function (job, result) { app.models.NotificationMQPersister.PersistJobCompleted(job, result, 'notification:sms', defCallback); }); Model.SMSQ.on('failed', function (job, error) { app.models.NotificationMQPersister.PersistJobFailure(job, error, 'notification:sms', defCallback); }); Model.SMSQ.on('error', function (error) { app.models.NotificationMQPersister.PersistJobError(error, 'notification:sms', defCallback); }); } function sendEmail(from, to, type, locals, cb) { cb = cb || Common.PromiseCallback(); getEmailService(app.i18n.getLocale()).sendOne(from, to, app.i18n.__(`notification.email.${type}.subject`), type, locals).then((result) =&gt; { debugEmail(&quot;Notification sent to : %s&quot;, to); cb(null, result); }).catch((e) =&gt; { debugEmail(&quot;Notification sending failed : %j&quot;, e); cb(e) }); return cb.promise; } function sendSms(to, type, locals, template, cb) { cb = cb || Common.PromiseCallback(); if (!template) return cb(Notification.SmsErrorNoTemplate); var message = template(locals); getSMSService(app.i18n.getLocale()).sendOne(null, to, message).then((result) =&gt; { debugSms(&quot;Notification sent to : %s&quot;, to); cb(null, result); }).catch((e) =&gt; { cb(e) }); return cb.promise; } function addServices(Model) { /** * Add sending email job to queue * @param {Object} options * @param {String} options.notificationType * @param {String} options.from Email from * @param {String} options.to Email to * @param {String} options.type Email type like &quot;account_registration&quot; * @param {Object} options.locals Values to be injected to email template * @param {String} options.accountId * @param {Callback} cb * @memberOf NotificationMQ */ Model.AddEmailJob = function (options, cb) { Model.EmailQ.add(options, {attempts: 10, backoff: {type: 'fixed', delay: 30000}}).then((job) =&gt; { app.models.NotificationMQPersister.PersistNewJob(job, NotificationConstants.NoteType.Email.value, options.type, 'notification:email', cb); }).catch((e) =&gt; { cb(e); }); }; /** * Add sending sms job to queue * @param {Object} options * @param {String} options.notificationType * @param {String} options.to Phone number to * @param {String} options.type SMS type like &quot;account_registration&quot; * @param {Object} options.locals Values to be injected to sms template * @param {String} options.accountId * @param {Callback} cb * @memberOf NotificationMQ */ Model.AddSMSJob = function (options, cb) { Model.SMSQ.add(options, {attempts: 10, backoff: {type: 'fixed', delay: 30000}}).then((job) =&gt; { app.models.NotificationMQPersister.PersistNewJob(job, NotificationConstants.NoteType.SMS.value, options.type, 'notification:sms', cb); cb(null, job); }).catch((e) =&gt; { cb(e); }); }; } × Search results Close "},"server_models_communication_notification-mq-persister.js.html":{"id":"server_models_communication_notification-mq-persister.js.html","title":"Source: server/models/communication/notification-mq-persister.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/models/communication/notification-mq-persister.js 'use strict'; // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var app = serverRequire('server'); var Common = require('narengi-utils').Common; var Persistency = require('narengi-utils').Persistency; var moment = require('moment'); var async = require('async'); var MQ = require('bull'); var Notification = app.models.Notification; /** * This module is responsible for persisting notification jobs. * Actually logs job lifecycle of sending a notification * @namespace NotificationMQPersister */ module.exports = function (Notificationmqpersister) { setupMQ(Notificationmqpersister); addServices(Notificationmqpersister); }; function setupMQ(Model) { Model.NewJobQ = MQ('notification:persister:new', app.settings.notification.redis.port, app.settings.notification.redis.host, app.settings.notification.redis); Model.NewJobQ.process(function (job, done) { var data = job.data; Model.create({ id: data.job.jobId, queue: data.queueName, jobs: [data.job] }, done); }); Model.NewJobQ.on('failed', function (error) { //TODO log }); Model.NewJobQ.on('error', function (error) { //TODO log }); //========================================================================= Model.CompletedJobQ = MQ('notification:persister:completed', app.settings.notification.redis.port, app.settings.notification.redis.host, app.settings.notification.redis); Model.CompletedJobQ.process(function (job, done) { var data = job.data; async.parallel({ notification: function (callback) { Notification.Create({ date: moment.utc().toDate(), accountId: data.job.data.accountId, type: data.job.data.notificationType, info: { type: data.job.data.type }, payload: data.job.data, result: data.result }, callback); }, mq: function (callback) { async.waterfall([ function (wCallback) { Model.findById(data.job.jobId, wCallback); }, function (entity, wCallback) { if (!entity) return wCallback(Persistency.Errors.NotFound({message: 'error.persistency.notification_mq.not_found'})); entity.jobs.push(data.job); entity.save(wCallback); } ], callback); } }, function (error, output) { if (error) return done(error); done(null, output.mq); }); }); Model.CompletedJobQ.on('failed', function (error) { //TODO log }); Model.CompletedJobQ.on('error', function (error) { //TODO log }); //========================================================================= Model.FailureJobQ = MQ('notification:persister:failure', app.settings.notification.redis.port, app.settings.notification.redis.host, app.settings.notification.redis); Model.FailureJobQ.process(function (job, done) { var data = job.data; async.waterfall([ function (callback) { Model.findById(data.job.jobId, callback); }, function (entity, callback) { if (!entity) return callback(Persistency.Errors.NotFound({message: 'error.persistency.notification_mq.not_found'})); entity.jobs.push({job: data.job, error: data.error}); entity.save(callback); } ], function (err, result) { if (err) return done(err); done(null, result); }); }); Model.FailureJobQ.on('failed', function (error) { //TODO log }); Model.FailureJobQ.on('error', function (error) { //TODO log }); //========================================================================= Model.ErrorJobQ = MQ('notification:persister:error', app.settings.notification.redis.port, app.settings.notification.redis.host, app.settings.notification.redis); Model.ErrorJobQ.process(function (job, done) { var data = job.data; //TODO just log not persisting in db }); Model.ErrorJobQ.on('failed', function (error) { //TODO log }); Model.ErrorJobQ.on('error', function (error) { //TODO log }); } function addServices(Model) { /** * Queues a job to persist a new notification job * @param {Object} job * @param {String} type Type of notification eg EMAIL * @param {String} subType Sub type of notification eg Account_Registration * @param {String} queueName Queue name * @param {Callback} cb * @memberOf NotificationMQPersister */ Model.PersistNewJob = function (job, type, subType, queueName, cb) { cb = cb || Common.PromiseCallback(); Model.NewJobQ.add({job: job, type: type, subType: subType, queueName: queueName}, {attempts: 10, backoff: {type: 'fixed', delay: 30000}}).then((/*res*/) =&gt; {cb(null, job);}).catch((e) =&gt; {cb(e);}); return cb.promise; }; /** * Queues a job to persist a completed notification job * @param {Object} job * @param {Object} result Result of sending notification from underlying service. For example email service sends an email and send back the result * @param {String} queueName * @param {Callback} cb * @memberOf NotificationMQPersister */ Model.PersistJobCompleted = function (job, result, queueName, cb) { cb = cb || Common.PromiseCallback(); Model.CompletedJobQ.add({job: job, result: result, queueName: queueName}, {attempts: 10, backoff: {type: 'fixed', delay: 30000}}).then((/*res*/) =&gt; {cb(null, job);}).catch((e) =&gt; {cb(e);}); return cb.promise; }; /** * Queues a job to persist a failure encountering processing a notification job. Note that this is after multiple attempting notification job * @param {Object} job * @param {Object} error * @param {String} queueName * @param {Callback} cb * @memberOf NotificationMQPersister */ Model.PersistJobFailure = function (job, error, queueName, cb) { cb = cb || Common.PromiseCallback(); Model.FailureJobQ.add({job: job, error: error, queueName: queueName}, {attempts: 10, backoff: {type: 'fixed', delay: 30000}}).then((/*res*/) =&gt; {cb(null, job);}).catch((e) =&gt; {cb(e);}); return cb.promise; }; /** * Queues a job to persist an error while processing notification processing. This is different to failure * @param {Object} error * @param {String} queueName * @param {Callback} cb * @memberOf NotificationMQPersister */ Model.PersistJobError = function (error, queueName, cb) { cb = cb || Common.PromiseCallback(); Model.ErrorJobQ.add({error: error, queueName: queueName}, {attempts: 10, backoff: {type: 'fixed', delay: 30000}}).then((/*res*/) =&gt; {cb(null, job);}).catch((e) =&gt; {cb(e);}); return cb.promise; }; } × Search results Close "},"common_models_price.js.html":{"id":"common_models_price.js.html","title":"Source: common/models/price.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: common/models/price.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var money = require('money'); var app = serverRequire('server'); module.exports = function (Price) { /** * Converts from current currency to new currency * @param {string} currency new Currency */ Price.prototype.convertTo = function (currency) { var Currency = app.models.Currency; var newCurr = Currency.Get(currency); if (!newCurr) { newCurr = Currency.Default; } return money.convert(this.amount, {from: this.currency, to: newCurr.toString()}); }; Price.ZeroValue = function () { var Currency = app.models.Currency; return {amount: 0, currency: Currency.Default.toString()}; }; }; × Search results Close "},"server_middleware_authentication.js.html":{"id":"server_middleware_authentication.js.html","title":"Source: server/middleware/authentication.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/middleware/authentication.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var loopback = require('loopback'); var LoopBackContext = require('loopback-context'); var app = serverRequire('server'); function authWithJWT(loopbackCtx, token, username, next) { var context = loopbackCtx.get('narengi_context'); if (token &amp;&amp; username) { app.models.Account.find({ include: &quot;authToken&quot;, where: { &quot;and&quot;: [ { &quot;account_authToken.token&quot;: token }, { &quot;or&quot;: [ { &quot;username&quot;: username }, { &quot;email&quot;: username } ] } ] } }, function (err, accs) { if (err || !accs || accs.length &lt; 1) { context.setUser(null); context.setToken(null); return next(); } if (accs[0].authToken &amp;&amp; app.models.AuthToken.isExpired(accs[0].authToken.value())) { accs[0].authToken.destroy(); context.setUser(null); context.setToken(null); return next(); } context.setUser(accs[0]); context.setToken(accs[0].authToken.value()); try { /** This is needed for ACL and just used there **/ req.loopbackContext.active.http.req.accessToken = { id: accs[0].authToken.value().token, userId: String(accs[0].id) }; } catch (e) { } next(); }); } else { context.setUser(null); context.setToken(null); next(); } } module.exports = function (options) { /** * Authorizes current `request` and set current user to `context` **/ return function handler(req, res, next) { try { //TODO: should add OAuth authorization var authHeader = (req.headers.authorization &amp;&amp; JSON.parse(&quot;{&quot; + req.headers.authorization + &quot;}&quot;)) || {}; //This is `plain` login mechanism // `username` could be an email LoopBackContext.runInContext(function (ns, domain) { authWithJWT(ns, authHeader.token, authHeader.username, next); }); } catch (e) { next(); } finally { } } } × Search results Close "},"server_lib_messaging_lib_sms_service.js.html":{"id":"server_lib_messaging_lib_sms_service.js.html","title":"Source: server/lib/messaging/lib/sms/service.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/messaging/lib/sms/service.js &quot;use strict&quot;; // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // module.exports = exports; var NotImplemented = require('./errors').NotImplemented; var underscore = require('underscore'); /** * It's a proxy * @class */ class Service { /** * @param {Object} service * @param {String} type Vendor type */ constructor(service, type) { this.service = service; this.type = type; } /** * Send sms to one receiver * @param {String} sender * @param {String} receiver * @param {String} message * @param {Object} options vendor specific options * @param {Function} cb * @method * @public * @abstract */ sendOne(sender, receiver, message, options, cb) { if (underscore.isFunction(options)) { cb = options; options = {}; } options = options || {}; try { this._isReady(); } catch (e) { if (underscore.isFunction(cb)) return cb(e); return; } return this.service.sendOne(sender, receiver, message, options, cb); } /** * Check if this is able to serve services * @private */ _isReady() { if (!this.service) throw new NotImplemented({ extra: { type: this.type } }); } } exports.Service = Service; × Search results Close "},"server_lib_messaging_lib_push_apn_index.js.html":{"id":"server_lib_messaging_lib_push_apn_index.js.html","title":"Source: server/lib/messaging/lib/push/apn/index.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/messaging/lib/push/apn/index.js &quot;use strict&quot;; // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var Sender = require('node-sender')(); var underscore = require('underscore'); var debug = require('debug')('narengi-messaging:push:apn'); var Errors = require('narengi-messaging').Push.Errors; module.exports = exports; class Service { /** * @constructor * @param {Object} options * @options [options] * @property {String} Required cert Absolute path to cert file * @property {String} Required key Absolute path to key file * @property: {Boolean} Optional production */ constructor(options) { let config = { cert: options.certFile, key: options.keyFile }; config.production = options.production === true; this.config = config; } /** * Send push notification to destination devices * @param {Array|String} destTokens Destination device token(s) * @param {string} message * @param {Object} options Specific destination system settings * @options [options] * @property {String} title * @property {Integer} ttl In seconds. Default : `3600` * @property {Integer} badge Badge number * @property {String} sound * * @param {Function} cb Containing promise * @method * @public */ push(destTokens, message, options, cb) { let tokens = []; tokens.push(destTokens); tokens = underscore.flatten(tokens); let config = this.config; if (options.ttl) config.ttl = options.ttl; let packet = { alert: message }; if (options.badge) packet.badge = options.badge; if (options.sound) packet.sound = options.sound; debug('Sending push : %j', packet); Sender.send({ type: Sender.constants.TYPE_IOS, message: packet, tokens: tokens, config: config }, function (error, result) { if (error) return cb(error); if (result.successful) return cb(null, result); if (result.unregistered) { return cb(new Errors.UnregisteredTokenError({ extra: result })); } return cb(new Errors.General({ extra: result })); }); return cb.promise; } } exports.Service = Service; × Search results Close "},"server_lib_messaging_lib_push_gcm_index.js.html":{"id":"server_lib_messaging_lib_push_gcm_index.js.html","title":"Source: server/lib/messaging/lib/push/gcm/index.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/messaging/lib/push/gcm/index.js &quot;use strict&quot;; // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var Sender = require('node-sender')(); var underscore = require('underscore'); var debug = require('debug')('narengi-messaging:push:gcm'); var Errors = require('narengi-messaging').Push.Errors; module.exports = exports; class Service { /** * @constructor * @param {Object} options * @options [options] * @property {String} Required apiKey Google GCM API key */ constructor(options) { let config = { apiKey: options.apiKey }; this.config = config; } /** * Send push notification to destination devices * @param {Array|String} destTokens Destination device token(s) * @param {string} message * @param {Object} options Specific destination system settings * @options [options] * @property {String} title * @property {Integer} ttl In seconds. Default : `3600` * @property {Object} extra Extra key value * * @param {Function} cb Containing promise * @method * @public */ push(destTokens, message, options, cb) { let tokens = []; tokens.push(destTokens); tokens = underscore.flatten(tokens); let config = this.config; if (options.ttl) config.ttl = options.ttl; let packet = { body: message }; if (options.title) packet.title = options.title; if (options.extra) { packet = underscore.extend(packet, options.extra); } packet.title = packet.title || &quot;&quot;; debug('Sending push : %j', packet); Sender.send({ type: Sender.constants.TYPE_ANDROID, message: packet, tokens: tokens, config: config }, function (error, result) { if (error) return cb(error); if (result.successful) return cb(null, result); if (result.unregistered) { return cb(new Errors.UnregisteredTokenError({ extra: result })); } return cb(new Errors.General({ extra: result })); }); return cb.promise; } } exports.Service = Service; × Search results Close "},"server_lib_messaging_lib_push_service.js.html":{"id":"server_lib_messaging_lib_push_service.js.html","title":"Source: server/lib/messaging/lib/push/service.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/messaging/lib/push/service.js &quot;use strict&quot;; // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var underscore = require('underscore'); var PromiseCallback = require('narengi-messaging').PromiseCallback; module.exports = exports; class Service { /** * * @param {Object} service * @param {String} type Push notification system type gsm|apn */ constructor(service, type) { this.service = service; this.type = type; } /** * Send push notification to destination devices * @param {Array|String} destTokens Destination device token(s) * @param {string} message * @param {Object} options Specific destination system settings * @param {Function} cb * @method * @public */ push(destTokens, message, options, cb) { if (underscore.isFunction(options)) { cb = options; options = {}; } options = options || {}; cb = cb || PromiseCallback(); this.service.push(destTokens, message, options, cb); } } exports.Service = Service; × Search results Close "},"server_lib_messaging_lib_email_transporter.js.html":{"id":"server_lib_messaging_lib_email_transporter.js.html","title":"Source: server/lib/messaging/lib/email/transporter.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/messaging/lib/email/transporter.js &quot;use strict&quot;; // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // module.exports = exports; var nodemailer = require('nodemailer'); var nodemailerHandlebar = require('nodemailer-express-handlebars'); var debug = require('debug')('narengi-messaging:email'); var underscore = require('underscore'); var PromiseCallback = require('narengi-messaging').PromiseCallback; class Transporter { /** * * @options {Object} [options] Required * * @options {Object} [smtp] Required * @property {String} host Host name * @property {Integer} port * @property {Boolean} secure * @property {Boolean} pool * * @options {Object} [auth] * @property {String} user Username/Account * @property {String} pass Password * * @options {Object} engine * @options {Object} viewEngine Settings for handlebars view engine * &lt;br/&gt;See [Configuration](https://github.com/ericf/express-handlebars#configuration-and-defaults) * @property {String} extName Extension name of layout files * @property {String} layoutsDir * @property {String} defaultLayout * @property {String} partialsDir * * @property {String} viewPath * @property {String} extName * * @constructor * @public */ constructor(options) { this.service = nodemailer.createTransport(options.smtp); this.service.use('compile', nodemailerHandlebar(options.engine)); this.service.use('compile', function (mail, callback) { if (!mail.text &amp;&amp; mail.html) { mail.text = mail.html.replace(/&lt;[^&gt;]*&gt;/g, ' '); } callback(); }); } /** * Send email to one receiver * @param {String} from * @param {String} to * @param {String} subject * @param {String} template * @param {Object} context Used to compile template in handlebars * @param {Object} options Extra options for sending email * @param {Function} cb * @method * @public */ sendOne(from, to, subject, template, context, options, cb) { if (underscore.isFunction(options)) { cb = options; options = {}; } options = options || {}; cb = cb || PromiseCallback(); let packet = options; if (from) { packet.from = from; } if (to) { packet.to = to; } if (subject) { packet.subject = subject; } if (template) { packet.template = template; } if (context) { packet.context = context; } debug(&quot;Sending email : %j&quot;, packet); this.service.sendMail(packet, cb); return cb.promise; } } exports.Transporter = Transporter; × Search results Close "},"server_lib_utils_lib_http_uploader.js.html":{"id":"server_lib_utils_lib_http_uploader.js.html","title":"Source: server/lib/utils/lib/http/uploader.js","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Source: server/lib/utils/lib/http/uploader.js // // Author : Ali Abbasinasab (a.abbasinasab@gmail.com) // var bluebird = require('bluebird'); var formidable = require('formidable'); var nodePath = require('path'); var nodeFs = require('fs'); var mime = require('mime'); var fsExtra = require('fs-extra'); var HttpErrors = require('./errors'); var async = require('async'); var lwip = require('lwip'); var underscore = require('underscore'); var Common = require('narengi-utils').Common; var fs = require('narengi-utils').FileSystem; var debug = require('debug')('narengi-utils:http:uploader'); module.exports = exports; /** * Uploads file with remote `fieldname` to `destPath` * Resolving returned promise contains an object with below scheme : * ``` JSON * { * name: {file name}, * path: {absolute path to the file}, * size: {in bytes}, * type: {mime type}, * mtime: {creation time in UTC} * } * ``` * @param {object} req HttpRequest * @param {object} options * ``` JSON * { * destDir: &quot;&quot; directory to save file * filedname: &quot;&quot;, * destFileName: &quot;&quot; filename, * hash: true|false if hashing is true, then filename is unique and no file replace performed * } * ``` * @return {Promise} */ exports.upload = function (req, options) { options.hash = true; //force hashing return new Promise(function (resolve, reject) { fs.Core.ensurePathExists(options.destDir).then(pathExisted).catch(pathNotExisted); function formParsedHandler(err, fields, files) { if (err) { return reject(err); } } function fileUploadedHandler(fields, files) { if (this.openedFiles) { var uploadedFile = this.openedFiles[0]; handleImageStyles(uploadedFile, options).then((result) =&gt; { resolve(result); }).catch((err) =&gt; { reject(err); }); } else { reject(HttpErrors.FileUploadFailure()); } } function fileDetectedHandler(name, file) { try { if (!options.fieldName) return; //prevent forcing upload field names if (name.toLowerCase() !== options.fieldName.toLowerCase()) { return reject(HttpErrors.FileNotCorrectError()); } } catch (ex) { return reject(HttpErrors.FileNotCorrectError()); } } function pathExisted(path) { var form = new formidable.IncomingForm(); form.keepExtensions = true; if (!!options.hash) form.hash = &quot;md5&quot;; form.parse(req); form.on(&quot;end&quot;, fileUploadedHandler); form.on('file', fileDetectedHandler); } function pathNotExisted(path) { reject(fs.Errors.NoAccess()); } }); }; /** * Uploads files with remote `fieldname` to `destPath` * Resolving returned promise contains an object with below scheme : * ``` JSON * [{ * name: {file name}, * path: {absolute path to the file}, * size: {in bytes}, * type: {mime type}, * mtime: {creation time in UTC} * }] * ``` * @param {object} req HttpRequest * @param {object} options * ``` JSON * { * destDir: &quot;&quot; directory to save file * filedname: &quot;&quot;, * destFileName: &quot;&quot; filename * } * ``` * @return {Promise} */ exports.uploadAll = function (req, options) { options.hash = true; //force hashing return new Promise(function (resolve, reject) { fs.Core.ensurePathExists(options.destDir).then(pathExisted).catch(pathNotExisted); function formParsedHandler(err, fields, files) { if (err) { return reject(err); } } function fileUploadedHandler(fields, files) { var retArr = []; if (this.openedFiles) { async.each(this.openedFiles, function (file, callback) { handleImageStyles(file, options).then((result) =&gt; { if (underscore.isArray(result) &amp;&amp; result.length &gt; 0) { var ret = {}; ret[result[0].hash] = result; retArr.push(ret); } callback(null); }).catch((err) =&gt; { callback(err); }); }, function (err) { if (err) return reject(err); resolve(retArr); }); } else { reject(HttpErrors.FileUploadFailure()); } } function fileDetectedHandler(name, file) { try { if (!options.fieldName) return; //prevent forcing upload field names if (name.toLowerCase() !== options.fieldName.toLowerCase()) { return reject(HttpErrors.FileNotCorrectError()); } } catch (ex) { return reject(HttpErrors.FileNotCorrectError()); } } function pathExisted(path) { var form = new formidable.IncomingForm(); form.keepExtensions = true; form.hash = &quot;md5&quot;; form.multiples = true; form.parse(req); form.on(&quot;end&quot;, fileUploadedHandler); form.on('file', fileDetectedHandler); } function pathNotExisted(path) { reject(fs.Errors.NoAccess()); } }); }; function handleImageStyles(uploadedFile, options, cb) { cb = cb || Common.PromiseCallback(); styles = options.styles || {}; styles = underscore.extend({original: &quot;original&quot;}, styles); var emptyDir = bluebird.promisify(fsExtra.emptyDir); var openImage = bluebird.promisify(lwip.open); var readFile = bluebird.promisify(nodeFs.readFile); readFile(uploadedFile.path).then(fileDidRead).catch((e) =&gt; { cb(fs.Errors.NoAccess()); }); return cb.promise; function doEachFileForStyle(uploadedFile, styleName, styleValue, buffer) { debug(&quot;Image manipulation - style : %s =&gt; %s&quot;, styleName, styleValue); return function (callback) { var destDirPath = nodePath.join(options.destDir, uploadedFile.hash); emptyDir(destDirPath).then(doOperation).catch((err) =&gt; { callback(err); }); function doOperation() { var extension = nodePath.extname(uploadedFile.name).slice(1).toLowerCase(); if(!extension){ extension = mime.extension(uploadedFile.type); } var destPath = nodePath.join(destDirPath, styleName) + &quot;.&quot; + extension; debug(&quot;destination : %s&quot;, destPath); if (styleName !== 'original') { openImage(buffer, extension).then((image) =&gt; { var batch = image.batch(); //if (image.width() &gt; styleValue) //TODO: this is a policy consideration batch.scale(styleValue / image.width()); batch.writeFile(destPath, function (err) { if (err) return callback(err); prepareForReturn(destPath); }); }).catch((err) =&gt; { callback(null, null); }); } else { fs.Core.copy(uploadedFile.path, destPath, {}).then(() =&gt; { prepareForReturn(destPath); }).catch((err) =&gt; { callback(err); }); } } function prepareForReturn(destPath) { var ret = { destDirPath: destDirPath, destPath: destPath, hash: uploadedFile.hash, type: uploadedFile.type, style: {} }; ret.style[styleName] = styleValue; callback(null, ret); } } } function fileDidRead(buffer) { var cbArr = underscore.map(styles, function (value, key) { return new doEachFileForStyle(uploadedFile, key.toString(), value, buffer); }); async.parallel(cbArr, function (err, result) { if (err) return cb(err); result = underscore.filter(result, function (item) { return item !== null; }); cb(null, result); }); } } × Search results Close "},"global.html":{"id":"global.html","title":"Global","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Global Members app Get current application Source: server/lib/utils/lib/common/index.js, line 19 jsoner monkey patch JSON.stringify because Error class does not include message field Source: server/server.js, line 16 Methods accountCreateHandler() Handles create or update of Account Source: server/models/account.js, line 507 addHooks() Add remote and operation hooks to the model Source: server/models/user-profile.js, line 126 addMethods(HouseImageContainer) Add static methods for HouseImageContainer Parameters: Name Type Description HouseImageContainer Model Source: server/models/geo/house-image-container.js, line 35 addMethods(UserProfileImageContainer) Add static methods for UserProfileImageContainer Parameters: Name Type Description UserProfileImageContainer object Source: server/models/user-profile-image-container.js, line 36 addMethods(AttractionImageContainer) Add static methods for AttractionImageContainer Parameters: Name Type Description AttractionImageContainer AttractionImageContainer Source: server/models/geo/attraction-image-container.js, line 37 addMethods(CityImageContainer) Add static methods for CityImageContainer Parameters: Name Type Description CityImageContainer CityImageContainer Source: server/models/geo/city-image-container.js, line 36 addMethods(ImageContainerBase) Add static methods for ImageContainerBase Parameters: Name Type Description ImageContainerBase Model Source: server/models/image-container-base.js, line 34 addServices(UserProfileImageContainer) Add services to be used in UserProfile model Parameters: Name Type Description UserProfileImageContainer object Source: server/models/user-profile-image-container.js, line 52 addServices(HouseImageContainer) Add services to be used in House model Parameters: Name Type Description HouseImageContainer Model Source: server/models/geo/house-image-container.js, line 51 addServices(CityImageContainer) Add services to be used in City model Parameters: Name Type Description CityImageContainer object Source: server/models/geo/city-image-container.js, line 52 addServices(ImageContainerBase) Add services to be used in model Parameters: Name Type Description ImageContainerBase Model Source: server/models/image-container-base.js, line 55 addServices(AttractionImageContainer) Add services to be used in Attraction model Parameters: Name Type Description AttractionImageContainer object Source: server/models/geo/attraction-image-container.js, line 53 afterPaginatedService(ctx, instance, next) Enriches http response with necessary headers Parameters: Name Type Description ctx AccesContext instance Model Not used next Callback Source: server/lib/utils/lib/pagination/remote-hooks.js, line 59 argShouldNotEmpty(argName) Factory for remote hook to validate the argument Parameters: Name Type Description argName string Source: server/lib/utils/lib/common/remote-hooks.js, line 235 Returns: Type function argumentWrapper(neededQuery) Wraps needed arguments in before remote hook to use in corresponding after remote Parameters: Name Type Description neededQuery array Source: server/lib/utils/lib/pagination/remote-hooks.js, line 17 Returns: Type function arraySuccessHandler(cb) Wraps a callback for handling successful situations Use this for array Parameters: Name Type Description cb function loopback callback Source: server/lib/utils/lib/persistency/crud-handlers.js, line 26 checkCurrentUserAuthorized(ctx, instance, next) Check if current user authenticated or not Parameters: Name Type Description ctx HttpContext instance Model next Callback Source: server/lib/utils/lib/security/remote-hooks.js, line 33 convert2Dto(Entity, options) Wrapper for after remote hook to convert entity to DTO Parameters: Name Type Description Entity Model | string options object Source: server/lib/utils/lib/common/remote-hooks.js, line 135 Returns: Returns remote hook Type function correctCaseOfKeys(cb) Make request.body comply model definitionWraps a callback for handling successful situations Parameters: Name Type Description cb function loopback callback Deprecated: Yes Source: server/lib/utils/lib/common/remote-hooks.js, line 40 correctRequestData(ctx, instance, next) We should inject request body to args again. Because injection body to arguments is done at first calling of before remotes. Parameters: Name Type Description ctx Context instance Model next Callback Source: server/lib/utils/lib/common/remote-hooks.js, line 112 createOrUpdate(HouseCancellationPolicy, id, data, cb) Create or update HouseCancellationPolicy Parameters: Name Type Description HouseCancellationPolicy Model id string data object cb Callback Source: server/models/house/house-cancellation-policy.js, line 22 createOrUpdateAttraction(attractionId, data, cb) Main function for creating or updating Attraction model Parameters: Name Type Description attractionId string | null data object cb Callback Source: server/models/geo/attraction.js, line 51 Returns: Type Promise createOrUpdateCity(cityId, data, cb) Main function for creating or updating City model Parameters: Name Type Description cityId string | null data object cb Callback Source: server/models/geo/city.js, line 51 Returns: Type Promise createOrUpdateHouseFeature(houseFeatureId, data, cb) Main function for creating or updating HouseFeature model Parameters: Name Type Description houseFeatureId string | null data object cb Callback Source: server/models/house/house-feature.js, line 46 Returns: Type Promise createOrUpdateHouseType(typeId, data, cb) Create or update HouseType based on inputs.I houseId is null so it creates a new or, otherwise updates existing one. Parameters: Name Type Description typeId string data object cb Callback Source: server/models/house/house-type.js, line 23 createProfile() Method for creating or updating current user profile; Source: server/models/user-profile.js, line 36 createProfile() Method for creating current user profile; Source: server/models/financial-profile.js, line 26 createProfileHandler() Creates or updates an USerProfile after finding AccountThis function is for handling callbacks from calling CRUD methods of `loopback' Source: server/models/user-profile.js, line 52 createProfileHandler() Creates an FinancialProfile after finding PersonThis function is for handling callbacks from calling CRUD methods of `loopback' Source: server/models/financial-profile.js, line 38 CreateService(options) Creates a service proxying destination PN system Parameters: Name Type Description options Object Source: server/lib/messaging/lib/push/index.js, line 15 dataCorrector(ctx, instance, next) Before remote function to correct data sent from client Parameters: Name Type Description ctx HttpContext instance City If update method called then this parameter is valid next Callback Source: server/models/geo/city.js, line 28 dataCorrector(ctx, instance, next) Before remote function to correct data sent from client Parameters: Name Type Description ctx HttpContext instance House If update method called then this parameter is valid next Callback Source: server/models/house/house-feature.js, line 22 dataCorrector(ctx, instance, next) Before remote function to correct data sent from client Parameters: Name Type Description ctx HttpContext instance Attraction If update method called then this parameter is valid next Callback Source: server/models/geo/attraction.js, line 28 dataOwnerCorrector() A beforeRemote hook validating input data for persisting in storage This method correct and sanitizes input data. Source: server/models/user-profile.js, line 143 dataOwnerCorrector() A beforeRemote hook validating input data for persisting in storage This method correct and sanitizes input data. Deprecated: Yes Source: server/lib/utils/lib/common/remote-hooks.js, line 183 dataOwnerCorrectorInArg(argName, modelName) Picks just fields defined in model definition Parameters: Name Type Description argName string Argument name modelName string Model name Source: server/lib/utils/lib/common/remote-hooks.js, line 202 Returns: Type function dataShouldNotEmpty(ctx, instance, next) Validates the http request body should not be empty Parameters: Name Type Description ctx Context instance Model next Callback Deprecated: Yes Source: server/lib/utils/lib/common/remote-hooks.js, line 224 DateRange(startDate, endDate, options) Creates an array consisting of dates from startDate to endDate. Parameters: Name Type Description startDate string | Date endDate string | Date options object { stringDate: {boolean} If true, each date representing date format string, else JS Date object } Source: server/lib/utils/lib/common/dates.js, line 22 Returns: Type Array defineAdminServices(FinancialProfile) Adds create-update user profile by admin capability Parameters: Name Type Description FinancialProfile Source: server/models/financial-profile.js, line 185 defineAdminStuff(UserProfile) Adds create-update user profile by admin capability Parameters: Name Type Description UserProfile Source: server/models/user-profile.js, line 441 defineGeneralServices(GlobalSearch) Add general services Parameters: Name Type Description GlobalSearch Source: server/models/search/global-search.js, line 66 defineHooks(GlobalSearch) Defines after/before remotes for global searching Parameters: Name Type Description GlobalSearch Model Source: server/models/search/global-search.js, line 135 defineMethods(GlobalSearch) Defines static methods Parameters: Name Type Description GlobalSearch Source: server/models/search/global-search.js, line 27 defineRemoteMethods(GlobalSearch) Define API endpoints Parameters: Name Type Description GlobalSearch Source: server/models/search/global-search.js, line 165 defineServices(HouseFeature) Add services to HouseFeature Parameters: Name Type Description HouseFeature Model Source: server/models/house/house-feature.js, line 65 doStructureResultForMultiple(files, cb) Refine structure of uploaded files for db and api Parameters: Name Type Description files Array [ { file-hash : [array of diverse saved file based on each style] } ] cb Callback Source: server/models/image-container-base.js, line 290 Returns: Type Promise download(res, filename, filepath) Sends file in http response. Parameters: Name Type Description res HttpResponse filename string filename to be sent to client filepath string Absolute file path Source: server/lib/utils/lib/http/downloader.js, line 17 extractFileSizes(files, filePathArr, cb) Enriches file info packages by file sizes. Parameters: Name Type Description files Array Array of file info package returned by Http.Uploader utility. filePathArr Array Array of string denoting file path's cb Callback Source: server/models/image-container-base.js, line 368 Returns: Type Promise failureHandler(cb) Wraps a callback for handling failure situations Parameters: Name Type Description cb function loopback callback Source: server/lib/utils/lib/persistency/crud-handlers.js, line 37 getModelKeyMap() Returns a map containg each property key in lowerCase as key and original as value Source: server/lib/utils/lib/common/remote-hooks.js, line 19 injectLangToRequestData(ctx, instance, next) Inject current language to data sent from client Parameters: Name Type Description ctx Context instance Model next Callback Source: server/lib/utils/lib/common/remote-hooks.js, line 123 isUserAdmin(app, usernameOrEmail) Check is input user is in ADMIN role or not Parameters: Name Type Description app Application usernameOrEmail string Source: server/lib/utils/lib/security/security.js, line 17 Returns: Type Promise Normalize(dates, options) Normalize dates in array. Parameters: Name Type Description dates array Containing strings representing dates. options object { stringDate: true|false, //If true, each date representing date format string, else JS Date object format: {string}, //date format sort: true|false } Source: server/lib/utils/lib/common/dates.js, line 56 Returns: Normalized dates Type array refinePaginationParams(ctx, instance, next) Before remote to refine pagination params Parameters: Name Type Description ctx AccessContext instance Model Not used next Callback Source: server/lib/utils/lib/pagination/remote-hooks.js, line 41 successHandler(cb) Wraps a callback for handling successful situations Parameters: Name Type Description cb function loopback callback Source: server/lib/utils/lib/persistency/crud-handlers.js, line 13 updateProfile() Method for creating or updating current user profile; Source: server/models/user-profile.js, line 76 updateProfile() Method for updating current user profile; Source: server/models/financial-profile.js, line 62 updateProfileHandler() Creates or updates an FinancialProfile after finding PersonThis function is for handling callbacks from calling CRUD methods of `loopback' Source: server/models/financial-profile.js, line 74 updateProfileHandler() Creates or updates an USerProfile after finding AccountThis function is for handling callbacks from calling CRUD methods of `loopback' Source: server/models/user-profile.js, line 92 upload(req, options) Uploads file with remote fieldname to destPathResolving returned promise contains an object with below scheme : { name: {file name}, path: {absolute path to the file}, size: {in bytes}, type: {mime type}, mtime: {creation time in UTC} } Parameters: Name Type Description req object HttpRequest options object { destDir: &quot;&quot; directory to save file filedname: &quot;&quot;, destFileName: &quot;&quot; filename, hash: true|false if hashing is true, then filename is unique and no file replace performed } Source: server/lib/utils/lib/http/uploader.js, line 45 Returns: Type Promise uploadAll(req, options) Uploads files with remote fieldname to destPathResolving returned promise contains an object with below scheme : [{ name: {file name}, path: {absolute path to the file}, size: {in bytes}, type: {mime type}, mtime: {creation time in UTC} }] Parameters: Name Type Description req object HttpRequest options object { destDir: &quot;&quot; directory to save file filedname: &quot;&quot;, destFileName: &quot;&quot; filename } Source: server/lib/utils/lib/http/uploader.js, line 123 Returns: Type Promise Type Definitions cb() Source: server/models/account.js, line 309 cb(packet, err, result) Parameters: Name Type Description packet Object { receiver: 'string. receiver number', message: 'string. Encoded', sender: 'string (optional). sender number', date: 'string (optional). unix date', type: 'integer (optional). ' }See @{link http://kavenegar.com/rest.html#result-msgmode|Send message types} err SMS.Errors.General result SMS.Kavenegar.Result.SendOne function(err, result){ } Source: server/lib/messaging/lib/sms/kavenegar/service.js, line 44 Returns: Type Promise × Search results Close "},"modules.list.html":{"id":"modules.list.html","title":"Modules","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Modules Classes CheckUniqueness Explanation GetService HouseAvailableDate RequestState Context MakeFromDbArray UploadPicture exports exports exports exports exports exports Service Service Service Service Service Transporter UploadPicture Namespaces Core Core Core Core HouseBookingRequest HouseBookingRequestMQPersister http-context NotificationMQ NotificationMQPersister × Search results Close "},"classes.list.html":{"id":"classes.list.html","title":"Classes","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Classes Classes CheckUniqueness Explanation GetService HouseAvailableDate RequestState Context MakeFromDbArray UploadPicture exports exports exports exports exports exports Service Service Service Service Service Transporter UploadPicture Namespaces Core Core Core Core HouseBookingRequest HouseBookingRequestMQPersister http-context NotificationMQ NotificationMQPersister × Search results Close "},"namespaces.list.html":{"id":"namespaces.list.html","title":"Namespaces","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Namespaces Classes CheckUniqueness Explanation GetService HouseAvailableDate RequestState Context MakeFromDbArray UploadPicture exports exports exports exports exports exports Service Service Service Service Service Transporter UploadPicture Namespaces Core Core Core Core HouseBookingRequest HouseBookingRequestMQPersister http-context NotificationMQ NotificationMQPersister × Search results Close "},"index.html":{"id":"index.html","title":"Index","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll × Search results Close "},"CheckUniqueness.html":{"id":"CheckUniqueness.html","title":"Class: CheckUniqueness","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Class: CheckUniqueness CheckUniqueness new CheckUniqueness(modelName, argName, keys) Validate uniqueness of model based on keys Parameters: Name Type Description modelName string argName string keys array Source: server/lib/utils/lib/persistency/validations/remote-hooks/before/index.js, line 19 Returns: Type function × Search results Close "},"Explanation.html":{"id":"Explanation.html","title":"Class: Explanation","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Class: Explanation Explanation This class is part of house cancellation policy explaining the policy by sample. new Explanation() Source: server/lib/utils/lib/persistency/models/house-cancellation-policy/explanation.js, line 18 Methods &lt;static&gt; Create(data) Creates array or single object of Explanation type.If data is nothing then null returned. Parameters: Name Type Description data array | object Source: server/lib/utils/lib/persistency/models/house-cancellation-policy/explanation.js, line 42 Returns: Type array | object × Search results Close "},"FileSystem.Core.html":{"id":"FileSystem.Core.html","title":"Namespace: Core","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Namespace: Core Core Check if path exists. If not then creates it. Source: server/lib/utils/lib/file-system/core.js, line 21 Namespace: Core Core Copies file or directory from source to destinationProxies fs-extra module , copy function Source: server/lib/utils/lib/file-system/core.js, line 55 Namespace: Core Core Moves file or directory from source to destinationProxies fs-extra module , move function Source: server/lib/utils/lib/file-system/core.js, line 70 Namespace: Core Core Get size of input file Source: server/lib/utils/lib/file-system/core.js, line 86 × Search results Close "},"GetService.html":{"id":"GetService.html","title":"Class: GetService","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Class: GetService GetService new GetService() Properties: Name Type Description host String Host name port Integer secure Boolean pool Boolean user String Username/Account pass String Password extName String Extension name of layout files layoutsDir String defaultLayout String partialsDir String viewPath String extName String Source: server/lib/messaging/lib/email/index.js, line 39 × Search results Close "},"HouseAvailableDate.html":{"id":"HouseAvailableDate.html","title":"Class: HouseAvailableDate","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Class: HouseAvailableDate HouseAvailableDate Class AvailableDate indicating house available date. new HouseAvailableDate() Source: server/lib/utils/lib/persistency/models/available-date.js, line 15 Methods &lt;static&gt; AddDates(house, inDates, isAdmin, isOwner, cb) Add dates as available dates for house.It adds only non-existing dates in storage. Parameters: Name Type Description house House inDates array isAdmin boolean isOwner boolean cb Callback Source: server/models/house/house-available-date.js, line 64 &lt;static&gt; DeleteDates(house, dates, cb) Remove dates as unavailable dates for house. Parameters: Name Type Description house House dates array cb Callback Source: server/models/house/house-available-date.js, line 116 &lt;static&gt; GetDatesInRange(house, startDate, endDate, cb) Returns dates which are in startDate-endDate range. Parameters: Name Type Description house House startDate Date endDate Date cb Callback Source: server/models/house/house-available-date.js, line 133 × Search results Close "},"HouseBookingRequest.html":{"id":"HouseBookingRequest.html","title":"Namespace: HouseBookingRequest","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Namespace: HouseBookingRequest HouseBookingRequest Booking requests to a house Source: server/models/house/house-booking-request.js, line 17 Classes RequestState Methods &lt;static&gt; Model.AddRequest(houseId, data, req, cb) Add request to a house. When an user books a house this request would be created. Parameters: Name Type Description houseId String House ID data Object Data req HttpRequest data.dates Array Array of date-price id's cb Callback Source: server/models/house/house-booking-request.js, line 37 × Search results Close "},"HouseBookingRequest.RequestState.html":{"id":"HouseBookingRequest.RequestState.html","title":"Class: RequestState","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Class: RequestState HouseBookingRequest. RequestState new RequestState() Handles all lifecycle of a book request.Actually this is a finite state machine. Source: server/models/house/house-booking-request.js, line 805 Methods &lt;static&gt; RequestState#cancel(houseOwner, guest, cb) Cancels a request. Decides based on current state Parameters: Name Type Description houseOwner Account guest Account cb Callback Source: server/models/house/house-booking-request.js, line 1010 &lt;static&gt; RequestState#reject(houseOwner, guest, cb) House owner rejects the request Parameters: Name Type Description houseOwner Account guest Account cb Callback Source: server/models/house/house-booking-request.js, line 1034 × Search results Close "},"HouseBookingRequestMQPersister.html":{"id":"HouseBookingRequestMQPersister.html","title":"Namespace: HouseBookingRequestMQPersister","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Namespace: HouseBookingRequestMQPersister HouseBookingRequestMQPersister This module is responsible for persisting logs of house book request lifecycle Source: server/models/house/house-booking-request-mq-persister.js, line 12 Methods &lt;static&gt; Model.Persist(bookRequest, event, from, to, cb) Quques a job processing changes to states of house book request HouseBookingRequest Parameters: Name Type Description bookRequest HouseBookingRequest event String from String to String cb Callback Source: server/models/house/house-booking-request-mq-persister.js, line 57 × Search results Close "},"http-context.html":{"id":"http-context.html","title":"Namespace: http-context","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Namespace: http-context http-context Source: server/lib/http-context/index.js, line 5 Classes Context Methods &lt;static&gt; perRequestContextFactory(options) Create a context and assign to current http request Parameters: Name Type Description options Properties: Name Type Description options.name Name of context which is be accessible through the http request Source: server/lib/http-context/middleware/per-request.js, line 17 Returns: Middleware Type function × Search results Close "},"http-context.Context.html":{"id":"http-context.Context.html","title":"Class: Context","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Class: Context http-context. Context new Context() Source: server/lib/http-context/context.js, line 6 × Search results Close "},"Image.MakeFromDbArray.html":{"id":"Image.MakeFromDbArray.html","title":"Class: MakeFromDbArray","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Class: MakeFromDbArray MakeFromDbArray new MakeFromDbArray(files) Converts db images to api images Parameters: Name Type Description files Source: common/models/image.js, line 51 × Search results Close "},"ImageContainerBase.UploadPicture.html":{"id":"ImageContainerBase.UploadPicture.html","title":"Class: UploadPicture","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Class: UploadPicture UploadPicture new UploadPicture(httpCtx, options, config) Upload one picture attached to http request body Parameters: Name Type Description httpCtx HttpContext options Object config Config Source: server/models/image-container-base.js, line 65 Returns: Type Promise × Search results Close "},"module.html#.exports":{"id":"module.html#.exports","title":"Class: exports","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Class: exports exports new exports(HouseImageContainer) This model (HouseImageContainer) is responsible for managing images of HouseAll remote methods should be served through House Parameters: Name Type Description HouseImageContainer Model Source: server/models/geo/house-image-container.js, line 17 Members &lt;inner&gt; normalizedPath Loads all boot scripts in roles folder. Source: server/boot/role-resolver.js, line 11 &lt;inner&gt; normalizedPath Loads all boot scripts in entities folder. Source: server/boot/entitiy-loader.js, line 11 Class: exports exports new exports(UserProfileImageContainer) This model (UserProfileImageContainer) is responsible for managing files of UserProfileAll remote methods should be served through UserProfile Parameters: Name Type Description UserProfileImageContainer object Source: server/models/user-profile-image-container.js, line 18 Members &lt;inner&gt; normalizedPath Loads all boot scripts in roles folder. Source: server/boot/role-resolver.js, line 11 &lt;inner&gt; normalizedPath Loads all boot scripts in entities folder. Source: server/boot/entitiy-loader.js, line 11 Class: exports exports new exports() Source: server/models/account.js, line 23 Members &lt;inner&gt; normalizedPath Loads all boot scripts in roles folder. Source: server/boot/role-resolver.js, line 11 &lt;inner&gt; normalizedPath Loads all boot scripts in entities folder. Source: server/boot/entitiy-loader.js, line 11 Class: exports exports new exports(CityImageContainer) This model (CityImageContainer) is responsible for managing images of CityAll remote methods should be served through City Parameters: Name Type Description CityImageContainer CityImageContainer Source: server/models/geo/city-image-container.js, line 18 Members &lt;inner&gt; normalizedPath Loads all boot scripts in roles folder. Source: server/boot/role-resolver.js, line 11 &lt;inner&gt; normalizedPath Loads all boot scripts in entities folder. Source: server/boot/entitiy-loader.js, line 11 Class: exports exports new exports(AttractionImageContainer) This model (AttractionImageContainer) is responsible for managing images of AttractionAll remote methods should be served through Attraction Parameters: Name Type Description AttractionImageContainer AttractionImageContainer Source: server/models/geo/attraction-image-container.js, line 18 Members &lt;inner&gt; normalizedPath Loads all boot scripts in roles folder. Source: server/boot/role-resolver.js, line 11 &lt;inner&gt; normalizedPath Loads all boot scripts in entities folder. Source: server/boot/entitiy-loader.js, line 11 Class: exports exports new exports(ImageContainerBase) This model (ImageContainerBase) is responsible for managing images of HouseAll remote methods should be served through House Parameters: Name Type Description ImageContainerBase Model Source: server/models/image-container-base.js, line 24 Members &lt;inner&gt; normalizedPath Loads all boot scripts in roles folder. Source: server/boot/role-resolver.js, line 11 &lt;inner&gt; normalizedPath Loads all boot scripts in entities folder. Source: server/boot/entitiy-loader.js, line 11 × Search results Close "},"module-House.html":{"id":"module-House.html","title":"Module: House","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Module: House Source: server/models/geo/house.js, line 18 × Search results Close "},"NotificationMQ.html":{"id":"NotificationMQ.html","title":"Namespace: NotificationMQ","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Namespace: NotificationMQ NotificationMQ This is responsible for job queueing and processing them Source: server/models/communication/notification-mq.js, line 21 Methods &lt;static&gt; Model.AddEmailJob(options, cb) Add sending email job to queue Parameters: Name Type Description options Object Properties Name Type Description notificationType String from String Email from to String Email to type String Email type like &quot;account_registration&quot; locals Object Values to be injected to email template accountId String cb Callback Source: server/models/communication/notification-mq.js, line 177 &lt;static&gt; Model.AddSMSJob(options, cb) Add sending sms job to queue Parameters: Name Type Description options Object Properties Name Type Description notificationType String to String Phone number to type String SMS type like &quot;account_registration&quot; locals Object Values to be injected to sms template accountId String cb Callback Source: server/models/communication/notification-mq.js, line 196 × Search results Close "},"NotificationMQPersister.html":{"id":"NotificationMQPersister.html","title":"Namespace: NotificationMQPersister","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Namespace: NotificationMQPersister NotificationMQPersister This module is responsible for persisting notification jobs.Actually logs job lifecycle of sending a notification Source: server/models/communication/notification-mq-persister.js, line 15 Methods &lt;static&gt; Model.PersistJobCompleted(job, result, queueName, cb) Queues a job to persist a completed notification job Parameters: Name Type Description job Object result Object Result of sending notification from underlying service. For example email service sends an email and send back the result queueName String cb Callback Source: server/models/communication/notification-mq-persister.js, line 150 &lt;static&gt; Model.PersistJobError(error, queueName, cb) Queues a job to persist an error while processing notification processing. This is different to failure Parameters: Name Type Description error Object queueName String cb Callback Source: server/models/communication/notification-mq-persister.js, line 177 &lt;static&gt; Model.PersistJobFailure(job, error, queueName, cb) Queues a job to persist a failure encountering processing a notification job. Note that this is after multiple attempting notification job Parameters: Name Type Description job Object error Object queueName String cb Callback Source: server/models/communication/notification-mq-persister.js, line 164 &lt;static&gt; Model.PersistNewJob(job, type, subType, queueName, cb) Queues a job to persist a new notification job Parameters: Name Type Description job Object type String Type of notification eg EMAIL subType String Sub type of notification eg Account_Registration queueName String Queue name cb Callback Source: server/models/communication/notification-mq-persister.js, line 136 × Search results Close "},"Service.html":{"id":"Service.html","title":"Class: Service","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Class: Service Service new Service(options) Parameters: Name Type Description options Object Settings Source: server/lib/messaging/lib/sms/kavenegar/service.js, line 30 Methods push(destTokens, message, options, cb) Send push notification to destination devices Parameters: Name Type Description destTokens Array | String Destination device token(s) message string options Object Specific destination system settings cb function Source: server/lib/messaging/lib/push/service.js, line 32 push(destTokens, message, options, cb) Send push notification to destination devices Parameters: Name Type Description destTokens Array | String Destination device token(s) message string options Object Specific destination system settings cb function Containing promise Properties: Name Type Description title String ttl Integer In seconds. Default : 3600 badge Integer Badge number sound String Source: server/lib/messaging/lib/push/apn/index.js, line 47 push(destTokens, message, options, cb) Send push notification to destination devices Parameters: Name Type Description destTokens Array | String Destination device token(s) message string options Object Specific destination system settings cb function Containing promise Properties: Name Type Description title String ttl Integer In seconds. Default : 3600 extra Object Extra key value Source: server/lib/messaging/lib/push/gcm/index.js, line 42 &lt;abstract&gt; sendOne(sender, receiver, message, options, cb) Send sms to one receiver Parameters: Name Type Description sender String receiver String message String options Object vendor specific options cb function Source: server/lib/messaging/lib/sms/service.js, line 37 Class: Service Service It's a proxy new Service(service, type) Parameters: Name Type Description service Object type String Vendor type Source: server/lib/messaging/lib/sms/service.js, line 15 Methods push(destTokens, message, options, cb) Send push notification to destination devices Parameters: Name Type Description destTokens Array | String Destination device token(s) message string options Object Specific destination system settings cb function Source: server/lib/messaging/lib/push/service.js, line 32 push(destTokens, message, options, cb) Send push notification to destination devices Parameters: Name Type Description destTokens Array | String Destination device token(s) message string options Object Specific destination system settings cb function Containing promise Properties: Name Type Description title String ttl Integer In seconds. Default : 3600 badge Integer Badge number sound String Source: server/lib/messaging/lib/push/apn/index.js, line 47 push(destTokens, message, options, cb) Send push notification to destination devices Parameters: Name Type Description destTokens Array | String Destination device token(s) message string options Object Specific destination system settings cb function Containing promise Properties: Name Type Description title String ttl Integer In seconds. Default : 3600 extra Object Extra key value Source: server/lib/messaging/lib/push/gcm/index.js, line 42 &lt;abstract&gt; sendOne(sender, receiver, message, options, cb) Send sms to one receiver Parameters: Name Type Description sender String receiver String message String options Object vendor specific options cb function Source: server/lib/messaging/lib/sms/service.js, line 37 Class: Service Service new Service(options) Parameters: Name Type Description options Object Properties: Name Type Description Required String cert Absolute path to cert file Required String key Absolute path to key file Source: server/lib/messaging/lib/push/apn/index.js, line 23 Methods push(destTokens, message, options, cb) Send push notification to destination devices Parameters: Name Type Description destTokens Array | String Destination device token(s) message string options Object Specific destination system settings cb function Source: server/lib/messaging/lib/push/service.js, line 32 push(destTokens, message, options, cb) Send push notification to destination devices Parameters: Name Type Description destTokens Array | String Destination device token(s) message string options Object Specific destination system settings cb function Containing promise Properties: Name Type Description title String ttl Integer In seconds. Default : 3600 badge Integer Badge number sound String Source: server/lib/messaging/lib/push/apn/index.js, line 47 push(destTokens, message, options, cb) Send push notification to destination devices Parameters: Name Type Description destTokens Array | String Destination device token(s) message string options Object Specific destination system settings cb function Containing promise Properties: Name Type Description title String ttl Integer In seconds. Default : 3600 extra Object Extra key value Source: server/lib/messaging/lib/push/gcm/index.js, line 42 &lt;abstract&gt; sendOne(sender, receiver, message, options, cb) Send sms to one receiver Parameters: Name Type Description sender String receiver String message String options Object vendor specific options cb function Source: server/lib/messaging/lib/sms/service.js, line 37 Class: Service Service new Service(options) Parameters: Name Type Description options Object Properties: Name Type Description Required String apiKey Google GCM API key Source: server/lib/messaging/lib/push/gcm/index.js, line 21 Methods push(destTokens, message, options, cb) Send push notification to destination devices Parameters: Name Type Description destTokens Array | String Destination device token(s) message string options Object Specific destination system settings cb function Source: server/lib/messaging/lib/push/service.js, line 32 push(destTokens, message, options, cb) Send push notification to destination devices Parameters: Name Type Description destTokens Array | String Destination device token(s) message string options Object Specific destination system settings cb function Containing promise Properties: Name Type Description title String ttl Integer In seconds. Default : 3600 badge Integer Badge number sound String Source: server/lib/messaging/lib/push/apn/index.js, line 47 push(destTokens, message, options, cb) Send push notification to destination devices Parameters: Name Type Description destTokens Array | String Destination device token(s) message string options Object Specific destination system settings cb function Containing promise Properties: Name Type Description title String ttl Integer In seconds. Default : 3600 extra Object Extra key value Source: server/lib/messaging/lib/push/gcm/index.js, line 42 &lt;abstract&gt; sendOne(sender, receiver, message, options, cb) Send sms to one receiver Parameters: Name Type Description sender String receiver String message String options Object vendor specific options cb function Source: server/lib/messaging/lib/sms/service.js, line 37 Class: Service Service new Service(service, type) Parameters: Name Type Description service Object type String Push notification system type gsm|apn Source: server/lib/messaging/lib/push/service.js, line 18 Methods push(destTokens, message, options, cb) Send push notification to destination devices Parameters: Name Type Description destTokens Array | String Destination device token(s) message string options Object Specific destination system settings cb function Source: server/lib/messaging/lib/push/service.js, line 32 push(destTokens, message, options, cb) Send push notification to destination devices Parameters: Name Type Description destTokens Array | String Destination device token(s) message string options Object Specific destination system settings cb function Containing promise Properties: Name Type Description title String ttl Integer In seconds. Default : 3600 badge Integer Badge number sound String Source: server/lib/messaging/lib/push/apn/index.js, line 47 push(destTokens, message, options, cb) Send push notification to destination devices Parameters: Name Type Description destTokens Array | String Destination device token(s) message string options Object Specific destination system settings cb function Containing promise Properties: Name Type Description title String ttl Integer In seconds. Default : 3600 extra Object Extra key value Source: server/lib/messaging/lib/push/gcm/index.js, line 42 &lt;abstract&gt; sendOne(sender, receiver, message, options, cb) Send sms to one receiver Parameters: Name Type Description sender String receiver String message String options Object vendor specific options cb function Source: server/lib/messaging/lib/sms/service.js, line 37 × Search results Close "},"Transporter.html":{"id":"Transporter.html","title":"Class: Transporter","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Class: Transporter Transporter new Transporter() Properties: Name Type Description host String Host name port Integer secure Boolean pool Boolean user String Username/Account pass String Password extName String Extension name of layout files layoutsDir String defaultLayout String partialsDir String viewPath String extName String Source: server/lib/messaging/lib/email/transporter.js, line 44 Methods sendOne(from, to, subject, template, context, options, cb) Send email to one receiver Parameters: Name Type Description from String to String subject String template String context Object Used to compile template in handlebars options Object Extra options for sending email cb function Source: server/lib/messaging/lib/email/transporter.js, line 67 × Search results Close "},"UserProfileImageContainer.UploadPicture.html":{"id":"UserProfileImageContainer.UploadPicture.html","title":"Class: UploadPicture","body":" DocStrap Namespaces FileSystem.CoreHouseBookingRequestHouseBookingRequestMQPersisterhttp-contextNotificationMQNotificationMQPersister Modules House Classes CheckUniquenessExplanationGetServiceHouseAvailableDateHouseBookingRequest.RequestStatehttp-context.ContextImage.MakeFromDbArrayImageContainerBase.UploadPicturemodule.exportsServiceTransporterUserProfileImageContainer.UploadPicture Global accountCreateHandleraddHooksaddMethodsaddServicesafterPaginatedServiceappargShouldNotEmptyargumentWrapperarraySuccessHandlercheckCurrentUserAuthorizedconvert2DtocorrectCaseOfKeyscorrectRequestDatacreateOrUpdatecreateOrUpdateAttractioncreateOrUpdateCitycreateOrUpdateHouseFeaturecreateOrUpdateHouseTypecreateProfilecreateProfileHandlerCreateServicedataCorrectordataOwnerCorrectordataOwnerCorrectorInArgdataShouldNotEmptyDateRangedefineAdminServicesdefineAdminStuffdefineGeneralServicesdefineHooksdefineMethodsdefineRemoteMethodsdefineServicesdoStructureResultForMultipledownloadextractFileSizesfailureHandlergetModelKeyMapinjectLangToRequestDataisUserAdminjsonerNormalizerefinePaginationParamssuccessHandlerupdateProfileupdateProfileHandleruploaduploadAll Class: UploadPicture UploadPicture new UploadPicture(user, httpCtx, options) Uploads a file with specific attributes like filename and destination path and remote field name Parameters: Name Type Description user Account httpCtx HttpContext options object Source: server/models/user-profile-image-container.js, line 62 Returns: Type Promise × Search results Close "}}
    </script>

    <script type="text/javascript">
        $(document).ready(function() {
            Searcher.init();
        });

        $(window).on("message", function(msg) {
            var msgData = msg.originalEvent.data;

            if (msgData.msgid != "docstrap.quicksearch.start") {
                return;
            }

            var results = Searcher.search(msgData.searchTerms);

            window.parent.postMessage({"results": results, "msgid": "docstrap.quicksearch.done"}, "*");
        });
    </script>
</body>
</html>
